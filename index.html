<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Bbfs</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.8.0/application.js' type='text/javascript'></script>    
    <link href='./assets/0.8.0/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.8.0/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.8.0/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.8.0/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2014-01-24T18:39:41+00:00">2014-01-24T18:39:41+00:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">57.59%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         22.29
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>24</b> files in total.
    <b>2450</b> relevant lines. 
    <span class="green"><b>1411</b> lines covered</span> and
    <span class="red"><b>1039</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#4987f5cedb6914de07bb5679b384277e5a095bf3" class="src_link" title="lib/content_data/content_data.rb">lib/content_data/content_data.rb</a></td>
        <td class="yellow strong">88.1 %</td>
        <td>756</td>
        <td>395</td>
        <td>348</td>
        <td>47</td>
        <td>14.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9ff0fbe180f3ef882d6d09890fe76b31ae496751" class="src_link" title="lib/content_server/backup_server.rb">lib/content_server/backup_server.rb</a></td>
        <td class="red strong">26.74 %</td>
        <td>147</td>
        <td>86</td>
        <td>23</td>
        <td>63</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5eab87ad200a83213901faddb0cedfef946eacd4" class="src_link" title="lib/content_server/content_receiver.rb">lib/content_server/content_receiver.rb</a></td>
        <td class="red strong">29.73 %</td>
        <td>57</td>
        <td>37</td>
        <td>11</td>
        <td>26</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#aa211c201d4dfb6be85ed1fe1498803f5b21ec3c" class="src_link" title="lib/content_server/file_streamer.rb">lib/content_server/file_streamer.rb</a></td>
        <td class="red strong">74.72 %</td>
        <td>306</td>
        <td>178</td>
        <td>133</td>
        <td>45</td>
        <td>2.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#782254a2b5b19787342e9321f33e0192e41b18ae" class="src_link" title="lib/content_server/queue_copy.rb">lib/content_server/queue_copy.rb</a></td>
        <td class="red strong">20.1 %</td>
        <td>327</td>
        <td>199</td>
        <td>40</td>
        <td>159</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#11e9a41f8c8db74494ca580da49fc207dedad59d" class="src_link" title="lib/content_server/remote_content.rb">lib/content_server/remote_content.rb</a></td>
        <td class="red strong">28.85 %</td>
        <td>113</td>
        <td>52</td>
        <td>15</td>
        <td>37</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8d8a2f2e5484439ac497281b7e76c887ec86bea6" class="src_link" title="lib/content_server/server.rb">lib/content_server/server.rb</a></td>
        <td class="red strong">38.24 %</td>
        <td>112</td>
        <td>68</td>
        <td>26</td>
        <td>42</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f408515e43349f3a03f64ece480920a79d7aa067" class="src_link" title="lib/file_copy/copy.rb">lib/file_copy/copy.rb</a></td>
        <td class="yellow strong">85.37 %</td>
        <td>69</td>
        <td>41</td>
        <td>35</td>
        <td>6</td>
        <td>1.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#68fa5c4c26d64d3dd140b81bd189f025b1b3fee2" class="src_link" title="lib/file_indexing/index_agent.rb">lib/file_indexing/index_agent.rb</a></td>
        <td class="red strong">78.16 %</td>
        <td>170</td>
        <td>87</td>
        <td>68</td>
        <td>19</td>
        <td>11.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5924e92c65a0fd131acb5c93dbd7f68f43241d6" class="src_link" title="lib/file_indexing/indexer_patterns.rb">lib/file_indexing/indexer_patterns.rb</a></td>
        <td class="red strong">43.59 %</td>
        <td>72</td>
        <td>39</td>
        <td>17</td>
        <td>22</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5554544efb6fffeb1e907cbe2ed0c1939435399" class="src_link" title="lib/file_monitoring.rb">lib/file_monitoring.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>31</td>
        <td>8</td>
        <td>6</td>
        <td>2</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#36a1c9e2a4ff80e1f98ce0bca68a5960f313b010" class="src_link" title="lib/file_monitoring/file_monitoring.rb">lib/file_monitoring/file_monitoring.rb</a></td>
        <td class="red strong">9.57 %</td>
        <td>201</td>
        <td>94</td>
        <td>9</td>
        <td>85</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3cbeda98f0c5c434adfde60606d3e13831006906" class="src_link" title="lib/file_monitoring/monitor_path.rb">lib/file_monitoring/monitor_path.rb</a></td>
        <td class="red strong">37.95 %</td>
        <td>439</td>
        <td>195</td>
        <td>74</td>
        <td>121</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec8ca6f408fe919eb543519dfc2cc334aba3847d" class="src_link" title="lib/file_utils/file_generator/file_generator.rb">lib/file_utils/file_generator/file_generator.rb</a></td>
        <td class="yellow strong">89.33 %</td>
        <td>156</td>
        <td>75</td>
        <td>67</td>
        <td>8</td>
        <td>4.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b731d5059dbc28455931ed65efa31468652d2efc" class="src_link" title="lib/file_utils/file_utils.rb">lib/file_utils/file_utils.rb</a></td>
        <td class="red strong">34.55 %</td>
        <td>260</td>
        <td>165</td>
        <td>57</td>
        <td>108</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b091471b5758ed5694d3f9c544a30c0265eebe2" class="src_link" title="lib/log.rb">lib/log.rb</a></td>
        <td class="red strong">63.64 %</td>
        <td>218</td>
        <td>88</td>
        <td>56</td>
        <td>32</td>
        <td>43.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#344d8500f352c2b33b0973cb9cf0eeeba4ad6ebf" class="src_link" title="lib/networking/tcp.rb">lib/networking/tcp.rb</a></td>
        <td class="yellow strong">83.58 %</td>
        <td>213</td>
        <td>134</td>
        <td>112</td>
        <td>22</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c0ecdfce7fcf3b5fe59d1ac26d62f445a86d91f2" class="src_link" title="lib/params.rb">lib/params.rb</a></td>
        <td class="yellow strong">88.61 %</td>
        <td>413</td>
        <td>158</td>
        <td>140</td>
        <td>18</td>
        <td>266.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6efd0b644bdce5b7c3e565a97e9df5dfb88cdd37" class="src_link" title="lib/process_monitoring/monitoring.rb">lib/process_monitoring/monitoring.rb</a></td>
        <td class="green strong">92.31 %</td>
        <td>85</td>
        <td>13</td>
        <td>12</td>
        <td>1</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#28d76f22135193ef2af40f197841ecad0228d0f9" class="src_link" title="lib/process_monitoring/monitoring_info.rb">lib/process_monitoring/monitoring_info.rb</a></td>
        <td class="red strong">37.21 %</td>
        <td>79</td>
        <td>43</td>
        <td>16</td>
        <td>27</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#793c95b8908b3d4e73dd594506531141df245651" class="src_link" title="lib/process_monitoring/send_email.rb">lib/process_monitoring/send_email.rb</a></td>
        <td class="red strong">28.57 %</td>
        <td>40</td>
        <td>21</td>
        <td>6</td>
        <td>15</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#89e04980687f4953fcec5b9ccb80d350033d0570" class="src_link" title="lib/process_monitoring/thread_safe_hash.rb">lib/process_monitoring/thread_safe_hash.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>77</td>
        <td>40</td>
        <td>20</td>
        <td>20</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a3923e217b40f796c5592a4e0461b76ba6f1a85f" class="src_link" title="lib/run_in_background.rb">lib/run_in_background.rb</a></td>
        <td class="red strong">42.13 %</td>
        <td>432</td>
        <td>197</td>
        <td>83</td>
        <td>114</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f1282790afb046fc8bf468fbbf7787daff4d387a" class="src_link" title="lib/validations/index_validations.rb">lib/validations/index_validations.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>106</td>
        <td>37</td>
        <td>37</td>
        <td>0</td>
        <td>3.2</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.8.2 
        and simplecov-html v0.8.0<br/>
        using validations
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="4987f5cedb6914de07bb5679b384277e5a095bf3">
  <div class="header">
    <h3>lib/content_data/content_data.rb</h3>
    <h4><span class="yellow">88.1 %</span> covered</h4>
    <div>
      <b>395</b> relevant lines. 
      <span class="green"><b>348</b> lines covered</span> and
      <span class="red"><b>47</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/server'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module ContentData</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('instance_check_level', 'shallow', 'Defines check level. Supported levels are: ' \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">                'shallow - quick, tests instance for file existence and attributes. ' \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">                'deep - can take more time, in addition to shallow recalculates hash sum.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Content Data(CD) object holds files information as contents and instances</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # Files info retrieved from hardware: checksum, size, time modification, server, device and path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Those attributes are divided into content and instance attributes:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #   unique checksum, size are content attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  #   time modification, server, device and path are instance attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # The relationship between content and instances is 1:many meaning that</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # a content can have instances in many servers.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # content also has time attribute, which has the value of the time of the first instance.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # This can be changed by using unify_time method  which sets all time attributes for a content and it's</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  # instances to the min time off all.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # Different files(instances) with same content(checksum), are grouped together under that content.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # Interface methods include:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  #   iterate over contents and instances info,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  #   unify time, add/remove instance, queries, merge, remove directory and more.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # Content info data structure:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  #   @contents_info = { Checksum -&gt; [size, *instances*, content_modification_time] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  #     *instances* = {[server,path] -&gt; [instance_modification_time,index_time] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # Notes:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  #   1. content_modification_time is the instance_modification_time of the first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  #      instances which was added to @contents_info</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  class ContentData</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    CHUNK_SIZE = 5000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(other = nil)</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="35">
          <span class="hits">69</span>
          
          <code class="ruby">      if other.nil?</code>
        </li>
      
        <li class="covered" data-hits="53" data-linenumber="36">
          <span class="hits">53</span>
          
          <code class="ruby">        @contents_info = {}  # Checksum --&gt; [size, paths--&gt;time(instance), time(content)]</code>
        </li>
      
        <li class="covered" data-hits="53" data-linenumber="37">
          <span class="hits">53</span>
          
          <code class="ruby">        @instances_info = {}  # location --&gt; checksum to optimize instances query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="39">
          <span class="hits">16</span>
          
          <code class="ruby">        @contents_info = other.clone_contents_info</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="40">
          <span class="hits">16</span>
          
          <code class="ruby">        @instances_info = other.clone_instances_info  # location --&gt; checksum to optimize instances query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    # Content Data unique identification</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    # @return [ID] hash identification</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    def unique_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      @instances_info.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    def clone_instances_info</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="51">
          <span class="hits">16</span>
          
          <code class="ruby">      clone_instances_info = {}</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="52">
          <span class="hits">16</span>
          
          <code class="ruby">      instances_info_enum = @instances_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="53">
          <span class="hits">16</span>
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="54">
          <span class="hits">62</span>
          
          <code class="ruby">        location = instances_info_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="55">
          <span class="hits">46</span>
          
          <code class="ruby">        clone_instances_info[[location[0].clone, location[1].clone]] = @instances_info[location].clone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="57">
          <span class="hits">16</span>
          
          <code class="ruby">      clone_instances_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    def clone_contents_info</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="61">
          <span class="hits">16</span>
          
          <code class="ruby">      clone_contents_info = {}</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="62">
          <span class="hits">16</span>
          
          <code class="ruby">      contents_info_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="63">
          <span class="hits">16</span>
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="64">
          <span class="hits">45</span>
          
          <code class="ruby">        checksum = contents_info_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="65">
          <span class="hits">29</span>
          
          <code class="ruby">        instances = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="66">
          <span class="hits">29</span>
          
          <code class="ruby">        size = instances[0]</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="67">
          <span class="hits">29</span>
          
          <code class="ruby">        content_time = instances[2]</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="68">
          <span class="hits">29</span>
          
          <code class="ruby">        instances_db = instances[1]</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="69">
          <span class="hits">29</span>
          
          <code class="ruby">        instances_db_cloned = {}</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="70">
          <span class="hits">29</span>
          
          <code class="ruby">        instances_db_enum = instances_db.each_key</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="71">
          <span class="hits">29</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="72">
          <span class="hits">75</span>
          
          <code class="ruby">          location =  instances_db_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="73">
          <span class="hits">46</span>
          
          <code class="ruby">          inst_mod_times = instances_db[location]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">          # we use deep clone for location since map key is using shallow clone.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          # we dont want references between new content data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          # and orig object. This will help the GC dispose the orig object if not used any more.</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="77">
          <span class="hits">46</span>
          
          <code class="ruby">          instances_db_cloned[[location[0].clone,location[1].clone]] = inst_mod_times.clone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="79">
          <span class="hits">29</span>
          
          <code class="ruby">        clone_contents_info[checksum] = [size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">                              instances_db_cloned,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">                              content_time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="83">
          <span class="hits">16</span>
          
          <code class="ruby">      clone_contents_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    # iterator over @contents_info data structure (not including instances)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    # block is provided with: checksum, size and content modification time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    def each_content(&amp;block)</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="89">
          <span class="hits">38</span>
          
          <code class="ruby">      contents_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="90">
          <span class="hits">38</span>
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="91">
          <span class="hits">102</span>
          
          <code class="ruby">        checksum = contents_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="92">
          <span class="hits">64</span>
          
          <code class="ruby">        content_val = @contents_info[checksum]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        # provide checksum, size and content modification time to the block</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="94">
          <span class="hits">64</span>
          
          <code class="ruby">        block.call(checksum,content_val[0], content_val[2])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    # iterator over @contents_info data structure (including instances)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    # block is provided with: checksum, size, content modification time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    #   instance modification time, server and file path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    def each_instance(&amp;block)</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="102">
          <span class="hits">82</span>
          
          <code class="ruby">      contents_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="103">
          <span class="hits">82</span>
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="covered" data-hits="196" data-linenumber="104">
          <span class="hits">196</span>
          
          <code class="ruby">        checksum = contents_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="105">
          <span class="hits">126</span>
          
          <code class="ruby">        content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="106">
          <span class="hits">126</span>
          
          <code class="ruby">        content_info_enum = content_info[1].each_key</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="107">
          <span class="hits">126</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="332" data-linenumber="108">
          <span class="hits">332</span>
          
          <code class="ruby">          location = content_info_enum.next rescue break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          # provide the block with: checksum, size, content modification time,instance modification time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          #   server and path.</code>
        </li>
      
        <li class="covered" data-hits="218" data-linenumber="111">
          <span class="hits">218</span>
          
          <code class="ruby">          inst_mod_time, inst_index_time = content_info[1][location]</code>
        </li>
      
        <li class="covered" data-hits="218" data-linenumber="112">
          <span class="hits">218</span>
          
          <code class="ruby">          block.call(checksum,content_info[0], content_info[2], inst_mod_time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">                     location[0], location[1], inst_index_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    # iterator of instances over specific content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    # block is provided with: checksum, size, content modification time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    #   instance modification time, server and file path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    def content_each_instance(checksum, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      instances_db_enum = content_info[1].each_key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        location = instances_db_enum.next rescue break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        # provide the block with: checksum, size, content modification time,instance modification time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        #   server and path.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">        inst_mod_time,_ = content_info[1][location]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        block.call(checksum,content_info[0], content_info[2], inst_mod_time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">                   location[0], location[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    def contents_size()</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="135">
          <span class="hits">10</span>
          
          <code class="ruby">      @contents_info.length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">    def instances_size()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      @instances_info.length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    def checksum_instances_size(checksum)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="143">
          <span class="hits">22</span>
          
          <code class="ruby">      content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="144">
          <span class="hits">22</span>
          
          <code class="ruby">      return 0 if content_info.nil?</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="145">
          <span class="hits">22</span>
          
          <code class="ruby">      content_info[1].length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_instance_mod_time(checksum, location)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="149">
          <span class="hits">10</span>
          
          <code class="ruby">      content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="150">
          <span class="hits">10</span>
          
          <code class="ruby">      return nil if content_info.nil?</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="151">
          <span class="hits">10</span>
          
          <code class="ruby">      instances = content_info[1]</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="152">
          <span class="hits">10</span>
          
          <code class="ruby">      instance_time,_ = instances[location]</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="153">
          <span class="hits">10</span>
          
          <code class="ruby">      instance_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_instance(checksum, size, server, path, modification_time, index_time=Time.now.to_i)</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="157">
          <span class="hits">143</span>
          
          <code class="ruby">      location = [server, path]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      # file was changed but remove_instance was not called</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="160">
          <span class="hits">143</span>
          
          <code class="ruby">      if (@instances_info.include?(location) &amp;&amp; @instances_info[location] != checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">        Log.warning(&quot;#{server}:#{path} file already exists with different checksum&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">        remove_instance(server, path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="165">
          <span class="hits">143</span>
          
          <code class="ruby">      content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="166">
          <span class="hits">143</span>
          
          <code class="ruby">      if content_info.nil?</code>
        </li>
      
        <li class="covered" data-hits="99" data-linenumber="167">
          <span class="hits">99</span>
          
          <code class="ruby">        @contents_info[checksum] = [size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">                                    {location =&gt; [modification_time,index_time]},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">                                    modification_time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="171">
          <span class="hits">44</span>
          
          <code class="ruby">        if size != content_info[0]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.warning('File size different from content size while same checksum')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.warning(&quot;instance location:server:'#{location[0]}'  path:'#{location[1]}'&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.warning(&quot;instance mod time:'#{modification_time}'&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        #override file if needed</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="177">
          <span class="hits">44</span>
          
          <code class="ruby">        content_info[0] = size</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="178">
          <span class="hits">44</span>
          
          <code class="ruby">        instances = content_info[1]</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="179">
          <span class="hits">44</span>
          
          <code class="ruby">        instances[location] = [modification_time, index_time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="181">
          <span class="hits">143</span>
          
          <code class="ruby">      @instances_info[location] = checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">    def empty?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="185">
          <span class="hits">3</span>
          
          <code class="ruby">      @contents_info.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">    def content_exists(checksum)</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="189">
          <span class="hits">40</span>
          
          <code class="ruby">      @contents_info.has_key?(checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">    def instance_exists(path, server)</code>
        </li>
      
        <li class="covered" data-hits="93" data-linenumber="193">
          <span class="hits">93</span>
          
          <code class="ruby">      @instances_info.has_key?([server, path])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    # removes an instance record both in @instances_info and @instances_info.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    # input params: server &amp; path - are the instance unique key (called location)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    # removes also the content, if content becomes empty after removing the instance</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">    def remove_instance(server, path)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="200">
          <span class="hits">16</span>
          
          <code class="ruby">      location = [server, path]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="201">
          <span class="hits">16</span>
          
          <code class="ruby">      checksum = @instances_info[location]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="202">
          <span class="hits">16</span>
          
          <code class="ruby">      content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="203">
          <span class="hits">16</span>
          
          <code class="ruby">      return nil if content_info.nil?</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="204">
          <span class="hits">16</span>
          
          <code class="ruby">      instances = content_info[1]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="205">
          <span class="hits">16</span>
          
          <code class="ruby">      instances.delete(location)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="206">
          <span class="hits">16</span>
          
          <code class="ruby">      @contents_info.delete(checksum) if instances.empty?</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="207">
          <span class="hits">16</span>
          
          <code class="ruby">      @instances_info.delete(location)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">    # removes all instances records which are located under input param: dir_to_remove.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    # found records are removed from both @instances_info and @instances_info.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    # input params: server &amp; dir_to_remove - are used to check each instance unique key (called location)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    # removes also content\s, if a content\s become\s empty after removing instance\s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">    def remove_directory(dir_to_remove, server)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="215">
          <span class="hits">2</span>
          
          <code class="ruby">      contents_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="216">
          <span class="hits">2</span>
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="217">
          <span class="hits">4</span>
          
          <code class="ruby">        checksum = contents_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="218">
          <span class="hits">2</span>
          
          <code class="ruby">        instances =  @contents_info[checksum][1]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="219">
          <span class="hits">2</span>
          
          <code class="ruby">        instances.each_key { |location|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="220">
          <span class="hits">4</span>
          
          <code class="ruby">          if location[0] == server and location[1].scan(dir_to_remove).size &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="221">
          <span class="hits">3</span>
          
          <code class="ruby">            instances.delete(location)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="222">
          <span class="hits">3</span>
          
          <code class="ruby">            @instances_info.delete(location)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="225">
          <span class="hits">2</span>
          
          <code class="ruby">        @contents_info.delete(checksum) if instances.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">    def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="231">
          <span class="hits">8</span>
          
          <code class="ruby">      return false if other.nil?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="232">
          <span class="hits">7</span>
          
          <code class="ruby">      return false if @contents_info.length != other.contents_size</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="233">
          <span class="hits">6</span>
          
          <code class="ruby">      other.each_instance { |checksum, size, content_mod_time, instance_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="234">
          <span class="hits">18</span>
          
          <code class="ruby">        return false if instance_exists(path, server) != other.instance_exists(path, server)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="235">
          <span class="hits">18</span>
          
          <code class="ruby">        local_content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="236">
          <span class="hits">18</span>
          
          <code class="ruby">        return false if local_content_info.nil?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="237">
          <span class="hits">18</span>
          
          <code class="ruby">        return false if local_content_info[0] != size</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="238">
          <span class="hits">18</span>
          
          <code class="ruby">        return false if local_content_info[2] != content_mod_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">        #check instances</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="240">
          <span class="hits">18</span>
          
          <code class="ruby">        local_instances =  local_content_info[1]</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="241">
          <span class="hits">18</span>
          
          <code class="ruby">        return false if other.checksum_instances_size(checksum) != local_instances.length</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="242">
          <span class="hits">17</span>
          
          <code class="ruby">        location = [server, path]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="243">
          <span class="hits">17</span>
          
          <code class="ruby">        local_instance_mod_time, _ = local_instances[location]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="244">
          <span class="hits">17</span>
          
          <code class="ruby">        return false if local_instance_mod_time.nil?</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="245">
          <span class="hits">17</span>
          
          <code class="ruby">        return false if local_instance_mod_time != instance_mod_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="247">
          <span class="hits">5</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">    def remove_content(checksum)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="251">
          <span class="hits">4</span>
          
          <code class="ruby">      content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="252">
          <span class="hits">4</span>
          
          <code class="ruby">      if content_info</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="253">
          <span class="hits">3</span>
          
          <code class="ruby">        content_info[1].each_key { |location|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="254">
          <span class="hits">5</span>
          
          <code class="ruby">          @instances_info.delete(location)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="256">
          <span class="hits">3</span>
          
          <code class="ruby">        @contents_info.delete(checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="261">
          <span class="hits">26</span>
          
          <code class="ruby">      return_str = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="262">
          <span class="hits">26</span>
          
          <code class="ruby">      contents_str = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="263">
          <span class="hits">26</span>
          
          <code class="ruby">      instances_str = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="264">
          <span class="hits">26</span>
          
          <code class="ruby">      each_content { |checksum, size, content_mod_time|</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="265">
          <span class="hits">47</span>
          
          <code class="ruby">        contents_str &lt;&lt; &quot;%s,%d,%d\n&quot; % [checksum, size, content_mod_time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="267">
          <span class="hits">26</span>
          
          <code class="ruby">      each_instance { |checksum, size, content_mod_time, instance_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="268">
          <span class="hits">74</span>
          
          <code class="ruby">        instances_str &lt;&lt;  &quot;%s,%d,%s,%s,%d\n&quot; % [checksum, size, server, path, instance_mod_time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="270">
          <span class="hits">26</span>
          
          <code class="ruby">      return_str &lt;&lt; &quot;%d\n&quot; % [@contents_info.length]</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="271">
          <span class="hits">26</span>
          
          <code class="ruby">      return_str &lt;&lt; contents_str</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="272">
          <span class="hits">26</span>
          
          <code class="ruby">      return_str &lt;&lt; &quot;%d\n&quot; % [@instances_info.length]</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="273">
          <span class="hits">26</span>
          
          <code class="ruby">      return_str &lt;&lt; instances_str</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="274">
          <span class="hits">26</span>
          
          <code class="ruby">      return_str</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">    # Write content data to file.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    # Write is using chunks (for both content chunks and instances chunks)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    # Chunk is used to maximize GC affect. The temporary memory of each chunk is GCed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    # Without the chunks used in a dipper stack level, GC keeps the temporary objects as part of the stack context.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_file(filename)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">      content_data_dir = File.dirname(filename)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">      FileUtils.makedirs(content_data_dir) unless File.directory?(content_data_dir)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">      File.open(filename, 'w') { |file|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="285">
          <span class="hits">1</span>
          
          <code class="ruby">        file.write(&quot;#{@contents_info.length}\n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">        contents_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">        content_chunks = @contents_info.length / CHUNK_SIZE + 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">        chunks_counter = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">        while chunks_counter &lt; content_chunks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="290">
          <span class="hits">1</span>
          
          <code class="ruby">          to_file_contents_chunk(file,contents_enum, CHUNK_SIZE)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">          GC.start</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">          chunks_counter += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="294">
          <span class="hits">1</span>
          
          <code class="ruby">        file.write(&quot;#{@instances_info.length}\n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="295">
          <span class="hits">1</span>
          
          <code class="ruby">        contents_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="296">
          <span class="hits">1</span>
          
          <code class="ruby">        chunks_counter = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">        while chunks_counter &lt; content_chunks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">          to_file_instances_chunk(file,contents_enum, CHUNK_SIZE)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="299">
          <span class="hits">1</span>
          
          <code class="ruby">          GC.start</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="300">
          <span class="hits">1</span>
          
          <code class="ruby">          chunks_counter += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="305">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_file_contents_chunk(file, contents_enum, chunk_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">      chunk_counter = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">      while chunk_counter &lt; chunk_size</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="308">
          <span class="hits">3</span>
          
          <code class="ruby">        checksum = contents_enum.next rescue return</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="309">
          <span class="hits">2</span>
          
          <code class="ruby">        content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="310">
          <span class="hits">2</span>
          
          <code class="ruby">        file.write(&quot;#{checksum},#{content_info[0]},#{content_info[2]}\n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="311">
          <span class="hits">2</span>
          
          <code class="ruby">        chunk_counter += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="315">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_file_instances_chunk(file, contents_enum, chunk_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="316">
          <span class="hits">1</span>
          
          <code class="ruby">      chunk_counter = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="317">
          <span class="hits">1</span>
          
          <code class="ruby">      while chunk_counter &lt; chunk_size</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="318">
          <span class="hits">3</span>
          
          <code class="ruby">        checksum = contents_enum.next rescue return</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="319">
          <span class="hits">2</span>
          
          <code class="ruby">        content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="320">
          <span class="hits">2</span>
          
          <code class="ruby">        instances_db_enum = content_info[1].each_key</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="321">
          <span class="hits">2</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="322">
          <span class="hits">5</span>
          
          <code class="ruby">          location = instances_db_enum.next rescue break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">          # provide the block with: checksum, size, content modification time,instance modification time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">          #   server and path.</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="325">
          <span class="hits">3</span>
          
          <code class="ruby">          instance_modification_time,instance_index_time = content_info[1][location]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="326">
          <span class="hits">3</span>
          
          <code class="ruby">          file.write(&quot;#{checksum},#{content_info[0]},#{location[0]},#{location[1]},&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">                     &quot;#{instance_modification_time},#{instance_index_time}\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="329">
          <span class="hits">2</span>
          
          <code class="ruby">        chunk_counter += 1</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="330">
          <span class="hits">2</span>
          
          <code class="ruby">        break if chunk_counter == chunk_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    # TODO validation that file indeed contains ContentData missing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">    # Loading db from file using chunks for better memory performance</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="336">
          <span class="hits">1</span>
          
          <code class="ruby">    def from_file(filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">      # read first line (number of contents)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">      # calculate line number (number of instances)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">      # read number of instances.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">      # loop over instances lines (using chunks) and add instances</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="342">
          <span class="hits">1</span>
          
          <code class="ruby">      File.open(filename, 'r') { |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">        # Get number of contents (at first line)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="344">
          <span class="hits">1</span>
          
          <code class="ruby">        number_of_contents = file.gets  # this gets the next line or return nil at EOF</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="345">
          <span class="hits">1</span>
          
          <code class="ruby">        unless (number_of_contents and number_of_contents.match(/^[\d]+$/))  # check that line is of Number format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">          return reset_load_from_file(filename, file, &quot;number of contents should be a number. We got:#{number_of_contents}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="348">
          <span class="hits">1</span>
          
          <code class="ruby">        number_of_contents = number_of_contents.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">        # advance file lines over all contents. We need only the instances data to build the content data object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">        # use chunks and GC</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="351">
          <span class="hits">1</span>
          
          <code class="ruby">        contents_chunks = number_of_contents / CHUNK_SIZE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="352">
          <span class="hits">1</span>
          
          <code class="ruby">        contents_chunks += 1 if (contents_chunks * CHUNK_SIZE &lt; number_of_contents)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="353">
          <span class="hits">1</span>
          
          <code class="ruby">        chunk_index = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="354">
          <span class="hits">1</span>
          
          <code class="ruby">        while chunk_index &lt; contents_chunks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">          chunk_size = CHUNK_SIZE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="356">
          <span class="hits">1</span>
          
          <code class="ruby">          if chunk_index + 1 == contents_chunks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">            # update last chunk size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="358">
          <span class="hits">1</span>
          
          <code class="ruby">            chunk_size = number_of_contents - (chunk_index * CHUNK_SIZE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="360">
          <span class="hits">1</span>
          
          <code class="ruby">          return unless read_contents_chunk(filename, file, chunk_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">          GC.start</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="362">
          <span class="hits">1</span>
          
          <code class="ruby">          chunk_index += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">        # get number of instances</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="366">
          <span class="hits">1</span>
          
          <code class="ruby">        number_of_instances = file.gets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="367">
          <span class="hits">1</span>
          
          <code class="ruby">        unless (number_of_instances and number_of_instances.match(/^[\d]+$/))  # check that line is of Number format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">          return reset_load_from_file(filename, file, &quot;number of instances should be a Number. We got:#{number_of_instances}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="370">
          <span class="hits">1</span>
          
          <code class="ruby">        number_of_instances = number_of_instances.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">        # read in instances chunks and GC</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="372">
          <span class="hits">1</span>
          
          <code class="ruby">        instances_chunks = number_of_instances / CHUNK_SIZE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="373">
          <span class="hits">1</span>
          
          <code class="ruby">        instances_chunks += 1 if (instances_chunks * CHUNK_SIZE &lt; number_of_instances)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="374">
          <span class="hits">1</span>
          
          <code class="ruby">        chunk_index = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="375">
          <span class="hits">1</span>
          
          <code class="ruby">        while chunk_index &lt; instances_chunks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="376">
          <span class="hits">1</span>
          
          <code class="ruby">          chunk_size = CHUNK_SIZE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="377">
          <span class="hits">1</span>
          
          <code class="ruby">          if chunk_index + 1 == instances_chunks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">            # update last chunk size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="379">
          <span class="hits">1</span>
          
          <code class="ruby">            chunk_size = number_of_instances - (chunk_index * CHUNK_SIZE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="381">
          <span class="hits">1</span>
          
          <code class="ruby">          return unless read_instances_chunk(filename, file, chunk_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="382">
          <span class="hits">1</span>
          
          <code class="ruby">          GC.start</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="383">
          <span class="hits">1</span>
          
          <code class="ruby">          chunk_index += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="388">
          <span class="hits">1</span>
          
          <code class="ruby">    def read_contents_chunk(filename, file, chunk_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="389">
          <span class="hits">1</span>
          
          <code class="ruby">      chunk_index = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="390">
          <span class="hits">1</span>
          
          <code class="ruby">      while chunk_index &lt; chunk_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">        return reset_load_from_file(filename, file, &quot;Expecting content line but &quot; +</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="392">
          <span class="hits">2</span>
          
          <code class="ruby">            &quot;reached end of file after line #{$.}&quot;) unless file.gets</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="393">
          <span class="hits">2</span>
          
          <code class="ruby">        chunk_index += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="395">
          <span class="hits">1</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="398">
          <span class="hits">1</span>
          
          <code class="ruby">    def  read_instances_chunk(filename, file, chunk_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="399">
          <span class="hits">1</span>
          
          <code class="ruby">      chunk_index = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="400">
          <span class="hits">1</span>
          
          <code class="ruby">      while chunk_index &lt; chunk_size</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="401">
          <span class="hits">3</span>
          
          <code class="ruby">        instance_line = file.gets</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="402">
          <span class="hits">3</span>
          
          <code class="ruby">        return reset_load_from_file(filename, file, &quot;Expected to read Instance line but reached EOF&quot;) unless instance_line</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="403">
          <span class="hits">3</span>
          
          <code class="ruby">        parameters = instance_line.split(',')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        # bugfix: if file name consist a comma then parsing based on comma separating fails</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="405">
          <span class="hits">3</span>
          
          <code class="ruby">        if (parameters.size &gt; 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">          (4..parameters.size-3).each do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">            parameters[3] = [parameters[3], parameters[i]].join(&quot;,&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">          (4..parameters.size-3).each do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">            parameters.delete_at(4)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="414">
          <span class="hits">3</span>
          
          <code class="ruby">        add_instance(parameters[0],        #checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">                     parameters[1].to_i,   # size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">                     parameters[2],        # server</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">                     parameters[3],        # path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">                     parameters[4].to_i,   # mod time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">                     parameters[5].to_i)   # index time</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="420">
          <span class="hits">3</span>
          
          <code class="ruby">        chunk_index += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="422">
          <span class="hits">1</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="425">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset_load_from_file(file_name, file_io, err_msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">      Log.error(&quot;unexpected error reading file:#{file_name}\nError message:#{err_msg}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">      @contents_info = {}  # Checksum --&gt; [size, paths--&gt;time(instance), time(content)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">      @instances_info = {}  # location --&gt; checksum to optimize instances query</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">      file_io.close</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">    # for each content, all time fields (content and instances) are replaced with the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">    # min time found, while going through all time fields.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="435">
          <span class="hits">1</span>
          
          <code class="ruby">    def unify_time()</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="436">
          <span class="hits">2</span>
          
          <code class="ruby">      contents_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="437">
          <span class="hits">2</span>
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="438">
          <span class="hits">8</span>
          
          <code class="ruby">        checksum = contents_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="439">
          <span class="hits">6</span>
          
          <code class="ruby">        content_info = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="440">
          <span class="hits">6</span>
          
          <code class="ruby">        min_time_per_checksum = content_info[2]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="441">
          <span class="hits">6</span>
          
          <code class="ruby">        instances = content_info[1]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="442">
          <span class="hits">6</span>
          
          <code class="ruby">        instances_enum = instances.each_key</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="443">
          <span class="hits">6</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="444">
          <span class="hits">19</span>
          
          <code class="ruby">          location = instances_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="445">
          <span class="hits">13</span>
          
          <code class="ruby">          instance_mod_time = instances[location][0]</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="446">
          <span class="hits">13</span>
          
          <code class="ruby">          if instance_mod_time &lt; min_time_per_checksum</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="447">
          <span class="hits">3</span>
          
          <code class="ruby">            min_time_per_checksum = instance_mod_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">        # update all instances with min time</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="451">
          <span class="hits">6</span>
          
          <code class="ruby">        instances_enum = instances.each_key</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="452">
          <span class="hits">6</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="453">
          <span class="hits">19</span>
          
          <code class="ruby">          location = instances_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="454">
          <span class="hits">13</span>
          
          <code class="ruby">          instances[location][0] = min_time_per_checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">        # update content time with min time</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="457">
          <span class="hits">6</span>
          
          <code class="ruby">        content_info[2] = min_time_per_checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">    # Validates index against file system that all instances hold a correct data regarding files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">    # that they represents.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">    # There are two levels of validation, controlled by instance_check_level system parameter:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">    # * shallow - quick, tests instance for file existence and attributes.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">    # * deep - can take more time, in addition to shallow recalculates hash sum.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">    # @param [Hash] params hash of parameters of validation, can be used to return additional data.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">    #     Supported key/value combinations:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">    #     * key is &lt;tt&gt;:failed&lt;/tt&gt; value is &lt;tt&gt;ContentData&lt;/tt&gt; used to return failed instances</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">    # @return [Boolean] true when index is correct, false otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">    # @raise [ArgumentError] when instance_check_level is incorrect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="473">
          <span class="hits">1</span>
          
          <code class="ruby">    def validate(params = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">      # used to answer whether specific param was set</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="475">
          <span class="hits">11</span>
          
          <code class="ruby">      param_exists = Proc.new do |param|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="476">
          <span class="hits">4</span>
          
          <code class="ruby">        !(params.nil? || params[param].nil?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">      # used to process method parameters centrally</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="480">
          <span class="hits">11</span>
          
          <code class="ruby">      process_params = Proc.new do |values|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="481">
          <span class="hits">4</span>
          
          <code class="ruby">        if param_exists.call(:failed)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="482">
          <span class="hits">4</span>
          
          <code class="ruby">          info = values[:details]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="483">
          <span class="hits">4</span>
          
          <code class="ruby">          unless info.nil?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="484">
          <span class="hits">4</span>
          
          <code class="ruby">            checksum = info[0]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="485">
          <span class="hits">4</span>
          
          <code class="ruby">            content_mtime = info[1]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="486">
          <span class="hits">4</span>
          
          <code class="ruby">            size = info[2]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="487">
          <span class="hits">4</span>
          
          <code class="ruby">            inst_mtime = info[3]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="488">
          <span class="hits">4</span>
          
          <code class="ruby">            server = info[4]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="489">
          <span class="hits">4</span>
          
          <code class="ruby">            file_path = info[5]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="490">
          <span class="hits">4</span>
          
          <code class="ruby">            params[:failed].add_instance(checksum, size, server, file_path, inst_mtime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="495">
          <span class="hits">11</span>
          
          <code class="ruby">      is_valid = true</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="496">
          <span class="hits">11</span>
          
          <code class="ruby">      contents_enum = @contents_info.each_key</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="497">
          <span class="hits">11</span>
          
          <code class="ruby">      loop {</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="498">
          <span class="hits">34</span>
          
          <code class="ruby">        checksum = contents_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="499">
          <span class="hits">23</span>
          
          <code class="ruby">        instances = @contents_info[checksum]</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="500">
          <span class="hits">23</span>
          
          <code class="ruby">        content_size = instances[0]</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="501">
          <span class="hits">23</span>
          
          <code class="ruby">        content_mtime = instances[2]</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="502">
          <span class="hits">23</span>
          
          <code class="ruby">        instances_enum = instances[1].each_key</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="503">
          <span class="hits">23</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="504">
          <span class="hits">46</span>
          
          <code class="ruby">          unique_path = instances_enum.next rescue break</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="505">
          <span class="hits">23</span>
          
          <code class="ruby">          instance_mtime = instances[1][unique_path][0]</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="506">
          <span class="hits">23</span>
          
          <code class="ruby">          instance_info = [checksum, content_mtime, content_size, instance_mtime]</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="507">
          <span class="hits">23</span>
          
          <code class="ruby">          instance_info.concat(unique_path)</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="508">
          <span class="hits">23</span>
          
          <code class="ruby">          unless check_instance(instance_info)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="509">
          <span class="hits">8</span>
          
          <code class="ruby">            is_valid = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="511">
          <span class="hits">8</span>
          
          <code class="ruby">            unless params.nil? || params.empty?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="512">
          <span class="hits">4</span>
          
          <code class="ruby">              process_params.call({:details =&gt; instance_info})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="517">
          <span class="hits">11</span>
          
          <code class="ruby">      is_valid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby">    # instance_info is an array:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">    #   [0] - checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="522">
          
          
          <code class="ruby">    #   [1] - content time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">    #   [2] - content size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="524">
          
          
          <code class="ruby">    #   [3] - instance mtime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby">    #   [4] - server name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="526">
          
          
          <code class="ruby">    #   [5] - file path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="527">
          <span class="hits">1</span>
          
          <code class="ruby">    def shallow_check(instance_info)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="528">
          <span class="hits">19</span>
          
          <code class="ruby">      path = instance_info[5]</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="529">
          <span class="hits">19</span>
          
          <code class="ruby">      size = instance_info[2]</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="530">
          <span class="hits">19</span>
          
          <code class="ruby">      instance_mtime = instance_info[3]</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="531">
          <span class="hits">19</span>
          
          <code class="ruby">      is_valid = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="533">
          <span class="hits">19</span>
          
          <code class="ruby">      if (File.exists?(path))</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="534">
          <span class="hits">17</span>
          
          <code class="ruby">        if File.size(path) != size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="535">
          <span class="hits">1</span>
          
          <code class="ruby">          is_valid = false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="536">
          <span class="hits">1</span>
          
          <code class="ruby">          err_msg = &quot;#{path} size #{File.size(path)} differs from indexed size #{size}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="537">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.warning(err_msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="538">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby">        #if ContentData.format_time(File.mtime(path)) != instance.modification_time</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="540">
          <span class="hits">17</span>
          
          <code class="ruby">        if File.mtime(path).to_i != instance_mtime</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="541">
          <span class="hits">4</span>
          
          <code class="ruby">          is_valid = false</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="542">
          <span class="hits">4</span>
          
          <code class="ruby">          err_msg = &quot;#{path} modification time #{File.mtime(path).to_i} differs from &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">            + &quot;indexed #{instance_mtime}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="544">
          <span class="hits">4</span>
          
          <code class="ruby">          Log.warning(err_msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="545">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="547">
          <span class="hits">2</span>
          
          <code class="ruby">        is_valid = false</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="548">
          <span class="hits">2</span>
          
          <code class="ruby">        err_msg = &quot;Indexed file #{path} doesn't exist&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="549">
          <span class="hits">2</span>
          
          <code class="ruby">        Log.warning(err_msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="551">
          <span class="hits">19</span>
          
          <code class="ruby">      is_valid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby">    # instance_info is an array:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby">    #   [0] - checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="556">
          
          
          <code class="ruby">    #   [1] - content time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby">    #   [2] - content size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby">    #   [3] - instance mtime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby">    #   [4] - server name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby">    #   [5] - file path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="561">
          <span class="hits">1</span>
          
          <code class="ruby">    def deep_check(instance_info)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="562">
          <span class="hits">4</span>
          
          <code class="ruby">      if shallow_check(instance_info)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="563">
          <span class="hits">4</span>
          
          <code class="ruby">        instance_checksum = instance_info[0]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="564">
          <span class="hits">4</span>
          
          <code class="ruby">        path = instance_info[5]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="565">
          <span class="hits">4</span>
          
          <code class="ruby">        current_checksum = FileIndexing::IndexAgent.get_checksum(path)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="566">
          <span class="hits">4</span>
          
          <code class="ruby">        if instance_checksum == current_checksum</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="567">
          <span class="hits">3</span>
          
          <code class="ruby">          true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="569">
          <span class="hits">1</span>
          
          <code class="ruby">          err_msg = &quot;#{path} checksum #{current_checksum} differs from indexed #{instance_checksum}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="570">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.warning(err_msg)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="571">
          <span class="hits">1</span>
          
          <code class="ruby">          false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="572">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="576">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby">    # @raise [ArgumentError] when instance_check_level is incorrect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="579">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_instance(instance)</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="580">
          <span class="hits">23</span>
          
          <code class="ruby">      case Params['instance_check_level']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">        when 'deep'</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="582">
          <span class="hits">4</span>
          
          <code class="ruby">          deep_check instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby">        when 'shallow'</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="584">
          <span class="hits">19</span>
          
          <code class="ruby">          shallow_check instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby">          # TODO remove it when params will support set of values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="587">
          
          
          <code class="ruby">          throw ArgumentError.new &quot;Unsupported check level #{Params['instance_check_level']}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="588">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="589">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="590">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby">    # TODO simplify conditions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby">    # This mehod is experimental and shouldn\'t be used</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="594">
          
          
          <code class="ruby">    # nil is used to define +/- infinity for to/from method arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="595">
          
          
          <code class="ruby">    # from/to values are exlusive in condition'a calculations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="596">
          
          
          <code class="ruby">    # Need to take care about '==' operation that is used for object's comparison.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">    # In need of case user should define it's own '==' implemementation.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="598">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_query(variable, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="599">
          
          
          <code class="ruby">      raise RuntimeError.new 'This method is experimental and shouldn\'t be used'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="601">
          
          
          <code class="ruby">      exact = params['exact'].nil? ? Array.new : params['exact']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="602">
          
          
          <code class="ruby">      from = params['from']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="603">
          
          
          <code class="ruby">      to = params ['to']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">      is_inside = params['is_inside']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="606">
          
          
          <code class="ruby">      unless ContentInstance.new.instance_variable_defined?(&quot;@#{attribute}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="607">
          
          
          <code class="ruby">        raise ArgumentError &quot;#{variable} isn't a ContentInstance variable&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="609">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="610">
          
          
          <code class="ruby">      if (exact.nil? &amp;&amp; from.nil? &amp;&amp; to.nil?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">        raise ArgumentError 'At least one of the argiments {exact, from, to} must be defined'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="614">
          
          
          <code class="ruby">      if (!(from.nil? || to.nil?) &amp;&amp; from.kind_of?(to.class))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">        raise ArgumentError 'to and from arguments should be comparable one with another'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="618">
          
          
          <code class="ruby">      # FIXME add support for from/to for Strings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby">      if ((!from.nil? &amp;&amp; !from.kind_of?(Numeric.new.class))\</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">            || (!to.nil? &amp;&amp; to.kind_of?(Numeric.new.class)))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="621">
          
          
          <code class="ruby">        raise ArgumentError 'from and to options supported only for numeric values'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="622">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="624">
          
          
          <code class="ruby">      if (!exact.empty? &amp;&amp; (!from.nil? || !to.nil?))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="625">
          
          
          <code class="ruby">        raise ArgumentError 'exact and from/to options are mutually exclusive'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="626">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">      result_index = ContentData.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="629">
          
          
          <code class="ruby">      instances.each_value do |instance|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="630">
          
          
          <code class="ruby">        is_match = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="631">
          
          
          <code class="ruby">        var_value = instance.instance_variable_get(&quot;@#{variable}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="633">
          
          
          <code class="ruby">        if exact.include? var_value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="634">
          
          
          <code class="ruby">          is_match = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="635">
          
          
          <code class="ruby">        elsif (from.nil? || var_value &gt; from) &amp;&amp; (to.nil? || var_value &lt; to)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">          is_match = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="638">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="639">
          
          
          <code class="ruby">        if (is_match &amp;&amp; is_inside) || (!is_match &amp;&amp; !is_inside)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">          checksum = instance.checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="641">
          
          
          <code class="ruby">          result_index.add_content(contents[checksum]) unless result_index.content_exists(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="642">
          
          
          <code class="ruby">          result_index.add_instance instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="643">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="644">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">      result_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="646">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="648">
          <span class="hits">1</span>
          
          <code class="ruby">    private :shallow_check, :deep_check, :check_instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="649">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="650">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="651">
          
          
          <code class="ruby">  # merges content data a and content data b to a new content data and returns it.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="652">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.merge(a, b)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="653">
          <span class="hits">1</span>
          
          <code class="ruby">    return ContentData.new(a) if b.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="654">
          <span class="hits">1</span>
          
          <code class="ruby">    return ContentData.new(b) if a.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="655">
          <span class="hits">1</span>
          
          <code class="ruby">    c = ContentData.new(b)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="656">
          
          
          <code class="ruby">    # Add A instances to content data c</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="657">
          <span class="hits">1</span>
          
          <code class="ruby">    a.each_instance { |checksum, size, content_mod_time, instance_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="658">
          <span class="hits">1</span>
          
          <code class="ruby">      c.add_instance(checksum, size, server, path, instance_mod_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="659">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="660">
          <span class="hits">1</span>
          
          <code class="ruby">    c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="662">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="663">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.merge_override_b(a, b)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="664">
          <span class="hits">1</span>
          
          <code class="ruby">    return ContentData.new(a) if b.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="665">
          <span class="hits">1</span>
          
          <code class="ruby">    return ContentData.new(b) if a.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="666">
          
          
          <code class="ruby">    # Add A instances to content data B</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="667">
          <span class="hits">1</span>
          
          <code class="ruby">    a.each_instance { |checksum, size, content_mod_time, instance_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="668">
          <span class="hits">1</span>
          
          <code class="ruby">      b.add_instance(checksum, size, server, path, instance_mod_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="669">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="670">
          <span class="hits">1</span>
          
          <code class="ruby">    b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="671">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="672">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby">  # B - A : Remove contents of A from B and return the new content data.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="674">
          
          
          <code class="ruby">  # instances are ignored</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="675">
          
          
          <code class="ruby">  # e.g</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="676">
          
          
          <code class="ruby">  # A db:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="677">
          
          
          <code class="ruby">  #    Content_1 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="678">
          
          
          <code class="ruby">  #                   Instance_1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="679">
          
          
          <code class="ruby">  #                   Instance_2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="680">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="681">
          
          
          <code class="ruby">  #    Content_2 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="682">
          
          
          <code class="ruby">  #                   Instance_3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="683">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="684">
          
          
          <code class="ruby">  # B db:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="685">
          
          
          <code class="ruby">  #    Content_1 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="686">
          
          
          <code class="ruby">  #                   Instance_1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="687">
          
          
          <code class="ruby">  #                   Instance_2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="688">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="689">
          
          
          <code class="ruby">  #    Content_2 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="690">
          
          
          <code class="ruby">  #                   Instance_3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="691">
          
          
          <code class="ruby">  #                   Instance_4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="692">
          
          
          <code class="ruby">  #    Content_3 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby">  #                   Instance_5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="694">
          
          
          <code class="ruby">  # B-A db:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="695">
          
          
          <code class="ruby">  #   Content_3 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="696">
          
          
          <code class="ruby">  #                   Instance_5</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="697">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.remove(a, b)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="698">
          <span class="hits">5</span>
          
          <code class="ruby">    return nil if b.nil?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="699">
          <span class="hits">4</span>
          
          <code class="ruby">    return ContentData.new(b) if a.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="700">
          <span class="hits">3</span>
          
          <code class="ruby">    c = ContentData.new(b)  # create new cloned content C from B</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby">    # remove contents of A from newly cloned content A</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="702">
          <span class="hits">3</span>
          
          <code class="ruby">    a.each_content { |checksum, size, content_mod_time|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="703">
          <span class="hits">4</span>
          
          <code class="ruby">      c.remove_content(checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="704">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="705">
          <span class="hits">3</span>
          
          <code class="ruby">    c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="706">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="707">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="708">
          
          
          <code class="ruby">  # B - A : Remove instances of A content from B content data B and return the new content data.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="709">
          
          
          <code class="ruby">  # If all instances are removed then the content record itself will be removed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="710">
          
          
          <code class="ruby">  # e.g</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="711">
          
          
          <code class="ruby">  # A db:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="712">
          
          
          <code class="ruby">  #    Content_1 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby">  #                   Instance_1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby">  #                   Instance_2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="715">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">  #    Content_2 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby">  #                   Instance_3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="718">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="719">
          
          
          <code class="ruby">  # B db:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby">  #    Content_1 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="721">
          
          
          <code class="ruby">  #                   Instance_1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="722">
          
          
          <code class="ruby">  #                   Instance_2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="723">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="724">
          
          
          <code class="ruby">  #    Content_2 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="725">
          
          
          <code class="ruby">  #                   Instance_3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="726">
          
          
          <code class="ruby">  #                   Instance_4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="727">
          
          
          <code class="ruby">  # B-A db:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="728">
          
          
          <code class="ruby">  #   Content_2 -&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="729">
          
          
          <code class="ruby">  #                   Instance_4</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="730">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.remove_instances(a, b)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="731">
          <span class="hits">7</span>
          
          <code class="ruby">    return nil if b.nil?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="732">
          <span class="hits">6</span>
          
          <code class="ruby">    return ContentData.new(b) if a.nil?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="733">
          <span class="hits">5</span>
          
          <code class="ruby">    c = ContentData.new(b)  # create new cloned content C from B</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="734">
          
          
          <code class="ruby">    # remove contents of A from newly cloned content A</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="735">
          <span class="hits">5</span>
          
          <code class="ruby">    a.each_instance { |_, _, _, _, server, path|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="736">
          <span class="hits">3</span>
          
          <code class="ruby">      c.remove_instance(server, path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="737">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="738">
          <span class="hits">5</span>
          
          <code class="ruby">    c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="739">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="740">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="741">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.remove_directory(content_data, dir_to_remove, server_to_remove)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="742">
          <span class="hits">3</span>
          
          <code class="ruby">    return nil if content_data.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="743">
          <span class="hits">2</span>
          
          <code class="ruby">    result_content_data = ContentData.new(content_data)  # clone from content_data</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="744">
          <span class="hits">2</span>
          
          <code class="ruby">    result_content_data.remove_directory(dir_to_remove, server_to_remove)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="745">
          <span class="hits">2</span>
          
          <code class="ruby">    result_content_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="747">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="748">
          
          
          <code class="ruby">  # returns the common content in both a and b</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="749">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.intersect(a, b)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="750">
          <span class="hits">1</span>
          
          <code class="ruby">    return nil if a.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="751">
          <span class="hits">1</span>
          
          <code class="ruby">    return nil if b.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="752">
          <span class="hits">1</span>
          
          <code class="ruby">    b_minus_a = remove(a, b)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="753">
          <span class="hits">1</span>
          
          <code class="ruby">    b_minus_b_minus_a  = remove(b_minus_a, b)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="755">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="756">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9ff0fbe180f3ef882d6d09890fe76b31ae496751">
  <div class="header">
    <h3>lib/content_server/backup_server.rb</h3>
    <h4><span class="red">26.74 %</span> covered</h4>
    <div>
      <b>86</b> relevant lines. 
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>63</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'fileutils'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'set'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'thread'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_data'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/content_receiver'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/queue_copy'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/remote_content'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/server'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_indexing'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_monitoring'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">require 'networking/tcp'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">require 'process_monitoring/monitoring'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">require 'process_monitoring/monitoring_info'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"># Content server. Monitors files, index local files, listen to backup server content,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"># copy changes and new files to backup server.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">module ContentServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # Backup server specific flags</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('content_server_hostname', nil, 'IP or DNS of backup server.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('content_server_data_port', 3333, 'Port to copy content data from.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('content_server_files_port', 4444, 'Listening port in backup server for files')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('backup_check_delay', 5, 'Delay in seconds between two content vs backup checks.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.complex('backup_destination_folder',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">                 [{'path'=&gt;File.expand_path(''), 'scan_period'=&gt;300, 'stable_state'=&gt;1}],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">                 'Backup server destination folder, default is the relative local folder.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def run_backup_server</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    Log.info('Start backup server')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    Thread.abort_on_exception = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    all_threads = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # create general tmp dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    FileUtils.mkdir_p(Params['tmp_path']) unless File.directory?(Params['tmp_path'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    # init tmp content data file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    $tmp_content_data_file = File.join(Params['tmp_path'], 'backup.data')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    if Params['enable_monitoring']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      Log.info(&quot;Initializing monitoring of process params on port:%s&quot;, Params['process_monitoring_web_port'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      $process_vars.set('server_name', 'backup_server')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    # # # # # # # # # # # #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # Initialize/start monitoring and destination folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    Params['backup_destination_folder'][0]['path']=File.expand_path(Params['backup_destination_folder'][0]['path'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    Log.info(&quot;backup_destination_folder is:%s&quot;, Params['backup_destination_folder'][0]['path'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    #adding destination folder to monitoring paths</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    Params['monitoring_paths'] &lt;&lt; Params['backup_destination_folder'][0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    Log.info('Start monitoring following directories:')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    Params['monitoring_paths'].each { |path|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      Log.info(&quot;  Path:'%s'&quot;, path['path'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # initial global local content data object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    $local_content_data_lock = Mutex.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    $local_content_data = ContentData::ContentData.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    $last_content_data_id = $local_content_data.unique_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    # Read here for initial content data that exist from previous system run</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    content_data_path = Params['local_content_data_path']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    if File.exists?(content_data_path) and !File.directory?(content_data_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      Log.info(&quot;reading initial content data that exist from previous system run from file:%s&quot;, content_data_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      $local_content_data.from_file(content_data_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      $last_content_data_id = $local_content_data.unique_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      if File.directory?(content_data_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        raise(&quot;Param:'local_content_data_path':'%s' cannot be a directory name&quot;, Params['local_content_data_path'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      # create directory if needed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      dir = File.dirname(Params['local_content_data_path'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      FileUtils.mkdir_p(dir) unless File.exists?(dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    Log.info(&quot;Init monitoring&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    fm = FileMonitoring::FileMonitoring.new()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    # Start monitoring and writing changes to queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    all_threads &lt;&lt; Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      fm.monitor_files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    # # # # # # # # # # # # # # # # # # # # # # # #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    # thread: Start dump local content data to file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    Log.debug1('Init thread: flush local content data to file')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    all_threads &lt;&lt; Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      FileUtils.mkdir_p(Params['tmp_path']) unless File.directory?(Params['tmp_path'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      loop{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        sleep(Params['data_flush_delay'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        ContentServer.flush_content_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    #initialize global - remote content data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    $remote_content_data_lock = Mutex.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    $remote_content_data = ContentData::ContentData.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    remote_content = ContentServer::RemoteContentClient.new(Params['content_server_hostname'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">                                                            Params['content_server_data_port'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">                                                            Params['backup_destination_folder'][0]['path'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    all_threads.concat(remote_content.run())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    file_copy_client = FileCopyClient.new(Params['content_server_hostname'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">                                          Params['content_server_files_port'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    all_threads.concat(file_copy_client.threads)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    # Each</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    Log.info('Start remote and local contents comparator')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    all_threads &lt;&lt; Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      loop do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        sleep(Params['backup_check_delay'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">          $remote_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">            diff = ContentData.remove($local_content_data, $remote_content_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">            unless diff.nil? || diff.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">              Log.debug2(&quot;Backup content:\n%s&quot;, $local_content_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">              Log.debug2(&quot;Remote content:\n%s&quot;, $remote_content_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">              Log.debug2(&quot;Missing contents:\n%s&quot;, diff)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">              Log.info('Start sync check. Backup and remote contents need a sync, requesting copy files:')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">              file_copy_client.request_copy(diff)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">              Log.info(&quot;Start sync check. Local and remote contents are equal. No sync required.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">            diff = ContentData::ContentData.new  # to clear the memory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    # # # # # # # # # # # # # # # # # # # # # # # #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    # Start process vars thread</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    if Params['enable_monitoring']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      monitoring_info = MonitoringInfo::MonitoringInfo.new()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      all_threads &lt;&lt; Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        ContentServer.monitor_general_process_vars</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    all_threads.each { |t| t.abort_on_exception = true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">    all_threads.each { |t| t.join }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    # Should never reach this line.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :run_backup_server</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">end # module ContentServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5eab87ad200a83213901faddb0cedfef946eacd4">
  <div class="header">
    <h3>lib/content_server/content_receiver.rb</h3>
    <h4><span class="red">29.73 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>26</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'socket'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module ContentServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  class ContentDataReceiver</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize queue, port</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      @queue = queue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      @port = port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def run</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      Socket.tcp_server_loop(@port) do |sock, client_addrinfo|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        while size_of_data = sock.read(4)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">          size_of_data = size_of_data.unpack(&quot;l&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">          Log.debug2(&quot;Size of data: %s&quot;, size_of_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          data = sock.read(size_of_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">          unmarshaled_data = Marshal.load(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">          @queue.push unmarshaled_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">          Log.debug2(&quot;Socket closed? %s.&quot;, sock.closed?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">          break if sock.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">          Log.debug2('Waiting on sock.read')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        Log.debug2('Exited, socket closed or read returned nil.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  class ContentDataSender</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize host, port</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      @host = host</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      @port = port</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      open_socket</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    def open_socket</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      Log.debug1(&quot;Connecting to content server %s:%s.&quot;, @host, @port)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      @tcp_socket = TCPSocket.new(@host, @port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    def send_content_data content_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      open_socket if @tcp_socket.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      marshal_data = Marshal.dump(content_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      Log.debug2(&quot;Marshaled size: %s.&quot;, marshal_data.length)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      data_size = [marshal_data.length].pack(&quot;l&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      if data_size.nil? || marshal_data.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        Log.debug2('Send data is nil!!!!!!!!')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      @tcp_socket.write data_size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      @tcp_socket.write marshal_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="aa211c201d4dfb6be85ed1fe1498803f5b21ec3c">
  <div class="header">
    <h3>lib/content_server/file_streamer.rb</h3>
    <h4><span class="red">74.72 %</span> covered</h4>
    <div>
      <b>178</b> relevant lines. 
      <span class="green"><b>133</b> lines covered</span> and
      <span class="red"><b>45</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'tempfile'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'thread'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_indexing/index_agent'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/server'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">module ContentServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('streaming_chunk_size', 2*1024*1024,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">                 'Max number of content bytes to send in one chunk.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('file_streaming_timeout', 5*60,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">                 'If no action is taken on a file streamer, abort copy.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  class Stream</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :checksum, :path, :tmp_path, :file, :size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(checksum, path, file, size)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">      @checksum = checksum</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">      @path = path</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">      @file = file</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">      @size = size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.close_delete_stream(checksum, streams_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      if streams_hash.key?(checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">        Log.debug1(&quot;close_delete_stream %s&quot;, streams_hash[checksum].path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">          streams_hash[checksum].file.close()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        rescue IOError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          Log.warning(&quot;While closing stream, could not close file #{streams_hash[checksum].path}.&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">                        &quot; IOError msg:#{e.to_s}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">        streams_hash.delete(checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">        $process_vars.set('Streams size', streams_hash.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileStreamer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    :NEW_STREAM</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    :ABORT_STREAM</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    :RESET_STREAM</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    :COPY_CHUNK</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(send_chunk_clb, abort_streaming_clb=nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      @send_chunk_clb = send_chunk_clb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      @abort_streaming_clb = abort_streaming_clb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      @stream_queue = Queue.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      # Used from internal thread only.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      @streams = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">      @thread = run</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    def copy_another_chuck(checksum)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="60">
          <span class="hits">11</span>
          
          <code class="ruby">      @stream_queue &lt;&lt; [:COPY_CHUNK, checksum]</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="61">
          <span class="hits">11</span>
          
          <code class="ruby">      $process_vars.set('File Streamer queue', @stream_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    def start_streaming(checksum, path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      @stream_queue &lt;&lt; [:NEW_STREAM, [checksum, path]]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      $process_vars.set('File Streamer queue', @stream_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def abort_streaming(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      @stream_queue &lt;&lt; [:ABORT_STREAM, checksum]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      $process_vars.set('File Streamer queue', @stream_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset_streaming(checksum, new_offset)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      @stream_queue &lt;&lt; [:RESET_STREAM, [checksum, new_offset]]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      $process_vars.set('File Streamer queue', @stream_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def run</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">      return Thread.new do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="82">
          <span class="hits">13</span>
          
          <code class="ruby">          stream_pop = @stream_queue.pop</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="83">
          <span class="hits">13</span>
          
          <code class="ruby">          $process_vars.set('File Streamer queue', @stream_queue.size)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="84">
          <span class="hits">13</span>
          
          <code class="ruby">          checksum = handle(stream_pop)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    def handle(message)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="90">
          <span class="hits">13</span>
          
          <code class="ruby">      type, content = message</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="91">
          <span class="hits">13</span>
          
          <code class="ruby">      if type == :NEW_STREAM</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">        checksum, path = content</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">        reset_stream(checksum, path, 0)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">        @stream_queue &lt;&lt; [:COPY_CHUNK, checksum] if @streams.key?(checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">        $process_vars.set('File Streamer queue', @stream_queue.size)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="96">
          <span class="hits">12</span>
          
          <code class="ruby">      elsif type == :ABORT_STREAM</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        checksum = content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        Stream.close_delete_stream(checksum, @streams)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="99">
          <span class="hits">12</span>
          
          <code class="ruby">      elsif type == :RESET_STREAM</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        checksum, new_offset = content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        reset_stream(checksum, nil, new_offset)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        @stream_queue &lt;&lt; [:COPY_CHUNK, checksum] if @streams.key?(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        $process_vars.set('File Streamer queue', @stream_queue.size)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="104">
          <span class="hits">12</span>
          
          <code class="ruby">      elsif type == :COPY_CHUNK</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="105">
          <span class="hits">12</span>
          
          <code class="ruby">        checksum = content</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="106">
          <span class="hits">12</span>
          
          <code class="ruby">        if @streams.key?(checksum)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="107">
          <span class="hits">12</span>
          
          <code class="ruby">          offset = @streams[checksum].file.pos</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="108">
          <span class="hits">12</span>
          
          <code class="ruby">          Log.debug1(&quot;Sending chunk for %s, offset %s.&quot;,checksum, offset)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="109">
          <span class="hits">12</span>
          
          <code class="ruby">          chunk = @streams[checksum].file.read(Params['streaming_chunk_size'])</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="110">
          <span class="hits">12</span>
          
          <code class="ruby">          if chunk.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">            # No more to read, send end of file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">            @send_chunk_clb.call(checksum, offset, @streams[checksum].size, nil, nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">            Stream.close_delete_stream(checksum, @streams)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="115">
          <span class="hits">11</span>
          
          <code class="ruby">            chunk_checksum = FileIndexing::IndexAgent.get_content_checksum(chunk)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="116">
          <span class="hits">11</span>
          
          <code class="ruby">            @send_chunk_clb.call(checksum, offset, @streams[checksum].size, chunk, chunk_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">          Log.debug1(&quot;No stream found for copy chunk checksum %s.&quot;, checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset_stream(checksum, path, offset)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">      if !@streams.key? checksum</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">          file = File.new(path, 'rb')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">          if offset &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">            file.seek(offset)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.debug1(&quot;File streamer: %s.&quot;, file)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">          @streams[checksum] = Stream.new(checksum, path, file, file.size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">          $process_vars.set('Streams size', @streams.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        rescue IOError, Errno::ENOENT =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          Log.warning(&quot;Could not stream local file #{path}. #{e.to_s}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        @streams[checksum].file.seek(offset)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  # Start implementing as dummy, no self thread for now.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  # Later when we need it to response and send aborts, timeouts, ect, it will</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  # need self thread.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileReceiver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(file_done_clb=nil, file_abort_clb=nil, reset_copy=nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">      @file_done_clb = file_done_clb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">      @file_abort_clb = file_abort_clb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">      @reset_copy = reset_copy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">      @streams = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    def receive_chunk(file_checksum, offset, file_size, content, content_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      # If standard chunk copy.</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="158">
          <span class="hits">12</span>
          
          <code class="ruby">      if !content.nil? &amp;&amp; !content_checksum.nil?</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="159">
          <span class="hits">11</span>
          
          <code class="ruby">        received_content_checksum = FileIndexing::IndexAgent.get_content_checksum(content)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="160">
          <span class="hits">11</span>
          
          <code class="ruby">        comment = &quot;Calculated received chunk with content checksum #{received_content_checksum}&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">                    &quot; vs message content checksum #{content_checksum}, &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">                    &quot;file checksum #{file_checksum}&quot;</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="163">
          <span class="hits">11</span>
          
          <code class="ruby">        Log.debug1(comment) if content_checksum == received_content_checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">        # TODO should be here a kind of abort?</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="165">
          <span class="hits">11</span>
          
          <code class="ruby">        if content_checksum != received_content_checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">          Log.warning(comment)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">          new_offset = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">          if @streams.key?(file_checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">            new_offset = @streams[file_checksum].file.pos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">          @reset_copy.call(file_checksum, new_offset) unless @reset_copy.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="175">
          <span class="hits">11</span>
          
          <code class="ruby">        if !@streams.key?(file_checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">          handle_new_stream(file_checksum, file_size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        # We still check @streams has the key, because file can fail to open.</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="179">
          <span class="hits">11</span>
          
          <code class="ruby">        if @streams.key?(file_checksum)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="180">
          <span class="hits">11</span>
          
          <code class="ruby">          return handle_new_chunk(file_checksum, offset, content)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">          Log.warning('Cannot handle chunk, stream does not exists, sending abort.')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">          @file_abort_clb.call(file_checksum) unless @file_abort_clb.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        # If last chunk copy.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      elsif content.nil? &amp;&amp; content_checksum.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">        Log.debug1('Handle the case of backup empty file or last chunk')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        # Handle the case of backup empty file or last chunk.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">        handle_new_stream(file_checksum, 0) if !@streams.key?(file_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        # Finalize the file copy.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">        handle_last_chunk(file_checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        Log.warning(&quot;Unexpected receive chuck message. file_checksum:#{file_checksum}, &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">                      &quot;content.nil?:#{content.nil?}, content_checksum:#{content_checksum}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">      Log.error('Code should never reach this point')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    # open new stream</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">    def handle_new_stream(file_checksum, file_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">      Log.debug1(&quot;enter handle_new_stream&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      # final destination path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">      tmp_path = FileReceiver.destination_filename(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          File.join(Params['backup_destination_folder'][0]['path'], 'tmp'),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          file_checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">      path = FileReceiver.destination_filename(Params['backup_destination_folder'][0]['path'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">                                               file_checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">      if File.exists?(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">        Log.warning(&quot;File already exists (#{path}) not writing.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">        @file_abort_clb.call(file_checksum) unless @file_abort_clb.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        # The file will be moved from tmp location once the transfer will be done</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        # system will use the checksum and some more unique key for tmp file name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">        FileUtils.makedirs(File.dirname(tmp_path)) unless File.directory?(File.dirname(tmp_path))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">        tmp_file = File.new(tmp_path, 'wb')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">        @streams[file_checksum] = Stream.new(file_checksum, tmp_path, tmp_file, file_size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">        $process_vars.set('Streams size', @streams.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">    # write chunk to temp file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">    def handle_new_chunk(file_checksum, offset, content)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="226">
          <span class="hits">11</span>
          
          <code class="ruby">      if offset == @streams[file_checksum].file.pos</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="227">
          <span class="hits">11</span>
          
          <code class="ruby">        FileReceiver.write_string_to_file(content, @streams[file_checksum].file)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="228">
          <span class="hits">11</span>
          
          <code class="ruby">        if Params['log_debug_level'] &gt;= 1  # added the condition here to avoid calculations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">          Log.debug1(&quot;Written already %s bytes, out of %s (%s%%)&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">                     @streams[file_checksum].file.pos, @streams[file_checksum].size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">                    100.0*@streams[file_checksum].file.size/@streams[file_checksum].size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="233">
          <span class="hits">11</span>
          
          <code class="ruby">        return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">        # Offset is wrong, send reset/resume copy from correct offset.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">        Log.warning(&quot;Received chunk with incorrect offset #{offset}, should &quot; + \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">                      &quot;be #{@streams[file_checksum].file.pos}, file_checksum:#{file_checksum}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        @reset_copy.call(file_checksum, @streams[file_checksum].file.pos) unless @reset_copy.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    # copy file to permanent location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">    # close stream</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">    # remove temp file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    # check written file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">    def handle_last_chunk(file_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      # Should always be true, unless file creation failed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">      if @streams.key?(file_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">        # Make the directory if does not exists.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">        path = FileReceiver.destination_filename(Params['backup_destination_folder'][0]['path'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">                                                 file_checksum)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">        Log.debug1(&quot;Moving tmp file %s to %s&quot;, @streams[file_checksum].path, path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">        file_dir = File.dirname(path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">        FileUtils.makedirs(file_dir) unless File.directory?(file_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">        # Move tmp file to permanent location.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">        tmp_file_path = @streams[file_checksum].path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">        Stream.close_delete_stream(file_checksum, @streams)  # temp file will be closed here</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">        local_file_checksum = FileIndexing::IndexAgent.get_checksum(tmp_file_path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">        message = &quot;Local checksum (#{local_file_checksum}) received checksum (#{file_checksum}).&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">        if local_file_checksum == file_checksum</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.debug1(message)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">            File.rename(tmp_file_path, path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">            Log.debug1(&quot;End move tmp file to permanent location %s.&quot;, path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="267">
          <span class="hits">1</span>
          
          <code class="ruby">            @file_done_clb.call(local_file_checksum, path) unless @file_done_clb.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">          rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">            Log.warning(&quot;Could not move tmp file to permanent path #{path}.&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">                        &quot; Error msg:#{e.message}\nError type:#{e.type}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">            Log.error(message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">            Log.debug1(&quot;Deleting tmp file: %s&quot;, tmp_file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">            File.delete(tmp_file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">          rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">            Log.warning(&quot;Could not delete tmp file from tmp path #{tmp_file_path}.&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">                            &quot; Error msg:#{e.message}\nError type:#{e.type}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">        Log.error(&quot;Handling last chunk and tmp stream does not exists.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.write_string_to_file(str, file)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="288">
          <span class="hits">11</span>
          
          <code class="ruby">      bytes_to_write = str.bytesize</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="289">
          <span class="hits">11</span>
          
          <code class="ruby">      Log.debug1(&quot;writing to file: %s, %s bytes.&quot;, file, bytes_to_write)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="290">
          <span class="hits">11</span>
          
          <code class="ruby">      while bytes_to_write &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="291">
          <span class="hits">11</span>
          
          <code class="ruby">        bytes_to_write -= file.write(str)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">    # Creates destination filename for backup server, input is base folder and sha1.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    # for example: folder:/mnt/hd1/bbbackup, sha1:d0be2dc421be4fcd0172e5afceea3970e2f3d940</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">    # dest filename: /mnt/hd1/bbbackup/d0/be/2d/d0be2dc421be4fcd0172e5afceea3970e2f3d940</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.destination_filename(folder, sha1)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="299">
          <span class="hits">3</span>
          
          <code class="ruby">      File.join(folder, sha1[0,2], sha1[2,2], sha1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="302">
          <span class="hits">1</span>
          
          <code class="ruby">    private :handle_new_stream, :handle_new_chunk, :handle_last_chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="782254a2b5b19787342e9321f33e0192e41b18ae">
  <div class="header">
    <h3>lib/content_server/queue_copy.rb</h3>
    <h4><span class="red">20.1 %</span> covered</h4>
    <div>
      <b>199</b> relevant lines. 
      <span class="green"><b>40</b> lines covered</span> and
      <span class="red"><b>159</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'thread'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/file_streamer'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_indexing/index_agent'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/server'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'networking/tcp'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">module ContentServer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('ack_timeout', 5, 'Timeout of ack from backup server in seconds.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('local_timeout', 60, 'Timeout of content being under copy process.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('max_copy_streams', 5, 'max contents being copied at once.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Copy message types.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  :SEND_COPY_MESSAGE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  :ACK_MESSAGE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  :COPY_MESSAGE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  :SEND_COPY_MESSAGE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  :COPY_CHUNK</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  :COPY_CHUNK_FROM_REMOTE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  :ABORT_COPY # Asks the sender to abort file copy.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  :RESET_RESUME_COPY # Sends the stream sender to resend chunk or resume from different offset.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileCopyManager</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(copy_input_queue, file_streamer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      @copy_input_queue = copy_input_queue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      @file_streamer = file_streamer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      @max_contents_under_copy = Params['max_copy_streams']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      @contents_under_copy = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      @contents_to_copy = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      @contents_to_copy_queue = Queue.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      @keeper = Mutex.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      @clean_time_out_thread = clean_time_out_thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    # Add content to copy process. If already in copy process or waiting for copy then skip.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    # If no open places for copy then put in waiting list</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_content(checksum, path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      Log.debug2(&quot;Try to add content:%s to copy waiting list&quot;, checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      @keeper.synchronize{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        # if content is being copied or waiting then skip it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        if !@contents_under_copy[checksum]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          if !@contents_to_copy[checksum]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            if @contents_under_copy.size &lt; @max_contents_under_copy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">              @contents_under_copy[checksum] = [path, false, Time.now]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">              $process_vars.set('contents under copy', @contents_under_copy.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">              @copy_input_queue.push([:SEND_ACK_MESSAGE, checksum])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">              $process_vars.set('Copy File Queue Size', @copy_input_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">              # no place in copy streams. Add to waiting list</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">              Log.debug2(&quot;add content:%s to copy waiting list&quot;, checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">              @contents_to_copy[checksum] = true  # replace with a set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">              @contents_to_copy_queue.push([checksum, path])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">              $process_vars.set('contents to copy queue', @contents_to_copy_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">            Log.debug2(&quot;content:%s already in waiting list. skipping.&quot;, checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">          Log.debug2(&quot;content:%s is being copied. skipping.&quot;, checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def receive_ack(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      @keeper.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        content_record = @contents_under_copy[checksum]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        if content_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">          if !content_record[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">            path = content_record[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">            Log.debug1(&quot;Streaming to backup server. content: %s path:%s.&quot;, checksum, path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">            @file_streamer.start_streaming(checksum, path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">            # updating Ack</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">            content_record[1] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">            Log.warning(&quot;File already received ack: %s&quot;, checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          Log.warning(&quot;File was aborted or copied: %s&quot;, checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    def remove_content(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      @keeper.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        Log.debug3(&quot;removing checksum:%s from contents under copy&quot;, checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        @contents_under_copy.delete(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        $process_vars.set('contents under copy', @contents_under_copy.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        #1 place is became available. Put another file in copy process if waiting</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        if (@contents_to_copy_queue.size &gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          new_content = @contents_to_copy_queue.pop</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">          $process_vars.set('contents to copy queue', @contents_to_copy_queue.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">          @contents_to_copy.delete(new_content[0])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">          @contents_under_copy[new_content[0]] = [new_content[1], false, Time.now]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">          $process_vars.set('contents under copy', @contents_under_copy.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          @copy_input_queue.push([:SEND_ACK_MESSAGE, new_content[0]])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">          $process_vars.set('Copy File Queue Size', @copy_input_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    # clean timed out contents</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    def clean_time_out_thread</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      @thread = Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">          sleep 10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">          @keeper.synchronize{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">            # clean timed out contents</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">            time_now = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">            new_contents_under_copy = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">            @contents_under_copy.each_key { |checksum|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">              if time_now - @contents_under_copy[checksum][2] &gt; Params['local_timeout']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">                @contents_under_copy.delete(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">                $process_vars.set('contents under copy', @contents_under_copy.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">                Log.warning(&quot;Content:#{checksum} has timed out on copy process&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">                @file_streamer.abort_streaming(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">                if (@contents_to_copy_queue.size &gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">                  new_content = @contents_to_copy_queue.pop</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">                  $process_vars.set('contents to copy queue', @contents_to_copy_queue.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">                  @contents_to_copy.delete(new_content[0])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">                  new_contents_under_copy[new_content[0]] = new_content[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">            new_contents_under_copy.each_key { |checksum|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">              @contents_under_copy[checksum.clone] = [new_contents_under_copy[checksum].clone, false, time_now]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">              $process_vars.set('contents under copy', @contents_under_copy.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">              @copy_input_queue.push([:SEND_ACK_MESSAGE, checksum])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">              $process_vars.set('Copy File Queue Size', @copy_input_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  # Simple copier, gets inputs events (files to copy), requests ack from backup to copy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  # then copies one file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileCopyServer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(copy_input_queue, port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      # Local simple tcp connection.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      @backup_tcp = Networking::TCPServer.new(port, method(:receive_message))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      @copy_input_queue = copy_input_queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      # Stores for each checksum, the file source path.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      # TODO(kolman): If there are items in copy_prepare which timeout (don't get ack),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # resend the ack request.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      @copy_prepare = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      @file_streamer = FileStreamer.new(method(:send_chunk))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      Log.debug3(&quot;initialize FileCopyServer on port:%s&quot;, port)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      @file_copy_manager = FileCopyManager.new(@copy_input_queue, @file_streamer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    def send_chunk(*arg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      @copy_input_queue.push([:COPY_CHUNK, arg])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      $process_vars.set('Copy File Queue Size', @copy_input_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">    def receive_message(addr_info, message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      # Add ack message to copy queue.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">      Log.debug2(&quot;Content server Copy message received: %s&quot;, message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      @copy_input_queue.push(message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      $process_vars.set('Copy File Queue Size', @copy_input_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">    def run()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      threads = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">      threads &lt;&lt; @backup_tcp.tcp_thread if @backup_tcp != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      threads &lt;&lt; Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        while true do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">          Log.debug1 'Waiting on copy files events.'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">          (message_type, message_content) = @copy_input_queue.pop</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">          $process_vars.set('Copy File Queue Size', @copy_input_queue.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">          Log.debug1(&quot;Content copy message:Type:%s  content:%s&quot;, message_type, message_content)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">          if message_type == :SEND_ACK_MESSAGE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">            Log.debug1(&quot;Sending ack for: %s&quot;, message_content)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">            @backup_tcp.send_obj([:ACK_MESSAGE, [message_content, Time.now.to_i]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">          elsif message_type == :COPY_MESSAGE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">            message_content.each_instance { |checksum, size, content_mod_time, instance_mod_time, server, path|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">              @file_copy_manager.add_content(checksum, path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">          elsif message_type == :ACK_MESSAGE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">            # Received ack from backup, copy file if all is good.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">            # The timestamp is of local content server! not backup server!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">            timestamp, ack, checksum = message_content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">            Log.debug1(&quot;Ack (#{ack}) received for content: #{checksum}, timestamp: #{timestamp} &quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">                       &quot;now: #{Time.now.to_i}&quot;) if Params['log_debug_level'] &gt;= 1  # adding to avoid Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">            # Copy file if ack (does not exists on backup and not too much time passed)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">            if ack</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">              if (Time.now.to_i - timestamp &lt; Params['ack_timeout'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">                @file_copy_manager.receive_ack(checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">                Log.debug1(&quot;Ack timed out span: #{Time.now.to_i - timestamp} &gt; &quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">                  &quot;timeout: #{Params['ack_timeout']}&quot;) if Params['log_debug_level'] &gt;= 1  # adding to avoid Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">                # remove only content under copy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">                @file_copy_manager.remove_content(checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">              Log.debug1('Ack is false');</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">              # remove content under copy and content in waiting list</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">              @file_copy_manager.remove_content(checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">          elsif message_type == :COPY_CHUNK_FROM_REMOTE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">            checksum = message_content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">            @file_streamer.copy_another_chuck(checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          elsif message_type == :COPY_CHUNK</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">            # We open the message here for printing info and deleting copy_prepare!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">            file_checksum, offset, file_size, content, content_checksum = message_content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">            Log.debug1(&quot;Send chunk for file %s, offset: %s &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">                         &quot;filesize: %s, checksum: %s&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">                       file_checksum, offset, file_size, content_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">            # Blocking send.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">            @backup_tcp.send_obj([:COPY_CHUNK, message_content])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">            if content.nil? and content_checksum.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">              # Sending enf of file and removing file from list</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">              @file_copy_manager.remove_content(file_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">          elsif message_type == :ABORT_COPY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">            Log.debug1(&quot;Aborting file copy: %s&quot;, message_content)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">            @file_streamer.abort_streaming(message_content)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">            # remove only content under copy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">            @file_copy_manager.remove_content(message_content)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">          elsif message_type == :RESET_RESUME_COPY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">            (file_checksum, new_offset) = message_content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">            Log.debug1(&quot;Resetting/Resuming file (%s) copy to %s&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">                       file_checksum, new_offset)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">            @file_streamer.reset_streaming(file_checksum, new_offset)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">            Log.error(&quot;Copy event not supported: #{message_type}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">          end # handle messages here</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">        Log.error(&quot;Should not reach here, loop should continue.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">  end  # class QueueCopy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileCopyClient</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(host, port)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      @local_queue = Queue.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">      @tcp_client = Networking::TCPClient.new(host, port, method(:handle_message))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">      @file_receiver = FileReceiver.new(method(:done_copy),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">                                        method(:abort_copy),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">                                        method(:reset_copy))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">      @local_thread = Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">        loop do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">          pop_data = @local_queue.pop</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">          $process_vars.set('File Copy Client queue', @local_queue.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">          handle(pop_data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">      @local_thread.abort_on_exception = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">      Log.debug3(&quot;initialize FileCopyClient  host:%s  port:%s&quot;, host, port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">    def threads</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      ret = [@local_thread]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">      ret &lt;&lt; @tcp_client.tcp_thread if @tcp_client != nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      return ret</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">    def request_copy(content_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">      handle_message([:SEND_COPY_MESSAGE, content_data])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">    def abort_copy(checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">      handle_message([:ABORT_COPY, checksum])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset_copy(checksum, new_offset)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      handle_message([:RESET_RESUME_COPY, [checksum, new_offset]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="274">
          <span class="hits">1</span>
          
          <code class="ruby">    def done_copy(local_file_checksum, local_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">      $process_vars.inc('num_files_received')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">      Log.debug1(&quot;Done copy file: path %s, checksum %s&quot;, local_path, local_file_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">    def handle_message(message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">      Log.debug3('QueueFileReceiver handle message')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">      @local_queue.push(message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">      $process_vars.set('File Copy Client queue', @local_queue.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    # This is a function which receives the messages (file or ack) and return answer in case</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    # of ack. Note that it is being executed from the class thread only!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">    def handle(message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      message_type, message_content = message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">      Log.debug1(&quot;backup copy message: Type %s. message: %s&quot;, message_type, message_content)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      if message_type == :SEND_COPY_MESSAGE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">        bytes_written = @tcp_client.send_obj([:COPY_MESSAGE, message_content])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">        Log.debug2(&quot;Sending copy message succeeded? bytes_written: %s.&quot;, bytes_written)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      elsif message_type == :COPY_CHUNK</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        if @file_receiver.receive_chunk(*message_content)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">          file_checksum, offset, file_size, content, content_checksum = message_content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">          @tcp_client.send_obj([:COPY_CHUNK_FROM_REMOTE, file_checksum])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">          file_checksum, offset, file_size, content, content_checksum = message_content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">          Log.error(&quot;receive_chunk failed for chunk checksum:#{content_checksum}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">      elsif message_type == :ACK_MESSAGE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">        checksum, timestamp = message_content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">        # check if checksum exists in final destination</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">        dest_path = FileReceiver.destination_filename(Params['backup_destination_folder'][0]['path'], checksum)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">        need_to_copy = !File.exists?(dest_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">        Log.debug1(&quot;Returning ack for content:'%s' timestamp:'%s' Ack:'%s'&quot;, checksum, timestamp, need_to_copy)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">        @tcp_client.send_obj([:ACK_MESSAGE, [timestamp,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">                                             need_to_copy,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">                                             checksum]])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">      elsif message_type == :ABORT_COPY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">        @tcp_client.send_obj([:ABORT_COPY, message_content])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">      elsif message_type == :RESET_RESUME_COPY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">        @tcp_client.send_obj([:RESET_RESUME_COPY, message_content])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">        Log.error(&quot;Unexpected message type: #{message_type}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">    # Creates destination filename for backup server, input is base folder and sha1.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">    # for example: folder:/mnt/hd1/bbbackup, sha1:d0be2dc421be4fcd0172e5afceea3970e2f3d940</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">    # dest filename: /mnt/hd1/bbbackup/d0/be/2d/d0be2dc421be4fcd0172e5afceea3970e2f3d940</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.destination_filename(folder, sha1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">      File.join(folder, sha1[0,2], sha1[2,2], sha1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">  end # class QueueFileReceiver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="11e9a41f8c8db74494ca580da49fc207dedad59d">
  <div class="header">
    <h3>lib/content_server/remote_content.rb</h3>
    <h4><span class="red">28.85 %</span> covered</h4>
    <div>
      <b>52</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'thread'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'networking/tcp'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module ContentServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('remote_content_fetch_timeout', 10, 'Remote content desired freshness in seconds.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('remote_content_save_timeout', 60*60, 'Remote content force refresh in seconds.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"># Remote content Client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # Remote Content (client) - Periodically requests remote content (content server) from Remote Content Server.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Stores locally the remote content data structure.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # Remote content client protocol based on time.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # Each n seconds it requests content from Remote Content Client connects to server (tcp/ip) and waits for request.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # remote_content_save_timeout is pre defined in config-backup_server.yml</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  class RemoteContentClient</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # initializes class variables</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # @param host [ host] host address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # @param port[ port]  port TCP/IP port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # @param local_backup_folder [local_backup_folder] pre defined folder for backup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(host, port, local_backup_folder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      @remote_tcp = Networking::TCPClient.new(host, port, method(:receive_content))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      @last_fetch_timestamp = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      @last_content_data_id = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      @content_server_content_data_path = File.join(local_backup_folder, 'remote',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">                                                    host + '_' + port.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      Log.debug3(&quot;Initialized RemoteContentClient: host:%s   port:%s  local_backup_folder:%s&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">                 host, port, local_backup_folder)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # Receives content data,  and writes it to file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    # Unchanged data will not be saved</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # @param message [Message] ContentData object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    def receive_content(message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      Log.info(&quot;Backup server received Remote content data&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      @last_fetch_timestamp = Time.now.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # Update remote content data and write to file if changed ContentData received</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      if(message.unique_id != @last_content_data_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        path = File.join(@content_server_content_data_path, @last_fetch_timestamp.to_s + '.cd')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        FileUtils.makedirs(@content_server_content_data_path) unless \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">              File.directory?(@content_server_content_data_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        $remote_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          $remote_content_data = message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">          $remote_content_data.to_file(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">          @last_content_data_id = message.unique_id   # save last content data ID</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        Log.debug1(&quot;Written content data to file:%s.&quot;, path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        Log.debug1(&quot;No need to write remote content data, it has not changed.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # Runs Remote content client</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def run()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      Log.debug1(&quot;Running remote content client.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      threads = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      threads &lt;&lt; @remote_tcp.tcp_thread if @remote_tcp != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      threads &lt;&lt; Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        loop do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          # if need content data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">          sleep_time_span = Params['remote_content_save_timeout']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          if @last_fetch_timestamp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">            sleep_time_span = Time.now.to_i - @last_fetch_timestamp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">          Log.debug1(&quot;sleep_time_span: %s&quot;, sleep_time_span)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">          if sleep_time_span &gt;= Params['remote_content_save_timeout']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">            # Send ping!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">            @remote_tcp.send_obj(nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">            Log.info(&quot;sending ping request for remote content data!&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">          sleep(sleep_time_span) if sleep_time_span &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"># Remote Content Server</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">   # Simple TCP server.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">   #It connects to server and listens to incoming requests. After receiving the request it sends local content data structure.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  class RemoteContentServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    # initializes class variables</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(port)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      @tcp_server = Networking::TCPServer.new(port, method(:content_requested))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      Log.debug3(&quot;initialize RemoteContentServer on port:%s&quot;, port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # content_requested</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # @param addr_info [addr_info] address information</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    # @param message [message] Content Data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    def content_requested(addr_info, message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      # Send response.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      Log.info(&quot;Content server received content data request&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        Log.debug1(&quot;Sending content data:%s&quot;, $local_content_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        @tcp_server.send_obj($local_content_data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      Log.info('Content server sent content data')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    # Open TCP/IP Thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    # @return [run_server] (see #run_server)run TCP server definition in tcp.rb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    def tcp_thread</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      return @tcp_server.tcp_thread if @tcp_server != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8d8a2f2e5484439ac497281b7e76c887ec86bea6">
  <div class="header">
    <h3>lib/content_server/server.rb</h3>
    <h4><span class="red">38.24 %</span> covered</h4>
    <div>
      <b>68</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>42</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'process_monitoring/thread_safe_hash'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">module ContentServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Flags combined for content and backup server.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('local_server_name', `hostname`.strip, 'local server name')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.path('tmp_path', '~/.bbfs/tmp', 'tmp path for temporary files')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.path('local_content_data_path', '', 'ContentData file path.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Monitoring</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('enable_monitoring', false, 'Whether to enable process monitoring or not.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('process_vars_delay', 3, 'pulling time of variables')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # Handling thread exceptions.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('abort_on_exception', true, 'Any exception in any thread will abort the run.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('data_flush_delay', 300, 'Number of seconds to delay content data file flush to disk.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  #using module method fot globals initialization due to the use of 'Params'.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def init_globals</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    $process_vars = ThreadSafeHash::ThreadSafeHashMonitored.new(Params['enable_monitoring'])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    $tmp_content_data_file = nil  # will be init during execution</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    $testing_memory_active = false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    $testing_memory_log = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    $indexed_file_count = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    $local_content_data = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    $local_content_data_lock = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    $remote_content_data_lock = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    $remote_content_data = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    $last_content_data_id = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def handle_program_termination(exception)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    #Write exception message to console</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    message = &quot;\nInterrupt or Exit happened in server:''.\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      &quot;Exception type:'#{exception.class}'.\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      &quot;Exception message:'#{exception.message}'.\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      &quot;Stopping process.\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      &quot;Backtrace:\n#{exception.backtrace.join(&quot;\n&quot;)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    puts(message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # Block force write to file resolving Issue 217 https://github.com/bbfsdev/bbfs/issues/217</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # force write content data to file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    #if $local_content_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">     # puts(&quot;\nForce writing local content data to #{Params['local_content_data_path']}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      #$local_content_data.to_file($tmp_content_data_file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      #File.rename($tmp_content_data_file, Params['local_content_data_path'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    #end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    #Write exception message to log and mail(if enabled)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    Log.error(message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def monitor_general_process_vars</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    objects_counters = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    objects_counters[&quot;Time&quot;] = Time.now.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    while true do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      current_objects_counters = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      sleep(Params['process_vars_delay'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      $process_vars.set('time', time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      current_objects_counters['Time'] = time.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      count = ObjectSpace.each_object(String).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      $process_vars.set('String count', count)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      current_objects_counters['String'] = count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      count = ObjectSpace.each_object(ContentData::ContentData).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      $process_vars.set('ContentData count', count)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      current_objects_counters['ContentData'] = count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      dir_count = ObjectSpace.each_object(FileMonitoring::DirStat).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      $process_vars.set('DirStat count', dir_count)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      current_objects_counters['DirStat'] = dir_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      file_count = ObjectSpace.each_object(FileMonitoring::FileStat).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      $process_vars.set('FileStat count', file_count-dir_count)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      current_objects_counters['FileStat'] = file_count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      # Generate report and update global counters</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      report = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      current_objects_counters.each_key { |type|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        objects_counters[type] = 0 unless objects_counters[type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        diff =  current_objects_counters[type] - objects_counters[type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        report += &quot;Type:#{type} raised in:#{diff}   \n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        objects_counters[type] = current_objects_counters[type]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      Log.info(&quot;MEM REPORT:\n%s\n&quot;, report)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def flush_content_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    Log.debug1('Start flush local content data to file.')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    $testing_memory_log.info('Start flush content data to file') if $testing_memory_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      local_content_data_unique_id = $local_content_data.unique_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      if (local_content_data_unique_id != $last_content_data_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        $last_content_data_id = local_content_data_unique_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        $local_content_data.to_file($tmp_content_data_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        File.rename($tmp_content_data_file, Params['local_content_data_path'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        Log.debug1('End flush local content data to file.')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        $testing_memory_log.info('End flush content data to file') if $testing_memory_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        Log.debug1('no need to flush. content data has not changed')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        $testing_memory_log.info('no need to flush. content data has not changed') if $testing_memory_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :init_globals, :handle_program_termination, :monitor_general_process_vars, :flush_content_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f408515e43349f3a03f64ece480920a79d7aa067">
  <div class="header">
    <h3>lib/file_copy/copy.rb</h3>
    <h4><span class="yellow">85.37 %</span> covered</h4>
    <div>
      <b>41</b> relevant lines. 
      <span class="green"><b>35</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'net/ssh'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'net/sftp'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module FileCopy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Creates ssh connection, assumes username and password</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # or without password but with ssh keys.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def ssh_connect(username, password, server)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="12">
          <span class="hits">4</span>
          
          <code class="ruby">    username = (username and username.length &gt; 0) ? username : ENV['USER']</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="13">
          <span class="hits">4</span>
          
          <code class="ruby">    password = (password and password.length &gt; 0) ? password : nil</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="14">
          <span class="hits">4</span>
          
          <code class="ruby">    port = 22 # 22 is a standart SSH port</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="15">
          <span class="hits">4</span>
          
          <code class="ruby">    raise &quot;Undefined server&quot; unless server</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="16">
          <span class="hits">3</span>
          
          <code class="ruby">    Log.debug1(&quot;Trying to connect(ssh): %s, %s, %s, %s.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">               username, password, server, port)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="18">
          <span class="hits">3</span>
          
          <code class="ruby">    if (username and password)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      Net::SSH.start(server, username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">                     :password =&gt; password,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                     :port =&gt; port)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="22">
          <span class="hits">3</span>
          
          <code class="ruby">    elsif (username)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">      Net::SSH.start(server, username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">                     :port =&gt; port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      raise(&quot;Undefined username&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :ssh_connect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # Simply copy map files using sftp server on dest_server.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # Note: stfp.upload support parallel uploads - default is 2.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # TODO(kolman): packing files, all, not all, determine by part of file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def sftp_copy(username, password, server, files_map)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    ssh = FileCopy.ssh_connect(username, password, server)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    ssh.sftp.connect do |sftp|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      uploads = files_map.map { |from,to|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="38">
          <span class="hits">2</span>
          
          <code class="ruby">        remote_dir = File.dirname(to)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="39">
          <span class="hits">2</span>
          
          <code class="ruby">        sftp_mkdir_recursive(sftp, File.dirname(to))</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">        Log.debug1(&quot;Copying %s to %s&quot;,from, to)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="41">
          <span class="hits">2</span>
          
          <code class="ruby">        sftp.upload(from, to)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="43">
          <span class="hits">3</span>
          
          <code class="ruby">      uploads.each { |u| u.wait }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      Log.debug1(&quot;Done.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end # ssh.sftp.connect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end # def initialize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :sftp_copy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def sftp_mkdir_recursive(sftp, path)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">    dir_stat = nil</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="51">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="52">
          <span class="hits">2</span>
          
          <code class="ruby">      Log.debug1(&quot;Stat remote dir: %s.&quot;, path)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">      dir_stat = sftp.stat!(path).directory?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">      Log.debug1(&quot;Stat result %s.&quot;, dir_stat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    rescue Net::SFTP::StatusException</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">    if !dir_stat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      Log.debug1(&quot;Directory does not exists: %s.&quot;, path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      sftp_mkdir_recursive sftp, File.dirname(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      Log.debug1(&quot;Making dir %s.&quot;, path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      response = sftp.mkdir!(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      Log.debug1(&quot;Making dir ok:%s.&quot;, response.ok?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :sftp_mkdir_recursive</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="68fa5c4c26d64d3dd140b81bd189f025b1b3fee2">
  <div class="header">
    <h3>lib/file_indexing/index_agent.rb</h3>
    <h4><span class="red">78.16 %</span> covered</h4>
    <div>
      <b>87</b> relevant lines. 
      <span class="green"><b>68</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest/sha1'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'pp'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'set'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'time'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_data'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_indexing/indexer_patterns'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">module FileIndexing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">####################</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"># Index Agent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">####################</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  class IndexAgent</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :indexed_content, :failed_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # Why are those lines needed?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    LOCALTZ = Time.now.zone</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    ENV['TZ'] = 'UTC'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="24">
          <span class="hits">3</span>
          
          <code class="ruby">      @indexed_content = ContentData::ContentData.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="25">
          <span class="hits">3</span>
          
          <code class="ruby">      @failed_files = Set.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # Calculate file checksum (SHA1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.get_checksum(filename)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="30">
          <span class="hits">22</span>
          
          <code class="ruby">      digest = Digest::SHA1.new</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="31">
          <span class="hits">22</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="32">
          <span class="hits">22</span>
          
          <code class="ruby">        File.open(filename, 'rb') { |f|</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="33">
          <span class="hits">21</span>
          
          <code class="ruby">          while buffer = f.read(65536) do</code>
        </li>
      
        <li class="covered" data-hits="127" data-linenumber="34">
          <span class="hits">127</span>
          
          <code class="ruby">            digest &lt;&lt; buffer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="37">
          <span class="hits">22</span>
          
          <code class="ruby">        Log.debug1(&quot;#{filename} sha1 #{digest.hexdigest.downcase}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="38">
          <span class="hits">22</span>
          
          <code class="ruby">        digest.hexdigest.downcase</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      rescue Errno::EACCES, Errno::ETXTBSY =&gt; exp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        Log.warning(&quot;#{exp.message}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    def IndexAgent.get_content_checksum(content)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      # Calculate checksum.</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="47">
          <span class="hits">24</span>
          
          <code class="ruby">      digest = Digest::SHA1.new</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="48">
          <span class="hits">24</span>
          
          <code class="ruby">      digest &lt;&lt; content</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="49">
          <span class="hits">24</span>
          
          <code class="ruby">      digest.hexdigest.downcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    # get all files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # satisfying the pattern</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def collect(pattern)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="55">
          <span class="hits">3</span>
          
          <code class="ruby">      Dir.glob(pattern.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # TODO(kolman): Replace this with File.lstat(file).mtime when new version of Ruby comes out.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # http://bugs.ruby-lang.org/issues/6385</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    def IndexAgent.get_correct_mtime(file)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="61">
          <span class="hits">31</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="62">
          <span class="hits">62</span>
          
          <code class="ruby">        File.open(file, 'r') { |f| f.mtime }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      rescue Errno::EACCES =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        Log.warning(&quot;Could not open file #{file} to get mtime. #{e}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        return 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    # index device according to the pattern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    # store the result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    # does not adds automatically otherDB to stored result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # TODO device support</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def index(patterns, otherDB = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      abort &quot;#{self.class}: DB not empty. Current implementation permits only one running of index&quot; \</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="75">
          <span class="hits">3</span>
          
          <code class="ruby">            unless @indexed_content.empty?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="76">
          <span class="hits">3</span>
          
          <code class="ruby">      local_server_name = `hostname`.strip</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="77">
          <span class="hits">3</span>
          
          <code class="ruby">      permit_patterns = []</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="78">
          <span class="hits">3</span>
          
          <code class="ruby">      forbid_patterns = []</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="79">
          <span class="hits">3</span>
          
          <code class="ruby">      otherDB_updated = ContentData::ContentData.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      #otherDB_table = Hash.new   # contains instances from given DB while full path name is a key and instance is a value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      #otherDB_contents = Hash.new  # given DB contents</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      # if there is a given DB then populate table with files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      # that was already indexed on this server/device</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">      if !otherDB.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">        otherDB.each_instance { |checksum, size, content_mod_time, instance_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="87">
          <span class="hits">10</span>
          
          <code class="ruby">          if (server == local_server_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">            # add instance</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="89">
          <span class="hits">10</span>
          
          <code class="ruby">            otherDB_updated.add_instance(checksum, size, server, path, instance_mod_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="94">
          <span class="hits">3</span>
          
          <code class="ruby">      permit_patterns = patterns.positive_patterns</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="95">
          <span class="hits">3</span>
          
          <code class="ruby">      forbid_patterns = patterns.negative_patterns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      # add files found by positive patterns</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="98">
          <span class="hits">3</span>
          
          <code class="ruby">      files = Array.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="99">
          <span class="hits">3</span>
          
          <code class="ruby">      permit_patterns.each_index do |i|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="100">
          <span class="hits">3</span>
          
          <code class="ruby">        files = files | (collect(permit_patterns[i]));</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="103">
          <span class="hits">3</span>
          
          <code class="ruby">      Log.debug1 &quot;Files: #{files}.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      # expand to absolute pathes</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="106">
          <span class="hits">34</span>
          
          <code class="ruby">      files.map! {|f| File.expand_path(f)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      # remove files found by negative patterns</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="109">
          <span class="hits">3</span>
          
          <code class="ruby">      forbid_patterns.each_index do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">        forbid_files = Array.new(collect(forbid_patterns[i]));</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        forbid_files.each do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          files.delete(File.expand_path(f))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      # create and add contents and instances</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="117">
          <span class="hits">3</span>
          
          <code class="ruby">      files.each do |file|</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="118">
          <span class="hits">31</span>
          
          <code class="ruby">        file_stats = File.lstat(file)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="119">
          <span class="hits">31</span>
          
          <code class="ruby">        file_mtime = IndexAgent.get_correct_mtime(file)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="120">
          <span class="hits">31</span>
          
          <code class="ruby">        device = file_stats.dev.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        # index only files</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="123">
          <span class="hits">31</span>
          
          <code class="ruby">        next if file_stats.directory?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        # add files present in the given DB to the DB and remove these files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        # from further processing (save checksum calculation)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="127">
          <span class="hits">29</span>
          
          <code class="ruby">        file_match = false</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="128">
          <span class="hits">29</span>
          
          <code class="ruby">        otherDB_updated.each_instance { |checksum, size, content_mod_time, instance_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="129">
          <span class="hits">46</span>
          
          <code class="ruby">          if otherDB_updated.instance_exists(file, local_server_name)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="130">
          <span class="hits">46</span>
          
          <code class="ruby">            if size == file_stats.size and instance_mod_time == file_mtime.to_i</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="131">
          <span class="hits">10</span>
          
          <code class="ruby">              @indexed_content.add_instance(checksum, size, server, file, instance_mod_time)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="132">
          <span class="hits">10</span>
          
          <code class="ruby">              file_match = true</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="133">
          <span class="hits">10</span>
          
          <code class="ruby">              break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="135">
          <span class="hits">36</span>
          
          <code class="ruby">              Log.warning(&quot;File (#{file}) size or modification file is different. size=#{size}  actual size=#{file_stats.size}&quot; + \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">                          &quot;   instance_mod_time=#{Time.at(instance_mod_time)}  actual=#{file_mtime}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="140">
          <span class="hits">29</span>
          
          <code class="ruby">        next if file_match</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        # calculate a checksum</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="142">
          <span class="hits">19</span>
          
          <code class="ruby">        unless (checksum = self.class.get_checksum(file))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">          Log.warning(&quot;Cheksum failure: &quot; + file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">          @failed_files.add(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="148">
          <span class="hits">19</span>
          
          <code class="ruby">        @indexed_content.add_instance(checksum, file_stats.size, local_server_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">                                      File.expand_path(file), file_mtime.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    def IndexAgent.create_shallow_instance(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      return nil unless File.exists?(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      file_stats = File.lstat(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      file_mtime = IndexAgent.get_correct_mtime(filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      # return instance shallow representation (no server)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      [file_stats.size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">       &quot;%s,%s,%s&quot; % [`hostname`.strip , file_stats.dev.to_s , File.expand_path(filename)],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">       file_mtime.to_i]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">    def IndexAgent.global_path(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      server_name = `hostname`.strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      file_stats = File.lstat(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      return &quot;%s,%s,%s&quot; % [server_name, file_stats.dev.to_s,filename]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f5924e92c65a0fd131acb5c93dbd7f68f43241d6">
  <div class="header">
    <h3>lib/file_indexing/indexer_patterns.rb</h3>
    <h4><span class="red">43.59 %</span> covered</h4>
    <div>
      <b>39</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module FileIndexing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  class IndexerPatterns</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :positive_patterns, :negative_patterns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # @param indexer_patterns_str [String]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize (indexer_patterns = nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="11">
          <span class="hits">3</span>
          
          <code class="ruby">      Log.debug1 &quot;Initialize index patterns #{indexer_patterns}.&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">      @positive_patterns = Array.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">      @negative_patterns = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # TODO add a test (including empty collections)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">      if indexer_patterns</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        indexer_patterns.positive_patterns.each do |pattern|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">          add_pattern(pattern)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        indexer_patterns.negative_patterns.each do |pattern|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">          add_pattern(pattern, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def serialize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # TODO add a test (including empty collections)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      indexer_patterns = IndexerPatternsMessage.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      positive_patterns.each do |pattern|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        indexer_patterns.positive_patterns &lt;&lt; pattern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      negative_patterns.each do |pattern|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        indexer_patterns.negative_patterns &lt;&lt; pattern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      indexer_patterns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    # @param pattern [String]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # @param is_positive [true]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # @param is_positive [false]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_pattern(pattern, is_positive = true)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="41">
          <span class="hits">3</span>
          
          <code class="ruby">      pattern.gsub!(/\\/,'/')</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">      if (is_positive)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="43">
          <span class="hits">3</span>
          
          <code class="ruby">        @positive_patterns &lt;&lt; pattern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        @negative_patterns &lt;&lt; pattern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_from_file(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      input_patterns = IO.readlines(file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        Log.debug1 &quot;Error loading patterns=%s&quot; % file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        raise IOError(&quot;Error loading patterns=%s&quot; % file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      end unless not input_patterns.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      input_patterns.each do |pattern|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        if (m = /^\s*([+-]):(.*)/.match(pattern))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">          add_pattern(m[2], m[1].eql?('+') ? true : false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        elsif (not /^\s*[\/\/|#]/.match(pattern))   # not a comment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">          Log.debug1 &quot;pattern in incorrect format: #{pattern}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          raise RuntimeError(&quot;pattern in incorrect format: #{pattern}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    def size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      return @positive_patterns.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f5554544efb6fffeb1e907cbe2ed0c1939435399">
  <div class="header">
    <h3>lib/file_monitoring.rb</h3>
    <h4><span class="red">75.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_monitoring/file_monitoring'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Daemon for monitoring directories for changes.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Paths are checked for changes per user-defined period of time.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># Directory defined changed when:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># 1. Directory structure changed, i.e. sub-directories or files were added/removed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># 2. One of the files located in the directory or one of its sub-directories was changed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"># 3. One of sub-directories changed (see 1. and 2. above)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"># File monitoring controled by following configuration parameters:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"># * &lt;tt&gt;default_monitoring_log_path&lt;/tt&gt; - holds path of file monitoring log.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#   This log containd track of changes found during monitoring</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"># * &lt;tt&gt;monitoring_paths&lt;/tt&gt; - path and file monitoring configuration data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#   regarding these paths.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">module FileMonitoring</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.path('default_monitoring_log_path', '~/.bbfs/log/file_monitoring.log',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">              'Default path for file monitoring log file. ' \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">              'This log containd track of changes found during monitoring')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.complex('monitoring_paths', [], 'Array of Hashes with 3 fields: ' \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                 'path, scan_period and stable_state.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('manual_file_changes', false, 'true, indicates to application that a set of files were ' \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    ' moved/copied we we should not index them but rather copy their hashes from contents there were copied from')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # @see FileMonitoring#monitor_files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def monitor_files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    fm = FileMonitoring.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    fm.monitor_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="36a1c9e2a4ff80e1f98ce0bca68a5960f313b010">
  <div class="header">
    <h3>lib/file_monitoring/file_monitoring.rb</h3>
    <h4><span class="red">9.57 %</span> covered</h4>
    <div>
      <b>94</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>85</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#todo: stable state not working. after 2 cycles...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'algorithms'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'fileutils'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log4r'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/server'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_monitoring/monitor_path'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">module FileMonitoring</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # Manages file monitoring of number of file system locations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileMonitoring</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # The main method. Loops on all paths, each time span and monitors them.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # =Algorithm:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # There is a loop that performs at every iteration:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    #   1.Pull entry with a minimal time of check from queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    #   2.Recursively check path taken from entry for changes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    #     a.Notify subscribed processes on changes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    #   3.Push entry to the queue with new time of next check</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # This methods controlled by &lt;tt&gt;monitoring_paths&lt;/tt&gt; configuration parameter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # that provides path and file monitoring configuration data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def monitor_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      #init log4r</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      monitoring_log_path = Params['default_monitoring_log_path']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      Log.debug1 'File monitoring log: ' + Params['default_monitoring_log_path']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      monitoring_log_dir = File.dirname(monitoring_log_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      FileUtils.mkdir_p(monitoring_log_dir) unless File.exists?(monitoring_log_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      @log4r = Log4r::Logger.new 'BBFS monitoring log'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      @log4r.trace = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      formatter = Log4r::PatternFormatter.new(:pattern =&gt; &quot;[%d] [%m]&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      #file setup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      file_config = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          &quot;filename&quot; =&gt; Params['default_monitoring_log_path'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          &quot;maxsize&quot; =&gt; Params['log_rotation_size'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          &quot;trunc&quot; =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      file_outputter = Log4r::RollingFileOutputter.new(&quot;monitor_log&quot;, file_config)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      file_outputter.level = Log4r::INFO</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      file_outputter.formatter = formatter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      @log4r.outputters &lt;&lt; file_outputter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      ::FileMonitoring::DirStat.set_log(@log4r)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">     conf_array = Params['monitoring_paths']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      # create root dirs of monitoring</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      dir_stat_array = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      conf_array.each { |elem|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        dir_stat = DirStat.new(File.expand_path(elem['path']))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        dir_stat_array.push([dir_stat, elem['stable_state']])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      #Look over loaded content data if not empty</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # If file is under monitoring path - Add to DirStat tree as stable with path,size,mod_time read from file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      # If file is NOT under monitoring path - skip (not a valid usage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      file_attr_to_checksum = {}  # This structure is used to optimize indexing when user specifies a directory was moved.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      unless $local_content_data.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        Log.info(&quot;Start build data base from loaded file. This could take several minutes&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        inst_count = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        $local_content_data.each_instance {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">            |checksum, size, _, mod_time, _, path, index_time|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">          if Params['manual_file_changes']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">            file_attr_key = [File.basename(path), size, mod_time]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">            ident_file_info = file_attr_to_checksum[file_attr_key]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">            unless ident_file_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">              #  Add file checksum to map</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">              file_attr_to_checksum[file_attr_key] = IdentFileInfo.new(checksum, index_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">              # File already in map. Need to mark as not unique</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">              ident_file_info.unique = false  # file will be skipped if found at new location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          # construct sub paths array from full file path:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          # Example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          #   instance path = /dir1/dir2/file_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">          #   Sub path 1: /dir1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          #   Sub path 2: /dir1/dir2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          #   Sub path 3: /dir1/dir2/file_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          # sub paths would create DirStat objs or FileStat(FileStat create using last sub path).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          split_path = path.split(File::SEPARATOR)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          sub_paths = (0..split_path.size-1).inject([]) { |paths, i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">            paths.push(File.join(*split_path.values_at(0..i)))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          # sub_paths holds array =&gt; [&quot;/dir1&quot;,&quot;/dir1/dir2&quot;,&quot;/dir1/dir2/file_name&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">          # Loop over monitor paths to start build tree under each</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">          dir_stat_array.each { | dir_stat|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">            # check if monitor path is one of the sub paths and find it's sub path index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">            # if index is found then it the monitor path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">            # the next index indicates the next sub path to insert to the tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">            # the index will be raised at each recursive call down the tree</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">            sub_paths_index = sub_paths.index(dir_stat[0].path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">            next if sub_paths_index.nil?  # monitor path was not found. skip this instance.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">            # monitor path was found. Add to tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">            # start the recursive call with next sub path index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">            ::FileMonitoring.stable_state = dir_stat[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">            inst_count += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">            dir_stat[0].load_instance(sub_paths, sub_paths_index+1, size, mod_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">            break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        Log.info(&quot;End build data base from loaded file. loaded instances:#{inst_count}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        $last_content_data_id = $local_content_data.unique_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        if Params['manual_file_changes']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          # -------------------------- MANUAL MODE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          # ------------ LOOP DIRS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">          dir_stat_array.each { | dir_stat|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">            log_msg = &quot;In Manual mode. Start monitor path:#{dir_stat[0].path}. moved or copied files (same name, size and time &quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">                'modification) will use the checksum of the original files and be updated in content data file'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">            Log.info(log_msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">            $testing_memory_log.info(log_msg) if $testing_memory_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">            # ------- MONITOR</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">            dir_stat[0].monitor(file_attr_to_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">            # ------- REMOVE PATHS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">            # remove non existing (not marked) files\dirs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">            log_msg = 'Start remove non existing paths'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">            Log.info(log_msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">            $testing_memory_log.info(log_msg) if $testing_memory_active</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">            dir_stat[0].removed_unmarked_paths</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">            log_msg = 'End monitor path and index'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">            Log.info(log_msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">            $testing_memory_log.info(log_msg) if $testing_memory_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">          # ------ WRITE CONTENT DATA</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          ContentServer.flush_content_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          raise(&quot;Finished manual changes and update file:#{Params['local_content_data_path']}. Exit application\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        if Params['manual_file_changes']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">          Log.info('Feature: manual_file_changes is ON. But No previous content data found. ' +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">                   'No change is required. Existing application')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">          raise('Feature: manual_file_changes is ON. But No previous content data found at ' +</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">                   &quot;file:#{Params['local_content_data_path']}. No change is required. Existing application\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      # Directories states stored in the priority queue,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      # where the key (priority) is a time when it should be checked next time.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      # Priority queue means that all entries arranged by key (time to check) in increasing order.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      pq = Containers::PriorityQueue.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      conf_array.each_with_index { |elem, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">        priority = (Time.now + elem['scan_period']).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">        #Log.info(&quot;File monitoring started for: #{elem}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">        pq.push([priority, elem, dir_stat_array[index][0]], -priority)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      while true do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        # pull entry that should be checked next,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">        # according to it's scan_period</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        time, elem, dir_stat = pq.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        # time remains to wait before directory should be checked</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">        time_span = time - Time.now.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        if (time_span &gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">          sleep(time_span)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        # Start monitor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        Log.info(&quot;Start monitor path:%s &quot;, dir_stat.path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">        $testing_memory_log.info(&quot;Start monitor path:#{dir_stat.path}&quot;) if $testing_memory_active</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">        ::FileMonitoring.stable_state=elem['stable_state']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">        dir_stat.monitor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">        # remove non existing (not marked) files\dirs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">        Log.info('Start remove non existing paths')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">        $testing_memory_log.info('Start remove non existing paths') if $testing_memory_active</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        dir_stat.removed_unmarked_paths</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        Log.info('End monitor path and index')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        $testing_memory_log.info('End monitor path and index') if $testing_memory_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        # Start index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        Log.info(&quot;Start index path:%s &quot;, dir_stat.path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        $testing_memory_log.info(&quot;Start index path:#{dir_stat.path}&quot;) if $testing_memory_active</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        dir_stat.index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        # print number of indexed files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">        Log.debug1(&quot;indexed file count:%s&quot;, $indexed_file_count)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        $testing_memory_log.info(&quot;indexed file count: #{$indexed_file_count}&quot;) if $testing_memory_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        #flush content data if changed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">        ContentServer.flush_content_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        #Add back to queue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">        priority = (Time.now + elem['scan_period']).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        pq.push([priority, elem, dir_stat], -priority)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3cbeda98f0c5c434adfde60606d3e13831006906">
  <div class="header">
    <h3>lib/file_monitoring/monitor_path.rb</h3>
    <h4><span class="red">37.95 %</span> covered</h4>
    <div>
      <b>195</b> relevant lines. 
      <span class="green"><b>74</b> lines covered</span> and
      <span class="red"><b>121</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/server'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module FileMonitoring</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  #  Path monitoring.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #  Enum-like structure that includes possible filesystem entities (files/directories) states:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # * &lt;tt&gt;NON_EXISTING&lt;/tt&gt; - Entity that was treated during previous run, but absent currently</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # * &lt;tt&gt;NEW&lt;/tt&gt; - Entity that was found and added to control during this run</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # * &lt;tt&gt;CHANGED&lt;/tt&gt; - State was changed between two checks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # * &lt;tt&gt;UNCHANGED&lt;/tt&gt; - Opposite to CHANGED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # * &lt;tt&gt;STABLE&lt;/tt&gt; - Entity is in the UNCHANGED state for a defined (by user) number of iterations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileStatEnum</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    NON_EXISTING = &quot;NON_EXISTING&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    NEW = &quot;NEW&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    CHANGED = &quot;CHANGED&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    UNCHANGED = &quot;UNCHANGED&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    STABLE = &quot;STABLE&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # Used for dir rename. Holds following info:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  #   checksum = checksum of the file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  #   index_time = index time of the file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  #   unique - if same key (file attributes) found more then once, we mark the file as not unique.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  #            This means that the file needs to be indexed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  #            In the manual changes phase, the file will be skipped.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  class IdentFileInfo</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :checksum, :index_time, :unique</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(checksum, index_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      @checksum = checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      @index_time = index_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      @unique = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # Number of iterations to move state from UNCHANGED to STABLE (for index)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  @@stable_state = 10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.stable_state=(stable_state)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    @@stable_state = stable_state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.stable_state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    @@stable_state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  public_class_method :stable_state, :stable_state=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  #  This class holds current state of file and methods to control and report changes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileStat</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :path, :state, :size, :modification_time, :marked, :cycles, :indexed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    @@digest = Digest::SHA1.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    #  Initializes new file monitoring object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    # ==== Arguments:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # * &lt;tt&gt;path&lt;/tt&gt; - File\Dir path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    # * &lt;tt&gt;state&lt;/tt&gt; - state. see class FileStatEnum. Default is NEW</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    # * &lt;tt&gt;size&lt;/tt&gt; - File size [Byte]. Default is -1 (will be set later during monitor) todo:used?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    # * &lt;tt&gt;mod_time&lt;/tt&gt; - file mod time [seconds]. Default is -1 (will be set later during monitor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    # * &lt;tt&gt;indexed&lt;/tt&gt; - Initialize file which is already indexed (used for dir rename case)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    # * &lt;tt&gt;cycles&lt;/tt&gt; - Initialize file which already passed monitor cycles (used for dir rename case)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(path, state=FileStatEnum::NEW, size=-1, mod_time=-1, indexed=false, cycles=0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # File\Dir path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      @path = path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      # File size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      @size = size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      # File modification time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      @modification_time = mod_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      # File sate. see class FileStatEnum for states.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">      @state = state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # indicates if path EXISTS in file system.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      #   If true, file will not be removed during removed_unmarked_paths phase.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">      @marked = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      # Number of times that file was monitored and not changed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      #  When @cycles exceeds ::FileMonitoring::stable_state, @state is set to Stable and can be indexed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">      @cycles = cycles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      # flag to indicate if file was indexed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">      @indexed = indexed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      if !@indexed and FileStatEnum::STABLE == @state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        #index file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        @@digest.reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">          File.open(@path, 'rb') { |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">            while buffer = f.read(16384) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">              @@digest &lt;&lt; buffer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">          $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">            $local_content_data.add_instance(@@digest.hexdigest.downcase, @size, Params['local_server_name'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">                                             @path, @modification_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">          #$process_vars.inc('indexed_files')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">          $indexed_file_count += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">          @indexed = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">          Log.warning(&quot;Indexed path'#{@path}' does not exist. Probably file changed&quot;) if @@log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    #  Checks that stored file attributes are the same as file attributes taken from file system.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    def changed?(file_stats)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      !((file_stats.size == @size) &amp;&amp;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">        (file_stats.mtime.to_i == @modification_time))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    #  Checks whether path and state are the same as of the argument</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">    def == (other)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      @path == other.path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    #  Returns path and state of the file with indentation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s (indent = 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      (&quot; &quot; * indent) + path.to_s + &quot; : &quot; + state.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">  #  This class holds current state of directory and methods to control changes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">  class DirStat</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :path, :marked</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    @@log = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.set_log (log)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">      @@log = log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    public_class_method :set_log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    #  Initializes new directory monitoring object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    # ==== Arguments:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    # * &lt;tt&gt;path&lt;/tt&gt; - Dir location</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      @path = path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">      @dirs = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">      @files = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">      @non_utf8_paths = {}  # Hash: [&quot;path&quot; -&gt; true|false]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      # indicates if path EXISTS in file system.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      #   If true, file will not be removed during removed_unmarked_paths phase.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">      @marked = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    # add instance while initializing tree using content data from file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    # Parameters:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    #   sub_paths - Array of sub paths of the instance which is added to tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    #               Example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    #                 instance path = /dir1/dir2/file_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    #                   Sub path 1: /dir1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    #                   Sub path 2: /dir1/dir2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    #                   Sub path 3: /dir1/dir2/file_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    #               sub paths would create DirStat objs or FileStat(FileStat create using last sub path).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    #   sub_paths_index - the index indicates the next sub path to insert to the tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    #                     the index will be raised at each recursive call down the tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    #   size - the instance size to insert to the tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    #   modification_time - the instance modification_time to insert to the tree</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_instance(sub_paths, sub_paths_index, size, modification_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      # initialize dirs and files. This will indicate that the current DirStat is not new.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      @dirs = {} unless @dirs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      @files = {} unless @files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      if sub_paths.size-1 == sub_paths_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        # Add File case - index points to last entry - leaf case.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        file_stat = FileStat.new(sub_paths[sub_paths_index], FileStatEnum::STABLE, size, modification_time, true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        add_file(file_stat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        # Add Dir to tree if not present. index points to new dir path.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">        dir_stat = @dirs[sub_paths[sub_paths_index]]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        #create new dir if not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        unless dir_stat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">          dir_stat = DirStat.new(sub_paths[sub_paths_index])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          add_dir(dir_stat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        # continue recursive call on tree with next sub path index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        dir_stat.load_instance(sub_paths, sub_paths_index+1, size, modification_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    #  Adds directory for monitoring.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_dir (dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      @dirs[dir.path] = dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    #  Adds file for monitoring.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_file (file)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">      @files[file.path] = file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    #  Removes directory from monitoring.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">    def rm_dir(dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      @dirs.delete(dir.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    #  Removes file from monitoring.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">    def rm_file(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      @files.delete(file.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    #  Checks that there is a sub-folder with a given path.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_dir?(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">      @dirs.has_key?(path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    #  Checks that there is a file with a given path.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_file?(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">      @files.has_key?(path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    #  Returns string which contains path and state of this directory as well as it's structure.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s(indent = 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">      indent_increment = 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">      child_indent = indent + indent_increment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">      res = super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      @files.each_value do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">        res += &quot;\n&quot; + file.to_s(child_indent)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">      end if @files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      @dirs.each_value do |dir|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">        res += &quot;\n&quot; + dir.to_s(child_indent)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">      end if @dirs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">      res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    # Recursively, remove non existing files and dirs in Tree</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">    def removed_unmarked_paths</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      #remove dirs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">      dirs_enum = @dirs.each_value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      loop do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">        dir_stat = dirs_enum.next rescue break</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">        if dir_stat.marked</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">          dir_stat.marked = false  # unset flag for next monitoring\index\remove phase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">          #recursive call</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">          dir_stat.removed_unmarked_paths</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">          # directory is not marked. Remove it, since it does not exist.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">          if @@log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">            @@log.info(&quot;NON_EXISTING dir: &quot; + dir_stat.path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">            @@log.outputters[0].flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">          # remove file with changed checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">          $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">            $local_content_data.remove_directory(dir_stat.path, Params['local_server_name'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">          rm_dir(dir_stat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">      #remove files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">      files_enum = @files.each_value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">      loop do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">        file_stat = files_enum.next rescue break</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">        if file_stat.marked</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">          file_stat.marked = false  # unset flag for next monitoring\index\remove phase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">          # file not marked meaning it is no longer exist. Remove.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">          if @@log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">            @@log.info(&quot;NON_EXISTING file: &quot; + file_stat.path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">            @@log.outputters[0].flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">          # remove file with changed checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">          $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">            $local_content_data.remove_instance(Params['local_server_name'], file_stat.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">          # remove from tree</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">          @files.delete(file_stat.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">    # Recursively, read files and dirs from file system (using Glob)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    # Handle new files\dirs.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">    # Change state for existing files\dirs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    # Index stable files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    # Remove non existing files\dirs is handled in method: remove_unmarked_paths</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">    def monitor(file_attr_to_checksum=nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      # Algorithm:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      # assume that current dir is present</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      # ls (glob) the dir path for child dirs and files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      # if child file is not already present, add it as new, mark it and handle its state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      # if file already present, mark it and handle its state.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">      # if child dir is not already present, add it as new, mark it and propagates</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">      #    the recursive call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">      # if child dir already present, mark it and handle its state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">      # marked files will not be remove in next remove phase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">      # ls (glob) the dir path for child dirs and files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="300">
          <span class="hits">1</span>
          
          <code class="ruby">      globed_paths_enum = Dir.glob(@path + &quot;/*&quot;).to_enum</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="301">
          <span class="hits">1</span>
          
          <code class="ruby">      loop do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="302">
          <span class="hits">3</span>
          
          <code class="ruby">        globed_path = globed_paths_enum.next rescue break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">        # if symlink - skip</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="305">
          <span class="hits">2</span>
          
          <code class="ruby">        next if File.symlink?(globed_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">        # UTF-8 - keep only files with names in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="308">
          <span class="hits">1</span>
          
          <code class="ruby">        next if @non_utf8_paths[globed_path]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">        check_utf_8_encoding_file = globed_path.clone</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="310">
          <span class="hits">1</span>
          
          <code class="ruby">        unless check_utf_8_encoding_file.force_encoding(&quot;UTF-8&quot;).valid_encoding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">          Log.warning(&quot;Non UTF-8 file name '#{check_utf_8_encoding_file}', skipping.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">          @non_utf8_paths[globed_path]=true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">          check_utf_8_encoding_file=nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">        # Get File \ Dir status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="318">
          <span class="hits">1</span>
          
          <code class="ruby">        globed_path_stat = File.lstat(globed_path) rescue next  # File or dir removed from OS file system</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">        if globed_path_stat.file?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">          # ----------------------------- FILE -----------------------</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="321">
          <span class="hits">1</span>
          
          <code class="ruby">          child_stat = @files[globed_path]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">          if child_stat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">            # -------------- EXISTS in Tree</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">            unless Params['manual_file_changes']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">              # --------- NON MANUAL MODE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">              child_stat.marked = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">              if child_stat.changed?(globed_path_stat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">                # ---------- STATUS CHANGED</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">                # Update changed status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">                child_stat.state = FileStatEnum::CHANGED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">                child_stat.cycles = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">                child_stat.size = globed_path_stat.size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">                child_stat.modification_time = globed_path_stat.mtime.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">                if @@log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">                  @@log.info(&quot;CHANGED file: &quot; + globed_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">                  @@log.outputters[0].flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">                # remove file with changed checksum. File will be added once indexed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">                $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">                  $local_content_data.remove_instance(Params['local_server_name'], globed_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">              else  # case child_stat did not change</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">                # ---------- SAME STATUS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">                # File status is the same</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">                if child_stat.state != FileStatEnum::STABLE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">                  child_stat.state = FileStatEnum::UNCHANGED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">                  child_stat.cycles += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">                  if child_stat.cycles &gt;= ::FileMonitoring.stable_state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">                    child_stat.state = FileStatEnum::STABLE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">                    if @@log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">                      @@log.info(&quot;STABLE file: &quot; + globed_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">                      @@log.outputters[0].flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">                    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">                  else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">                    if @@log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">                      @@log.info(&quot;UNCHANGED file: &quot; + globed_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">                      @@log.outputters[0].flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">                    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">            else  # case Params['manual_file_changes']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">              # --------- MANUAL MODE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">              child_stat.marked = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">            # ---------------------------- NEW FILE ----------</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">            unless Params['manual_file_changes']</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="369">
          <span class="hits">1</span>
          
          <code class="ruby">              child_stat = FileStat.new(globed_path,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">                                        FileStatEnum::NEW,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">                                        globed_path_stat.size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">                                        globed_path_stat.mtime.to_i)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="373">
          <span class="hits">1</span>
          
          <code class="ruby">              if @@log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">                @@log.info(&quot;NEW file: &quot; + globed_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">                @@log.outputters[0].flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="377">
          <span class="hits">1</span>
          
          <code class="ruby">              child_stat.marked = true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="378">
          <span class="hits">1</span>
          
          <code class="ruby">              add_file(child_stat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">            else  # case Params['manual_file_changes']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">              # --------------------- MANUAL MODE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">              # check if file name and attributes exist in global file attr map</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">              file_attr_key = [File.basename(globed_path), globed_path_stat.size, globed_path_stat.mtime.to_i]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">              file_ident_info = file_attr_to_checksum[file_attr_key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">              # If not found (real new file) or found but not unique then file needs indexing. skip in manual mode.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">              next unless (file_ident_info and file_ident_info.unique)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">              Log.debug1(&quot;update content data with file:%s  checksum:%s  index_time:%s&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">                         File.basename(globed_path), file_ident_info.checksum, file_ident_info.index_time.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">              # update content data (no need to update Dir tree)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">              $local_content_data_lock.synchronize{</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">                $local_content_data.add_instance(file_ident_info.checksum,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">                                                 globed_path_stat.size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">                                                 Params['local_server_name'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">                                                 globed_path,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">                                                 globed_path_stat.mtime.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">                                                 file_ident_info.index_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">          # ------------------------------ DIR -----------------------</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">          child_stat = @dirs[globed_path]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">          unless child_stat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">            # ----------- ADD NEW DIR</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">            child_stat = DirStat.new(globed_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">            add_dir(child_stat)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">            if @@log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">              @@log.info(&quot;NEW dir: &quot; + globed_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">              @@log.outputters[0].flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">          child_stat.marked = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">          # recursive call for dirs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">          child_stat.monitor(file_attr_to_checksum)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="416">
          <span class="hits">1</span>
          
          <code class="ruby">      GC.start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="419">
          <span class="hits">1</span>
          
          <code class="ruby">    def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">      files_enum = @files.each_value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">      index_counter = $indexed_file_count  # to check if files where actually indexed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">      loop do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">        file_stat = files_enum.next rescue break</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">        file_stat.index  # file index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">      GC.start if index_counter != $indexed_file_count  # GC only if files where indexed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">      dirs_enum = @dirs.each_value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">      loop do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">        dir_stat = dirs_enum.next rescue break</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">        dir_stat.index  # dir recursive call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="435">
          <span class="hits">1</span>
          
          <code class="ruby">    protected :add_dir, :add_file, :rm_dir, :rm_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ec8ca6f408fe919eb543519dfc2cc334aba3847d">
  <div class="header">
    <h3>lib/file_utils/file_generator/file_generator.rb</h3>
    <h4><span class="yellow">89.33 %</span> covered</h4>
    <div>
      <b>75</b> relevant lines. 
      <span class="green"><b>67</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Author: Slava Pasechnik (slavapas13@gmail.com)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Run from bbfs&gt; file_utils generate_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'fileutils'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'yaml'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">module FileGenerator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.path('target_path', '~/.bbfs/test_files', 'Represents the target path for files generation')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('is_clear_target_path', false, 'Should files and directories already presented in target path be removed')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('file_name_prefix', 'auto_generated_file_4_backup_server',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">                'Represents the file name template for generated file')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('dir_name_prefix', 'test_dir_4_backup_server',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">                'Represents the directory name template for generated file')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('file_size_in_bytes', 500,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">                 'Represents the required file size in bytes. Not relevant if random calculation is triggered')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('total_created_directories', -1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                 'Represents the total created directories. Use any negative value or zero for Infinity.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                      Not relevant if random calculation is triggered')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('max_total_files', 0, 'Maximum number of files to generate, 0 for no limit.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('total_files_in_dir', 10,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">                 'Represents the total files in directory. Use any negative value or zero for Infinity')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.float('sleep_time_in_seconds', 10, 'Represents the sleeping time for generation files')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.float('upper_size_in_bytes', 500, 'Represents the upper limit file size in MB for random size calculation')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.float('down_size_in_bytes', 50, 'Represents the Lower limit file size in MB for random size calculation')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('lower_limit_4_files_in_dir', 10,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">                 'Represents the Lower limit for total files in directory for random calculation')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('upper_limit_4_files_in_dir', 20,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">                 'Represents the Upper limit for total files in directory for random calculation')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('is_tot_files_in_dir_random', true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">                 'Indicates that total files in a directory will be calculated randomly.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('is_use_random_size', true, 'Indicates that file size will be calculated randomly.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  #Generates files with random content with random file size according to the given Params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileGenerator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :one_bytes_string</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    FILE_EXT = 'txt'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    #Gets one MB string</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    def one_bytes_string</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      @one_bytes_string ||= prepare_one_bytes_string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    #Gets the some random string</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_small_rand_unique_str</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="49">
          <span class="hits">15</span>
          
          <code class="ruby">      rand(36**8).to_s(36)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    #Gets the unique name according to current time and random string</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_unique_name</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="54">
          <span class="hits">15</span>
          
          <code class="ruby">      &quot;#{Time.new.to_i}_#{get_small_rand_unique_str}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    #Gets the random letter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_random_letter</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="59">
          <span class="hits">20</span>
          
          <code class="ruby">      (rand(122-97) + 97).chr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    #Gets the new directory name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_new_directory_name</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="64">
          <span class="hits">5</span>
          
          <code class="ruby">      &quot;#{Params['dir_name_prefix']}_#{get_unique_name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    #Gets the new file name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_new_file_name</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="69">
          <span class="hits">10</span>
          
          <code class="ruby">      &quot;#{Params['file_name_prefix']}_#{get_unique_name}.#{FILE_EXT}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    #Gets the required file size im MB</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_file_bytes_size</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="74">
          <span class="hits">2</span>
          
          <code class="ruby">      if Params['is_use_random_size']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        rand(Params['upper_size_in_bytes'] - Params['down_size_in_bytes']) +</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">            Params['down_size_in_bytes']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="78">
          <span class="hits">2</span>
          
          <code class="ruby">        Params['file_size_in_bytes']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    #Generates one MB string with random content</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    def prepare_one_bytes_string</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      get_random_letter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    #Determines whether to generate new directory or not</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    def is_generate_dir(dir_counter, total_file_counter)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="89">
          <span class="hits">10</span>
          
          <code class="ruby">      if Params['max_total_files'] &gt; 0 &amp;&amp; total_file_counter &gt; Params['max_total_files']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      if Params['total_created_directories'] &lt; 1 || #Any negative value or zero will be indication for Infinity</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="94">
          <span class="hits">10</span>
          
          <code class="ruby">          dir_counter &lt; Params['total_created_directories'] then</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="95">
          <span class="hits">5</span>
          
          <code class="ruby">        return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="97">
          <span class="hits">5</span>
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    #Determines whether to generate new file or not</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    def is_generate_file(file_counter, total_file_counter)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="103">
          <span class="hits">15</span>
          
          <code class="ruby">      if Params['max_total_files'] &gt; 0 &amp;&amp; total_file_counter &gt; Params['max_total_files']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="107">
          <span class="hits">15</span>
          
          <code class="ruby">      total_files_in_dir = Params['total_files_in_dir']</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="108">
          <span class="hits">15</span>
          
          <code class="ruby">      if file_counter == 0 &amp;&amp; Params['is_tot_files_in_dir_random']  then</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        total_files_in_dir =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">            rand(Params['upper_limit_4_files_in_dir'] -</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">                     Params['lower_limit_4_files_in_dir']) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">                Params['lower_limit_4_files_in_dir']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      #When total_files_in_dir &lt; 1 it will be treated as unlimited files creation in directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      if total_files_in_dir &lt; 1 ||</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="117">
          <span class="hits">15</span>
          
          <code class="ruby">          file_counter &lt; total_files_in_dir then</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="118">
          <span class="hits">10</span>
          
          <code class="ruby">        return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="120">
          <span class="hits">5</span>
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    #Generates files with random content with random file size according to the given Params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    def run</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="126">
          <span class="hits">5</span>
          
          <code class="ruby">      dir_counter = 0</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="127">
          <span class="hits">5</span>
          
          <code class="ruby">      total_file_count = 0</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="128">
          <span class="hits">5</span>
          
          <code class="ruby">      if Params['is_clear_target_path']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        target_path_all_regexp = File.expand_path(File.join(Params['target_path'], '*'))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        Dir[target_path_all_regexp].each {|file| FileUtils.rm_rf file}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="132">
          <span class="hits">5</span>
          
          <code class="ruby">      while is_generate_dir dir_counter, total_file_count</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="133">
          <span class="hits">5</span>
          
          <code class="ruby">        new_dir_name = File.expand_path(File.join Params['target_path'], get_new_directory_name)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="134">
          <span class="hits">5</span>
          
          <code class="ruby">        ::FileUtils.mkdir_p new_dir_name unless File.directory?(new_dir_name)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="135">
          <span class="hits">5</span>
          
          <code class="ruby">        dir_counter += 1</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="136">
          <span class="hits">5</span>
          
          <code class="ruby">        file_counter = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="138">
          <span class="hits">5</span>
          
          <code class="ruby">        while is_generate_file file_counter, total_file_count</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="139">
          <span class="hits">10</span>
          
          <code class="ruby">          new_file_name = get_new_file_name</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="140">
          <span class="hits">10</span>
          
          <code class="ruby">          File.open(File.join(new_dir_name, new_file_name), &quot;w&quot;) do |f|</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="141">
          <span class="hits">22</span>
          
          <code class="ruby">            get_file_bytes_size.to_i.times { f.write(get_random_letter) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="143">
          <span class="hits">10</span>
          
          <code class="ruby">          file_counter += 1</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="144">
          <span class="hits">10</span>
          
          <code class="ruby">          total_file_count += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="146">
          <span class="hits">10</span>
          
          <code class="ruby">          sleep Params['sleep_time_in_seconds'] if Params['sleep_time_in_seconds'] &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">end # module FileGenerator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b731d5059dbc28455931ed65efa31468652d2efc">
  <div class="header">
    <h3>lib/file_utils/file_utils.rb</h3>
    <h4><span class="red">34.55 %</span> covered</h4>
    <div>
      <b>165</b> relevant lines. 
      <span class="green"><b>57</b> lines covered</span> and
      <span class="red"><b>108</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Author:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># originator: Kolman Vornovizky (kolmanv@gmail.com)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># update: Alexey Nemytov (alexeyn66@gmail.com) 31/07/2012</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># This file is the consist utility functionality for BBFS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># Such as automatic file generation, symlink, etc.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># Run from bbfs&gt; ruby -Ilib bin/file_utils --command=generate_files --log_write_to_console=true --log_debug_level=3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_data'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_indexing'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_utils'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_utils/file_generator/file_generator'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">module FileUtils</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'command', nil ,'path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'ref_cd', nil ,'reference path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'base_cd', nil ,'base path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'dest', nil ,'destination path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'dest_server', nil ,'server name'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'patterns', nil ,'patterns path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'cd', nil ,'path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'cd_a', nil ,'a path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'cd_b', nil ,'b path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'cd_out', nil ,'output path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'cd_in', nil ,'input path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string 'exist_cd', nil, 'exist_path'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  #Params.string 'config_file', 'path' ,'configuration file path'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  class FileUtils</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    def FileUtils.run</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      if Params['command'] == 'mksymlink'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        if Params['ref_cd'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          Log.error (&quot;--ref_cd is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        ref_cd = ContentData.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        ref_cd.from_file(Params['ref_cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        if ref_cd.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          Log.error (&quot;Error loading content data ref_cd=%s&quot; % Params['ref_cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        if Params['base_cd'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">          Log.error (&quot;--base_cd is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        base_cd = ContentData.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        base_cd.from_file(Params['base_cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        if base_cd.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          Log.error (&quot;Error loading content data base_cd=%s&quot; % Params['base_cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        if Params['dest'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          Log.error (&quot;--dest is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        not_found = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          not_found = FileUtil.mksymlink(ref_cd, base_cd, Params['dest'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        rescue NotImplementedError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">          Log.error (&quot;symlinks are unimplemented on this machine&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        return not_found</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      elsif (Params['command'] == &quot;merge&quot; or</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">          Params['command'] == &quot;intersect&quot; or</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          Params['command'] == &quot;minus&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        if Params['cd_a'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">          Log.error (&quot;--cd_a is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        cd_a = ContentData.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        cd_a.from_file(Params['cd_a'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        if cd_a.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          Log.error (&quot;Error loading content data cd_a=%s&quot; % Params['cd_a'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        if Params['cd_b'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">          Log.error (&quot;--cd_b is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        cd_b = ContentData.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        cd_b.from_file(Params['cd_b'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        if cd_b.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">          Log.error (&quot;Error loading content data cd_b=%s&quot; % Params['cd_b'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        if Params['cd_b'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">          Log.error (&quot;--dest is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        output = FileUtil.contet_data_command(Params['command'], cd_a, cd_b, Params['dest'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      elsif Params['command'] == 'unify_time'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        if  Params['cd'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">          Log.error (&quot;--cd is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        cd = ContentData.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        cd.from_file(Params['cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        if cd.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">          Log.error (&quot;Error loading content data cd=%s&quot; % Params['cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        output = unify_time(cd)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        # indexer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      elsif Params['command'] == 'indexer'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">        if Params['patterns'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">          Log.error (&quot;--patterns is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        patterns = FileIndexing::IndexerPatterns.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">        Params['patterns'].split(':').each { |pattern|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          Log.debug1 &quot;Pattern: #{pattern}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">          patterns.add_pattern File.expand_path(pattern)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">        unless patterns.size &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">          Log.error (&quot;Error loading patterns=%s (empty file)&quot; % Params['patterns'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">        exist_cd = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        if not Params['exist_cd'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          exist_cd = ContentData::ContentData.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          exist_cd.from_file(Params['exist_cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          if exist_cd.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">            Log.error (&quot;Error loading content data exist_cd=%s&quot; % Params['exist_cd'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">            return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">        indexer = FileIndexing::IndexAgent.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">        indexer.index(patterns, exist_cd)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        Log.debug1 indexer.indexed_content.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        # crawler</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      elsif Params['command'] == 'crawler'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        if Params['conf_file'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">          Log.error (&quot;--conf_file is not set&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">        if not File.exists?(Params['conf_file'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">          Log.error (&quot;config file doesn't exist conf_file=%s&quot; % Params['conf_file'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">        if Params['cd_out'].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">          time = Tme.now.utc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">          Params['cd_out'] = &quot;crawler.out.#{time.strftime('%Y/%m/%d_%H-%M-%S')}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        unless (Params['cd_in'].nil?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">          if not File.exists?(Params['conf_file'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">            Log.error (&quot;input data file doesn't exist cd_in=%s&quot; % Params['cd_in'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">            return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">        conf = Configuration.new(Params['conf_file'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        threads = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">        conf.server_conf_vec.each do |server|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">          threads.push(Thread.new { Crawler.new(server, Params['cd_out'], Params['cd_in']) })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">        threads.each { |a| a.join }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">        join_servers_results(conf.server_conf_vec, Params['cd_out'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      elsif Params['command'] == 'generate_files'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        fg = FileGenerator::FileGenerator.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">        fg.run()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.contet_data_command(command, cd_a, cd_b, dest_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      dest = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      if command == &quot;merge&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        dest = ContentData.merge(cd_a, cd_b)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      elsif command == &quot;intersect&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        dest = ContentData.intersect(cd_a, cd_b)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      elsif command == &quot;minus&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">        dest = ContentData.remove(cd_b, cd_a)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      if dest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">        dest.to_file(dest_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">    # Unify modification/first_appearance time according to input DB</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    # Input: ContentData</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    # Output: ContentData with unified times</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    #         Files modification time attribute physically updated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    # Assumption: Files in the input db are from this device.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    #             There is no check what device they are belong - only the check of server name.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    #             It is a user responsibility (meanwhile) to provide a correct input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    #             If file has a modification time attribute that doesn't present in the input db,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      #             then the assumption is that this file wasnt indexized and it will not be treated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      #             (e.i. we do nothing with it)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.unify_time(content_data)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">        orig_content_data = ContentData::ContentData.new(content_data)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">        content_data.unify_time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">        content_data.each_instance { |checksum, size, content_mod_time, unified_inst_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="207">
          <span class="hits">10</span>
          
          <code class="ruby">          location = [server, path]</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="208">
          <span class="hits">10</span>
          
          <code class="ruby">          orig_inst_mod_time = orig_content_data.get_instance_mod_time(checksum, location)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="209">
          <span class="hits">20</span>
          
          <code class="ruby">          file_mtime, file_size = File.open(path) { |f| [f.mtime, f.size] }</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="210">
          <span class="hits">10</span>
          
          <code class="ruby">          Log.debug1 &quot;file:#{path} file_mtime:#{file_mtime}.&quot;</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="211">
          <span class="hits">10</span>
          
          <code class="ruby">          Log.debug1 &quot;update mtime:#{unified_inst_mod_time}&quot;</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="212">
          <span class="hits">10</span>
          
          <code class="ruby">          Log.debug1 &quot;original instance mtime:#{orig_inst_mod_time}.&quot;</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="213">
          <span class="hits">10</span>
          
          <code class="ruby">          Log.debug1 &quot;unify instance mtime:#{unified_inst_mod_time}.&quot;</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="214">
          <span class="hits">10</span>
          
          <code class="ruby">          Log.debug1 &quot;Comparison: Real file = unified? #{file_mtime.to_i == unified_inst_mod_time}&quot;</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="215">
          <span class="hits">10</span>
          
          <code class="ruby">          if (file_mtime.to_i == orig_inst_mod_time) \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">                and file_size == size \</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="217">
          <span class="hits">20</span>
          
          <code class="ruby">                and (file_mtime.to_i != unified_inst_mod_time)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="218">
          <span class="hits">6</span>
          
          <code class="ruby">            Log.debug1 (&quot;Comparison results: File actual time is same as instance time before unification. Need to modify file time&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="219">
          <span class="hits">6</span>
          
          <code class="ruby">            File.utime(File.atime(path), unified_inst_mod_time, path)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="220">
          <span class="hits">12</span>
          
          <code class="ruby">            file_mtime = File.open(path) { |f| f.mtime }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="221">
          <span class="hits">6</span>
          
          <code class="ruby">            Log.debug1 &quot;new file mtime:#{file_mtime}.&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="222">
          <span class="hits">6</span>
          
          <code class="ruby">            Log.debug1 &quot;new file mtime in seconds:#{file_mtime.to_i}.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">        content_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      # Creates directory structure and symlinks with ref_cd structure to the base_cd files and dest as a root dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      # Parameters: ref_cd [ContentData]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      #             base_cd [ContentData]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      #             dest [String]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      # Output: ContentData object consists of contents/instances from ref_cd that have no target in base_cd</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.mksymlink(ref_cd, base_cd, dest)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">        # symlinks are not implemented in Windows</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">        raise NotImplementedError.new if (RUBY_PLATFORM =~ /mingw/ or RUBY_PLATFORM =~ /ms/ or RUBY_PLATFORM =~ /win/)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">        not_found = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">        not_found_cd = ContentData::ContentData.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">        warnings = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">        dest.chop! if (dest.end_with?(&quot;/&quot;) or dest.end_with?(&quot;\\&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">        ref_cd.each_instance { |checksum, size, content_mod_time, inst_mod_time, server, path|</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="244">
          <span class="hits">7</span>
          
          <code class="ruby">          if base_cd.content_exists(checksum)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="245">
          <span class="hits">6</span>
          
          <code class="ruby">            symlink_path = dest + path</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="246">
          <span class="hits">6</span>
          
          <code class="ruby">            ::FileUtils.mkdir_p(File.dirname(symlink_path)) unless (Dir.exists?(File.dirname(symlink_path)))</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="247">
          <span class="hits">6</span>
          
          <code class="ruby">            File.symlink(path, symlink_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">            # add instance to not_found cd</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">            not_found_cd.add_instance(checksum, size, server, path, inst_mod_time)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">            warnings &lt;&lt; &quot;Warning: base content does not contains:'%s'\n&quot; % checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">        Log.warning (warnings)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">        not_found_cd</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5b091471b5758ed5694d3f9c544a30c0265eebe2">
  <div class="header">
    <h3>lib/log.rb</h3>
    <h4><span class="red">63.64 %</span> covered</h4>
    <div>
      <b>88</b> relevant lines. 
      <span class="green"><b>56</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Author: Yaron Dror (yaron.dror.bb@gmail.com)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Description: The file contains the code which implements the 'Log' module</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Run: Add to 'require' list. Execute Log.init</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#require 'email'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log4r'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log4r/outputter/emailoutputter'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"># Module: Log.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"># Abstruct: The Log is used to log info\warning\error\debug messages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#           This module is actually a wrapper to log4r gem and serves</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#           as a central code to use the log utility.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">module Log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # Global params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('log_debug_level', 0 , \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      'Verbosity of logging. 0 will log only INFO messages. Other value, will log all DEBUG messages as well.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('log_flush_each_message', true, \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      'If true then File and Console outputters will be flushed for each message.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('log_write_to_file', true , \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      'If true then the logger will write the messages to a file.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.path('log_file_name', &quot;~/.bbfs/log/#{File.basename($PROGRAM_NAME)}.log4r&quot; , \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      'log file name: ~/.bbfs/log/&lt;executable_name&gt;.log')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('log_rotation_size',1000000 , \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      'max log file size. when reaching this size, a new file is created for rest of log')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('log_write_to_console', false , \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      'If true then the logger will write the messages to the console.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('log_write_to_email', false , \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      'If true then the logger will write the error and fatal messages to email.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('from_email', 'bbfsdev@gmail.com', 'From gmail address for update.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('from_email_password', '', 'From gmail password.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('to_email', 'bbfsdev@gmail.com', 'Destination email for updates.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  #Should be called from executable right after params handling.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # Init Log level and set output to file,stdout and email according to configuration params.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.init</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="39">
          <span class="hits">5</span>
          
          <code class="ruby">    @log4r = Log4r::Logger.new 'BBFS log'</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="40">
          <span class="hits">5</span>
          
          <code class="ruby">    @log4r.trace = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    #levels setup</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="43">
          <span class="hits">5</span>
          
          <code class="ruby">    log4r_level = Log4r::DEBUG</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="44">
          <span class="hits">5</span>
          
          <code class="ruby">    log4r_level = Log4r::INFO if 0 == Params['log_debug_level']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    #formatters</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="47">
          <span class="hits">5</span>
          
          <code class="ruby">    formatter = Log4r::PatternFormatter.new(:pattern =&gt; &quot;[%l] [%d] [%m]&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    #stdout setup</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="50">
          <span class="hits">5</span>
          
          <code class="ruby">    if Params['log_write_to_console']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      stdout_outputter = Log4r::Outputter.stdout</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      stdout_outputter.formatter = formatter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      stdout_outputter.level = log4r_level</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      @log4r.outputters &lt;&lt; stdout_outputter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    #file setup</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="58">
          <span class="hits">5</span>
          
          <code class="ruby">    if Params['log_write_to_file']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      if File.exist?(Params['log_file_name'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        File.delete(Params['log_file_name'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        dir_name = File.dirname(Params['log_file_name'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        FileUtils.mkdir_p(dir_name) unless File.directory?(dir_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      file_config = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          &quot;filename&quot; =&gt; Params['log_file_name'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          &quot;maxsize&quot; =&gt; Params['log_rotation_size'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          &quot;trunc&quot; =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      file_outputter = Log4r::RollingFileOutputter.new(&quot;file_log&quot;, file_config)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      file_outputter.level = log4r_level</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      file_outputter.formatter = formatter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      @log4r.outputters &lt;&lt; file_outputter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    #email setup</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="77">
          <span class="hits">5</span>
          
          <code class="ruby">    if Params['log_write_to_email']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      email_outputter = Log4r::EmailOutputter.new('email_log',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">                                                  :server =&gt; 'smtp.gmail.com',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">                                                  :port =&gt; 587,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">                                                  :subject =&gt; &quot;Error happened at server:'#{Params['local_server_name']}' run by #{ENV['USER']}. Service_name is #{Params['service_name']}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">                                                  :acct =&gt; Params['from_email'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">                                                  :from =&gt; Params['from_email'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">                                                  :passwd =&gt; Params['from_email_password'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">                                                  :to =&gt; Params['to_email'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">                                                  :immediate_at =&gt; 'FATAL,ERROR',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">                                                  :authtype =&gt; :plain,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">                                                  :tls =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">                                                  :formatfirst =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">                                                  :buffsize =&gt; 9999,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      email_outputter.level = Log4r::ERROR</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      email_outputter.formatter = formatter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      @log4r.outputters &lt;&lt; email_outputter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    # Write init message and user parameters</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="98">
          <span class="hits">5</span>
          
          <code class="ruby">    @log4r.info('BBFS Log initialized.') # log first data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    # print params to console</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="101">
          <span class="hits">5</span>
          
          <code class="ruby">    if Params['print_params_to_stdout']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">      Params.get_init_info_messages().each { |msg|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        puts(msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="106">
          <span class="hits">5</span>
          
          <code class="ruby">      Log.info(&quot;Not printing executable parameters to console since param:'print_params_to_stdout' is false&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    #print params to log info and warning</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="109">
          <span class="hits">5</span>
          
          <code class="ruby">    Params.get_init_info_messages().each { |msg|</code>
        </li>
      
        <li class="covered" data-hits="315" data-linenumber="110">
          <span class="hits">315</span>
          
          <code class="ruby">      Log.info(msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="112">
          <span class="hits">5</span>
          
          <code class="ruby">    Params.get_init_warning_messages().each { |msg|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="113">
          <span class="hits">5</span>
          
          <code class="ruby">      Log.warning(msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  # Auxiliary method to add the calling method to the message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.msg_with_caller(msg)</code>
        </li>
      
        <li class="covered" data-hits="409" data-linenumber="119">
          <span class="hits">409</span>
          
          <code class="ruby">    /([a-zA-Z0-9\-_\.]+:\d+)/ =~ caller[1]</code>
        </li>
      
        <li class="covered" data-hits="409" data-linenumber="120">
          <span class="hits">409</span>
          
          <code class="ruby">    $1 + ':' + msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  # Log warning massages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.warning(msg)</code>
        </li>
      
        <li class="covered" data-hits="59" data-linenumber="125">
          <span class="hits">59</span>
          
          <code class="ruby">    Log.init if @log4r.nil?</code>
        </li>
      
        <li class="covered" data-hits="59" data-linenumber="126">
          <span class="hits">59</span>
          
          <code class="ruby">    @log4r.warn(msg_with_caller(msg))</code>
        </li>
      
        <li class="covered" data-hits="59" data-linenumber="127">
          <span class="hits">59</span>
          
          <code class="ruby">    Log.flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">  # Log error massages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.error(msg)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="132">
          <span class="hits">3</span>
          
          <code class="ruby">    Log.init if @log4r.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="133">
          <span class="hits">3</span>
          
          <code class="ruby">    @log4r.error(msg_with_caller(msg))</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="134">
          <span class="hits">3</span>
          
          <code class="ruby">    Log.flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  # Log info massages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  # params:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  #  msg, *args - Works to construct a string using: msg % args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  #  Examples:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  #   &quot;hello&quot;  # no args provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  #   &quot;Time is %s. have a good day %s&quot;, Time.now, &quot;Sir&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  #  Note: Use ONLY %s in msg. Since %d will crush for nil objects, while %s will print empty string.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  #        Implicit to_s is used to convert arg to %s.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  #        If no to_s exists then ruby uses inspection.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.info(msg, *args)</code>
        </li>
      
        <li class="covered" data-hits="347" data-linenumber="147">
          <span class="hits">347</span>
          
          <code class="ruby">    Log.init if @log4r.nil?</code>
        </li>
      
        <li class="covered" data-hits="347" data-linenumber="148">
          <span class="hits">347</span>
          
          <code class="ruby">    msg = msg % args</code>
        </li>
      
        <li class="covered" data-hits="347" data-linenumber="149">
          <span class="hits">347</span>
          
          <code class="ruby">    @log4r.info(msg_with_caller(msg))</code>
        </li>
      
        <li class="covered" data-hits="347" data-linenumber="150">
          <span class="hits">347</span>
          
          <code class="ruby">    Log.flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  # Log debug level 1 massages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  # params:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  #  msg, *args - Works to construct a string using: msg % args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  #  Examples:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  #   &quot;hello&quot;  # no args provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">  #   &quot;Time is %s. have a good day %s&quot;, Time.now, &quot;Sir&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  #  Note: Use ONLY %s in msg. Since %d will crush for nil objects, while %s will print empty string.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  #        Implicit to_s is used to convert arg to %s.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  #        If no to_s exists then ruby uses inspection.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.debug1(msg, *args)</code>
        </li>
      
        <li class="covered" data-hits="178" data-linenumber="163">
          <span class="hits">178</span>
          
          <code class="ruby">    if Params['log_debug_level'] &gt;= 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      Log.init if @log4r.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      msg = msg % args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      @log4r.debug(msg_with_caller(msg))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">      Log.flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  # Log debug level 2 massages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  # params:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  #  msg, *args - Works to construct a string using: msg % args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  #  Examples:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  #   &quot;hello&quot;  # no args provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  #   &quot;Time is %s. have a good day %s&quot;, Time.now, &quot;Sir&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  #  Note: Use ONLY %s in msg. Since %d will crush for nil objects, while %s will print empty string.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  #        Implicit to_s is used to convert arg to %s.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  #        If no to_s exists then ruby uses inspection.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.debug2(msg, *args)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="181">
          <span class="hits">13</span>
          
          <code class="ruby">    if Params['log_debug_level'] &gt;= 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      Log.init if @log4r.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      msg = msg % args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      @log4r.debug(msg_with_caller(msg))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      Log.flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  # Log debug level 3 massages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  # params:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  #  msg, *args - Works to construct a string using: msg % args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">  #  Examples:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">  #   &quot;hello&quot;  # no args provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  #   &quot;Time is %s. have a good day %s&quot;, Time.now, &quot;Sir&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  #  Note: Use ONLY %s in msg. Since %d will crush for nil objects, while %s will print empty string.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">  #        Implicit to_s is used to convert arg to %s.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  #        If no to_s exists then ruby uses inspection.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.debug3(msg, *args)</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="199">
          <span class="hits">32</span>
          
          <code class="ruby">    if Params['log_debug_level'] &gt;= 3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">      Log.init if @log4r.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      msg = msg % args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">      @log4r.debug(msg_with_caller(msg))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      Log.flush if Params['log_flush_each_message']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">  # Flush email log</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">  def Log.flush()</code>
        </li>
      
        <li class="covered" data-hits="410" data-linenumber="209">
          <span class="hits">410</span>
          
          <code class="ruby">    return if @log4r.nil?</code>
        </li>
      
        <li class="covered" data-hits="410" data-linenumber="210">
          <span class="hits">410</span>
          
          <code class="ruby">    @log4r.outputters.each { |o|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      # Not flushing to email since this will cause empty emails to be sent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      # Email is already configured to immediately send mail on ERROR|FATAL messages.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">      o.flush unless o.is_a?(Log4r::EmailOutputter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">  private_class_method(:msg_with_caller)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="344d8500f352c2b33b0973cb9cf0eeeba4ad6ebf">
  <div class="header">
    <h3>lib/networking/tcp.rb</h3>
    <h4><span class="yellow">83.58 %</span> covered</h4>
    <div>
      <b>134</b> relevant lines. 
      <span class="green"><b>112</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'socket'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Networking</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('client_retry_delay', 60, 'Number of seconds before trying to reconnect.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # TODO(kolman): To get robustness, just use try catch + return 0 bytes on write +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # return false on status on read.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def Networking.write_to_stream(stream, obj)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">    Log.debug3('Writing to stream.')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">    marshal_data = Marshal.dump(obj)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">    Log.debug2(&quot;Writing data size: %s&quot;, marshal_data.length)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">    data_size = [marshal_data.length].pack(&quot;l&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">    if data_size.nil? || marshal_data.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      Log.debug2('Send data size is nil!')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">      bytes_written = stream.write data_size</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">      bytes_written += stream.write marshal_data</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">      return bytes_written</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      Log.warning(&quot;Could not write tcp/ip stream, #{e.to_s}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        stream.close()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      rescue IOError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        Log.warning(&quot;Could not close stream, #{e.to_s}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      return 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # Returns pair [status(true/false), obj]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def Networking.read_from_stream(stream)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="35">
          <span class="hits">3</span>
          
          <code class="ruby">    Log.debug3('Read from stream.')</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="36">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="37">
          <span class="hits">3</span>
          
          <code class="ruby">      return [false, nil] unless size_of_data = stream.read(4)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="38">
          <span class="hits">2</span>
          
          <code class="ruby">      size_of_data = size_of_data.unpack(&quot;l&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="39">
          <span class="hits">2</span>
          
          <code class="ruby">      Log.debug2(&quot;Reading data size:%s&quot;, size_of_data)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">      data = stream.read(size_of_data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      Log.warning(&quot;Could not read tcp/ip stream, #{e.to_s}.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        stream.close()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      rescue IOError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        Log.warning(&quot;Could not close stream, #{e.to_s}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      return [false, nil]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="51">
          <span class="hits">2</span>
          
          <code class="ruby">    unmarshalled_data = Marshal.load(data)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="52">
          <span class="hits">2</span>
          
          <code class="ruby">    Log.debug2('Read good.')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">    return [true, unmarshalled_data]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  # Limit on number of concurrent connections?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  # The TCP server is not responsible for reconnection.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  class TCPServer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :tcp_thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(port, obj_clb, new_clb=nil, closed_clb=nil, max_parallel=1)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">      @port = port</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="63">
          <span class="hits">2</span>
          
          <code class="ruby">      @obj_clb = obj_clb</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="64">
          <span class="hits">2</span>
          
          <code class="ruby">      @new_clb = new_clb</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="65">
          <span class="hits">2</span>
          
          <code class="ruby">      @closed_clb = closed_clb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # Max parallel connections is not implemented yet.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="67">
          <span class="hits">2</span>
          
          <code class="ruby">      @max_parallel = max_parallel</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="68">
          <span class="hits">2</span>
          
          <code class="ruby">      @sockets = {}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="69">
          <span class="hits">2</span>
          
          <code class="ruby">      @tcp_thread = run_server</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">      @tcp_thread.abort_on_exception = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def send_obj(obj, addr_info=nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      Log.debug3(&quot;send_obj with addr_info:%s&quot;, addr_info)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">      unless addr_info.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        if @sockets.key?(addr_info)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          Networking.write_to_stream(@sockets[addr_info], obj)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          Log.warning(&quot;Could not find client socket: #{addr_info}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">          return 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">        out = {}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="84">
          <span class="hits">2</span>
          
          <code class="ruby">        @sockets.each { |key, sock| out[key] = Networking.write_to_stream(sock, obj) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">        return out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # Creates new thread/pool</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    def run_server</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="92">
          <span class="hits">2</span>
          
          <code class="ruby">      Log.debug3('run_server')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="93">
          <span class="hits">2</span>
          
          <code class="ruby">      return Thread.new do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="94">
          <span class="hits">2</span>
          
          <code class="ruby">        loop {</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="95">
          <span class="hits">2</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">            Socket.tcp_server_loop(@port) do |sock, addr_info|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">              Log.debug2(&quot;tcp_server_loop:\nport:%s\nsock:%s\naddr info:%s&quot;, @port, sock, addr_info)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="98">
          <span class="hits">2</span>
          
          <code class="ruby">              @sockets[addr_info] = sock</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="99">
          <span class="hits">2</span>
          
          <code class="ruby">              @new_clb.call(addr_info) if @new_clb != nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">              loop do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">                # Blocking read.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="102">
          <span class="hits">2</span>
          
          <code class="ruby">                Log.debug2('read_from_stream')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="103">
          <span class="hits">2</span>
          
          <code class="ruby">                stream_ok, obj = Networking.read_from_stream(sock)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="104">
          <span class="hits">2</span>
          
          <code class="ruby">                Log.debug2(&quot;Server returned from read: %s&quot;, stream_ok)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="105">
          <span class="hits">2</span>
          
          <code class="ruby">                @obj_clb.call(addr_info, obj) if @obj_clb != nil &amp;&amp; stream_ok</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="106">
          <span class="hits">2</span>
          
          <code class="ruby">                break if !stream_ok</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">              Log.warning(&quot;Connection broken, #{addr_info.inspect}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">              begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">                @sockets[addr_info].close() unless @sockets[addr_info].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">              rescue IOError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">                Log.warning(&quot;Could not close socket, #{e.to_s}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">              @sockets.delete(addr_info)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">              @closed_clb.call(addr_info) if @closed_clb != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">            # !!! note this break is needed for tests only !!!! server loop should never end.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">            # and if it ends, it will fail, and rescue will work.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">            break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">          rescue IOError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">            Log.warning(&quot;Connection broken during tcp_server_loop. Restarting server loop &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">                       &quot;port:#{port}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end  # TCPServer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">  class TCPClient</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :tcp_thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(host, port, obj_clb=nil, reconnected_clb=nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="133">
          <span class="hits">3</span>
          
          <code class="ruby">      @host = host</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="134">
          <span class="hits">3</span>
          
          <code class="ruby">      @port = port</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="135">
          <span class="hits">3</span>
          
          <code class="ruby">      @tcp_socket = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="136">
          <span class="hits">3</span>
          
          <code class="ruby">      @obj_clb = obj_clb</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="137">
          <span class="hits">3</span>
          
          <code class="ruby">      @reconnected_clb = reconnected_clb</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="138">
          <span class="hits">3</span>
          
          <code class="ruby">      Log.debug3(&quot;Start TCPClient initialize  with @obj_clb: %s&quot;, @obj_clb)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="139">
          <span class="hits">3</span>
          
          <code class="ruby">      if @obj_clb != nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">        @tcp_thread = start_reading</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">        @tcp_thread.abort_on_exception = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      # Variable to signal when remote server is ready.</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="144">
          <span class="hits">3</span>
          
          <code class="ruby">      @remote_server_available = ConditionVariable.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="145">
          <span class="hits">3</span>
          
          <code class="ruby">      @remote_server_available_mutex = Mutex.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="146">
          <span class="hits">3</span>
          
          <code class="ruby">      open_socket unless socket_good?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="147">
          <span class="hits">3</span>
          
          <code class="ruby">      Log.debug3(&quot;End TCPClient initialize.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    def send_obj(obj)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="151">
          <span class="hits">2</span>
          
          <code class="ruby">      Log.debug1('send_obj')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="152">
          <span class="hits">2</span>
          
          <code class="ruby">      open_socket unless socket_good?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="153">
          <span class="hits">2</span>
          
          <code class="ruby">      Log.debug1('after open')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="154">
          <span class="hits">2</span>
          
          <code class="ruby">      if !socket_good?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">        Log.warning('Socket not opened for writing, skipping send.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">      Log.debug2(&quot;writing... socket port: %s&quot;, @tcp_socket.peeraddr)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">      bytes_written = Networking.write_to_stream(@tcp_socket, obj)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">      return bytes_written</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    # This function may be executed only from one thread!!! or in synchronized manner.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    # private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">    def open_socket</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="166">
          <span class="hits">4</span>
          
          <code class="ruby">      Log.debug1(&quot;Connecting to content server %s:%s&quot;, @host, @port)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="167">
          <span class="hits">4</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="168">
          <span class="hits">4</span>
          
          <code class="ruby">        @tcp_socket = TCPSocket.new(@host, @port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      rescue Errno::ECONNREFUSED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">        Log.warning('Connection refused')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="172">
          <span class="hits">4</span>
          
          <code class="ruby">      Log.debug3(&quot;Reconnect clb: %s&quot;, @reconnected_clb)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="173">
          <span class="hits">4</span>
          
          <code class="ruby">      if socket_good?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="174">
          <span class="hits">2</span>
          
          <code class="ruby">        @remote_server_available_mutex.synchronize {</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="175">
          <span class="hits">2</span>
          
          <code class="ruby">          @remote_server_available.signal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="177">
          <span class="hits">2</span>
          
          <code class="ruby">        @reconnected_clb.call if @reconnected_clb != nil &amp;&amp; socket_good?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">    def socket_good?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="183">
          <span class="hits">12</span>
          
          <code class="ruby">      closed = @tcp_socket != nil &amp;&amp; !@tcp_socket.closed?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="184">
          <span class="hits">12</span>
          
          <code class="ruby">      Log.debug3(&quot;socket_good? %s&quot;, closed)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="185">
          <span class="hits">12</span>
          
          <code class="ruby">      return closed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">    def start_reading</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">      return Thread.new do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">        loop do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">          Log.debug3('Start blocking read (TCPClient).')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">          # Blocking read.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">          if !socket_good?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">            Log.warning(&quot;Socket not good, waiting for reconnection with &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">                          &quot;#{Params['client_retry_delay']}[S] timeout.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">            @remote_server_available_mutex.synchronize {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">              @remote_server_available.wait(@remote_server_available_mutex,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">                                            Params['client_retry_delay'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">            read_ok, obj = Networking.read_from_stream(@tcp_socket)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">            Log.debug3(&quot;Client returned from read: %s&quot;, read_ok)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">            # Handle case when socket is closed in middle.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">            # In that case we should not call obj_clb.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">            @obj_clb.call(obj) if (read_ok &amp;&amp; @obj_clb != nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">  end  # TCPClient</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c0ecdfce7fcf3b5fe59d1ac26d62f445a86d91f2">
  <div class="header">
    <h3>lib/params.rb</h3>
    <h4><span class="yellow">88.61 %</span> covered</h4>
    <div>
      <b>158</b> relevant lines. 
      <span class="green"><b>140</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Author: Yaron Dror (yaron.dror.bb@gmail.com)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Description: The file contains 'Params' module implementation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Notes:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#   module.init should be called if user wants to override defined parameters by file or command line.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#   Parameter can be defined only once.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#   Parameters have to be defined before they are accessed. see examples below.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># Examples of definitions:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#   Params.string('parameter_str', 'this is a string' ,'description_for_string')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#   Params.path('parameter_path', '/Users/username/example/ect' ,'description_for_directory')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#   Params.integer('parameter_int',1 , 'description_for_integer')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#   Params.float('parameter_float',2.6 , 'description_for_float')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#   Params.boolean('parameter_true', true, 'description_for_true')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#   Params.boolean('parameter_false',false , 'description_for_false')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#   Params.complex('parameter_complex', [a,b,{b=&gt;c}], 'description for dict or list of strings.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">#   Note. Parameters have to be defined before they are accessed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"># Examples of usages (get\set access is through the [] operator).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">#   local_var_of_type_string = Params['parameter_str']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">#   puts local_var_of_type_string  # Will produce --&gt; this is a string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">#   Params['parameter_float'] = 3.8</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">#   puts Params['parameter_float']  # Will produce --&gt; 3.8</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">#   Params['parameter_float'] = 3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">#   puts Params['parameter_float']  # Will produce --&gt; 3.0 (note the casting)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">#   Note. only after definition, the [] operator will work. Else an error is raised.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">#     Params['new_param'] = true  # will raise an error, since the param was not defined yet.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">#     Params.boolean 'new_param', true, 'this is correct'  # this is the definition.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">#     Params['new_param'] = false  # Will set new value.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">#     puts Params['new_param']  # Will produce --&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"># Type check.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">#   A type check is forced both when overriding with file or command line and in [] usage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">#   if parameter was defined as a Float using Params.float method (e.g. 2.6) and user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">#   provided an integer when overriding or when using [] operator then the integer will</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">#   be casted to float.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"># Params.Init - override parameters.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">#   implementation of the init sequence allows the override of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">#   defined parameters with new values through input file and\or command line args.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">#   Note that only defined parameters can be overridden. If new parameter is parsed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">#   through file\command line, then an error will be raised.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">#   Input config file override:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">#     Default configuration input file path is: '~/.bbfs/conf/&lt;executable name&gt;.conf'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">#     This path can be overridden by the command line arguments (see ahead).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">#     If path and file exist then the parameters in the file will override the defined</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">#     parameters. File parameters format per line:&lt;param_name&gt;: &lt;param value&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">#     Note: Space char after the colon is mandatory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">#   Command line arguments override:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">#     General format per argument is:--&lt;param_name&gt;=&lt;param_value&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">#     those parameters will override the defined parameters and the file parameters.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">#   Override input config file:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">#     User can override the input file by using:--conf_file=&lt;new_file_path&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"># More examples in bbfs/examples/params/rb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">require 'optparse'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">require 'stringio'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">require 'yaml'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">module Params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  # Represents a parameter.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  class Param</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :desc</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    # value_type_check method:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    # 1. Check if member:'type' is one of:Integer, Float, String or Boolean.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    # 2. input parameter:'value' class type is valid to override this parameter.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # 3. Return value. The value to override with correct type. A cast from integer to Float will</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    #    be made for Float parameters which are set with integer values.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    # 4. Check will be skipped for nil value.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    def value_type_check(value)</code>
        </li>
      
        <li class="covered" data-hits="286" data-linenumber="76">
          <span class="hits">286</span>
          
          <code class="ruby">      if value.nil?</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="77">
          <span class="hits">17</span>
          
          <code class="ruby">        return value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="269" data-linenumber="80">
          <span class="hits">269</span>
          
          <code class="ruby">      case( @type )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        when 'Integer' then</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="82">
          <span class="hits">58</span>
          
          <code class="ruby">          if not @value.nil?</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="83">
          <span class="hits">29</span>
          
          <code class="ruby">            if not ((value.class.eql? Integer) or</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="84">
          <span class="hits">58</span>
          
          <code class="ruby">                (value.class.eql? Fixnum))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">              raise &quot;Parameter:'#{@name}' type:'Integer' but value type to override &quot; \</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="86">
          <span class="hits">4</span>
          
          <code class="ruby">                      &quot;is:'#{value.class}'.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        when 'Float' then</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="90">
          <span class="hits">27</span>
          
          <code class="ruby">          if not @value.nil?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="91">
          <span class="hits">15</span>
          
          <code class="ruby">            if not value.class.eql? Float</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="92">
          <span class="hits">9</span>
          
          <code class="ruby">              if not ((value.class.eql? Integer) or</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="93">
          <span class="hits">18</span>
          
          <code class="ruby">                  (value.class.eql? Fixnum))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">                raise(&quot;Parameter:'#{@name}' type:'Float' but value type to override &quot; \</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="95">
          <span class="hits">3</span>
          
          <code class="ruby">                        &quot;is:'#{value.class}'.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="97">
          <span class="hits">6</span>
          
          <code class="ruby">                return value.to_f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        when 'String' then</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        when 'Path' then</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">          # TODO(kolman): Override the type check with regexp of path in Linux and/or Windows</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="104">
          <span class="hits">72</span>
          
          <code class="ruby">          if not @value.nil?</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="105">
          <span class="hits">66</span>
          
          <code class="ruby">            if not value.class.eql? String</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">              raise(&quot;Parameter:'#{@name}' type:'String' but value type to override &quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">                      &quot;is:'#{value.class}'.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        when 'Boolean' then</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="111">
          <span class="hits">67</span>
          
          <code class="ruby">          if not @value.nil?</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="112">
          <span class="hits">43</span>
          
          <code class="ruby">            if not((value.class.eql? TrueClass) or (value.class.eql? FalseClass))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">              raise(&quot;Parameter:'#{@name}' type:'Boolean' but value type to override &quot; \</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="114">
          <span class="hits">12</span>
          
          <code class="ruby">                      &quot;is:'#{value.class}'.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        when 'Complex' then</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="118">
          <span class="hits">2</span>
          
          <code class="ruby">          unless @value.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">            unless (value.class.eql? Hash) or (value.class.eql? Array)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">              raise(&quot;Parameter:'#{@name}' type:'Complex' but value type to override &quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">                      &quot;is:'#{value.class}'.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          raise(&quot;Parameter:'#{@name}' type:'#{@value.class}' but parameter &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">                  &quot;type to override:'#{value.class}' is not supported. &quot; + \</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">                  &quot;Supported types are:Integer, Float, String or Boolean.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="243" data-linenumber="129">
          <span class="hits">243</span>
          
          <code class="ruby">      return value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    # supported types are: String, Integer, Float, Boolean, Path or Complex</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(name, value, type, desc)</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="134">
          <span class="hits">115</span>
          
          <code class="ruby">      @name = name</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="135">
          <span class="hits">115</span>
          
          <code class="ruby">      @type = type</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="136">
          <span class="hits">115</span>
          
          <code class="ruby">      @desc = desc</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="137">
          <span class="hits">115</span>
          
          <code class="ruby">      @value = value_type_check value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  @params_data_base = Hash.new # The parameters data structure.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">  @init_info_messages = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  @show_help_and_exit = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.get_init_info_messages</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="146">
          <span class="hits">5</span>
          
          <code class="ruby">    return @init_info_messages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.get_init_warning_messages</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="150">
          <span class="hits">5</span>
          
          <code class="ruby">    return @init_warning_messages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.raise_error_if_param_does_not_exist(name)</code>
        </li>
      
        <li class="covered" data-hits="1094" data-linenumber="154">
          <span class="hits">1094</span>
          
          <code class="ruby">    if not @params_data_base[name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      raise(&quot;before using parameter:'#{name}', it should first be defined through Param module methods:&quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">               &quot;Params.string, Params.path, Params.integer, Params.float, Params.complex, or Params.boolean.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.raise_error_if_param_exists(name)</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="161">
          <span class="hits">115</span>
          
          <code class="ruby">    if @params_data_base[name]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">      raise(&quot;Parameter:'#{name}', can only be defined once.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">  # Read param value by other modules.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">  # Note that this operator should only be used, after parameter has been defined through</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  # one of Param module methods: Params.string, Params.integer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">  # Params.float or Params.boolean.&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.[](name)</code>
        </li>
      
        <li class="covered" data-hits="966" data-linenumber="171">
          <span class="hits">966</span>
          
          <code class="ruby">    raise_error_if_param_does_not_exist(name)</code>
        </li>
      
        <li class="covered" data-hits="966" data-linenumber="172">
          <span class="hits">966</span>
          
          <code class="ruby">    @params_data_base[name].value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.each(&amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    @params_data_base.each(&amp;block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  # Write param value by other modules.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  # Note that this operator should only be used, after parameter has been defined through</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  # one of Param module methods: Params.string, Params.integer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  # Params.float or Params.boolean.&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.[]=(name, value)</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="184">
          <span class="hits">128</span>
          
          <code class="ruby">    raise_error_if_param_does_not_exist(name)</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="185">
          <span class="hits">128</span>
          
          <code class="ruby">    set_value = @params_data_base[name].value_type_check(value)</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="186">
          <span class="hits">128</span>
          
          <code class="ruby">    @params_data_base[name].value = set_value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  #override parameter should only be called by Params module methods.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.override_param(name, value)</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="191">
          <span class="hits">67</span>
          
          <code class="ruby">    existing_param = @params_data_base[name]</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="192">
          <span class="hits">67</span>
          
          <code class="ruby">    if existing_param.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      raise(&quot;Parameter:'#{name}' has not been defined and can not be overridden. &quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">              &quot;It should first be defined through Param module methods:&quot; \</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">              &quot;Params.string, Params.path, Params.integer, Params.float, Params.complex, or Params.boolean.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="197">
          <span class="hits">66</span>
          
          <code class="ruby">    if value.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">      existing_param.value = nil</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="199">
          <span class="hits">66</span>
          
          <code class="ruby">    elsif existing_param.type.eql?('String')</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="200">
          <span class="hits">21</span>
          
          <code class="ruby">      existing_param.value = value.to_s</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="201">
          <span class="hits">45</span>
          
          <code class="ruby">    elsif existing_param.type.eql?('Path')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="202">
          <span class="hits">2</span>
          
          <code class="ruby">      existing_param.value = File.expand_path(value.to_s)</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="203">
          <span class="hits">43</span>
          
          <code class="ruby">    elsif existing_param.type.eql?('Complex')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      if value.class.eql?(Hash) || value.class.eql?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">        existing_param.value = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">        existing_param.value = YAML::load(StringIO.new(value.to_s))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="210">
          <span class="hits">43</span>
          
          <code class="ruby">      set_value = existing_param.value_type_check(value)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="211">
          <span class="hits">24</span>
          
          <code class="ruby">      existing_param.value = set_value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  # Define new parameter of type Integer.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.integer(name, value, description)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="217">
          <span class="hits">29</span>
          
          <code class="ruby">    raise_error_if_param_exists(name)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="218">
          <span class="hits">29</span>
          
          <code class="ruby">    @params_data_base[name] = Param.new(name, value, 'Integer', description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  # Define new parameter of type Float.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.float(name, value, description)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="223">
          <span class="hits">12</span>
          
          <code class="ruby">    raise_error_if_param_exists(name)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="224">
          <span class="hits">12</span>
          
          <code class="ruby">    @params_data_base[name] = Param.new(name, value, 'Float', description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  # Define new parameter of type String.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.string(name, value, description)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="229">
          <span class="hits">42</span>
          
          <code class="ruby">    raise_error_if_param_exists(name)</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="230">
          <span class="hits">41</span>
          
          <code class="ruby">    @params_data_base[name] = Param.new(name, value, 'String', description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">  # Define new parameter of type path (the only difference with string is that the path expends '~' to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">  # full user directory).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.path(name, value, description)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="236">
          <span class="hits">6</span>
          
          <code class="ruby">    raise_error_if_param_exists(name)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="237">
          <span class="hits">6</span>
          
          <code class="ruby">    value = File.expand_path(value) unless value.nil?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="238">
          <span class="hits">6</span>
          
          <code class="ruby">    @params_data_base[name] = Param.new(name, value, 'Path', description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.complex(name, value, description)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="242">
          <span class="hits">2</span>
          
          <code class="ruby">    raise_error_if_param_exists(name)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="243">
          <span class="hits">2</span>
          
          <code class="ruby">    @params_data_base[name] = Param.new(name, value, 'Complex', description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">  # Define new parameter of type Boolean.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.boolean(name, value, description)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="248">
          <span class="hits">24</span>
          
          <code class="ruby">    raise_error_if_param_exists(name)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="249">
          <span class="hits">24</span>
          
          <code class="ruby">    @params_data_base[name] = Param.new(name, value, 'Boolean', description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">  # Initializes the project parameters.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  # Precedence is: Defined params, file and command line is highest.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.init(args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    #define default configuration file</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="256">
          <span class="hits">36</span>
          
          <code class="ruby">    Params['conf_file'] = &quot;~/.bbfs/etc/config_#{File.basename($PROGRAM_NAME)}.yml&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="258">
          <span class="hits">36</span>
          
          <code class="ruby">    @init_info_messages = []</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="259">
          <span class="hits">36</span>
          
          <code class="ruby">    @init_warning_messages = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    #parse command line argument and set configuration file if provided by user</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="262">
          <span class="hits">36</span>
          
          <code class="ruby">    results = parse_command_line_arguments(args)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="263">
          <span class="hits">29</span>
          
          <code class="ruby">    if results['conf_file']</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="264">
          <span class="hits">2</span>
          
          <code class="ruby">      Params['conf_file'] = File.expand_path(results['conf_file'])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="265">
          <span class="hits">2</span>
          
          <code class="ruby">      if !File.exist?(Params['conf_file']) or File.directory?(Params['conf_file'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">        raise(&quot;Param:'conf_file' value:'#{Params['conf_file']}' is a file name which does not exist&quot; +</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">                  &quot; or a directory name&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="271">
          <span class="hits">29</span>
          
          <code class="ruby">    Params['conf_file'] = File.expand_path(Params['conf_file'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">    #load yml params if path is provided and exists</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="274">
          <span class="hits">29</span>
          
          <code class="ruby">    if File.exist?(Params['conf_file'])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="275">
          <span class="hits">2</span>
          
          <code class="ruby">      @init_info_messages &lt;&lt; &quot;Loading parameters from configuration file:'#{Params['conf_file']}'&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="276">
          <span class="hits">2</span>
          
          <code class="ruby">      if not read_yml_params(File.open(Params['conf_file'], 'r'))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">        raise(&quot;Bad configuration file #{Params['conf_file']}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      @init_warning_messages &lt;&lt; &quot;Configuration file path:'#{Params['conf_file']}' does not exist. &quot; + \</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="281">
          <span class="hits">27</span>
          
          <code class="ruby">                                &quot;Skipping loading file parameters.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">    #override command line argument</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="285">
          <span class="hits">29</span>
          
          <code class="ruby">    results.keys.each do |result_name|</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="286">
          <span class="hits">34</span>
          
          <code class="ruby">      override_param(result_name, results[result_name])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">    # Prints help and parameters if needed.</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="290">
          <span class="hits">23</span>
          
          <code class="ruby">    if @show_help_and_exit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      # Print parameters + description and exit.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      puts &quot;Full list of parameters:&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      Params.each do |name, param|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        puts &quot;--#{name}, #{param.type}, default:#{param.value}\n\t#{param.desc}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">      exit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">    # Add parameters to log init messages (used by Log.init if param:print_params_to_stdout is true)</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="300">
          <span class="hits">23</span>
          
          <code class="ruby">    @init_info_messages &lt;&lt; 'Initialized executable parameters:'</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="301">
          <span class="hits">23</span>
          
          <code class="ruby">    @init_info_messages &lt;&lt; '---------------------------------'</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="302">
          <span class="hits">23</span>
          
          <code class="ruby">    counter=0</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="303">
          <span class="hits">23</span>
          
          <code class="ruby">    @params_data_base.values.each do |param|</code>
        </li>
      
        <li class="covered" data-hits="2200" data-linenumber="304">
          <span class="hits">2200</span>
          
          <code class="ruby">      counter += 1</code>
        </li>
      
        <li class="covered" data-hits="2200" data-linenumber="305">
          <span class="hits">2200</span>
          
          <code class="ruby">      @init_info_messages &lt;&lt; &quot;Param ##{counter}: #{param.name}=#{param.value}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="307">
          <span class="hits">23</span>
          
          <code class="ruby">    @init_info_messages &lt;&lt; '---------------------------------'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">  # Load yml params and override default values.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  # raise exception if a loaded yml param does not exist. or if types mismatch occurs.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="312">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.read_yml_params(yml_input_io)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="313">
          <span class="hits">31</span>
          
          <code class="ruby">    proj_params = YAML::load(yml_input_io)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="314">
          <span class="hits">31</span>
          
          <code class="ruby">    return false unless proj_params.is_a?(Hash)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="315">
          <span class="hits">30</span>
          
          <code class="ruby">    proj_params.keys.each do |param_name|</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="316">
          <span class="hits">33</span>
          
          <code class="ruby">      override_param(param_name, proj_params[param_name])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="318">
          <span class="hits">16</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">  #  Parse command line arguments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.parse_command_line_arguments(args)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="323">
          <span class="hits">62</span>
          
          <code class="ruby">    results = Hash.new  # Hash to store parsing results.</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="324">
          <span class="hits">62</span>
          
          <code class="ruby">    options = Hash.new  # Hash of parsing options from Params.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">    # Define options switch for parsing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">    # Define List of options see example on</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    # http://ruby.about.com/od/advancedruby/a/optionparser2.htm</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="329">
          <span class="hits">62</span>
          
          <code class="ruby">    opts = OptionParser.new do |opts|</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="330">
          <span class="hits">62</span>
          
          <code class="ruby">      @params_data_base.values.each do |param|</code>
        </li>
      
        <li class="covered" data-hits="6089" data-linenumber="331">
          <span class="hits">6089</span>
          
          <code class="ruby">        tmp_name_long = &quot;--#{param.name} #{param.name.upcase}&quot;  # Define a command with single mandatory parameter</code>
        </li>
      
        <li class="covered" data-hits="6089" data-linenumber="332">
          <span class="hits">6089</span>
          
          <code class="ruby">        tmp_value = param.desc + &quot; Default value:&quot; + param.value.to_s  #  Description and Default value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">        # Define type of the mandatory value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">        # It can be integer, float or String(for all other types).</code>
        </li>
      
        <li class="covered" data-hits="6089" data-linenumber="336">
          <span class="hits">6089</span>
          
          <code class="ruby">        case(param.type)</code>
        </li>
      
        <li class="covered" data-hits="1663" data-linenumber="337">
          <span class="hits">1663</span>
          
          <code class="ruby">          when 'Integer' then value_type = Integer</code>
        </li>
      
        <li class="covered" data-hits="602" data-linenumber="338">
          <span class="hits">602</span>
          
          <code class="ruby">          when 'Float' then value_type = Float</code>
        </li>
      
        <li class="covered" data-hits="3824" data-linenumber="339">
          <span class="hits">3824</span>
          
          <code class="ruby">          else value_type = String</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">        # Switches definition - according to what</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">        # was pre-defined in the Params</code>
        </li>
      
        <li class="covered" data-hits="6089" data-linenumber="343">
          <span class="hits">6089</span>
          
          <code class="ruby">        opts.on(tmp_name_long, value_type, tmp_value) do |result|</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="344">
          <span class="hits">52</span>
          
          <code class="ruby">          if result.to_s.upcase.eql? 'TRUE'</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="345">
          <span class="hits">7</span>
          
          <code class="ruby">            results[param.name] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">          elsif result.to_s.upcase.eql? 'FALSE'</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="347">
          <span class="hits">7</span>
          
          <code class="ruby">            results[param.name] = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="349">
          <span class="hits">38</span>
          
          <code class="ruby">            results[param.name] = result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">      # Define introduction text for help command</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="355">
          <span class="hits">62</span>
          
          <code class="ruby">      opts.banner =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">          &quot;Usage: content_serve [options] or \n&quot;  +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">          &quot;     : backup_server [options] \n\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">          &quot;Description: This application for backuping files and folders\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">          &quot;There is two application: \n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">          &quot;backup_server is server run on machine where files is backuped,\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">          &quot;content_server is application that run on machine from where files is copied.\n\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">          &quot;Before run applications:&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">          &quot;Before running backup_server and content server you need to prepare two configuration files\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">          &quot;Create configuration file for content server which should be located at ~/.bbfs/etc/file_monitoring.yml\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">          &quot;the content of the file is:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">------- begin of file_monitoring.yml --------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">paths:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">- path: ~/.bbfs/test_files  # &lt;=== replace with your local dir.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">scan_period: 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">stable_state: 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">------- end of file_monitoring.yml --------\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">            &quot;Create configuration file for backup server which should be located at \n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">            &quot;~/.bbfs/etc/backup_file_monitoring.yml\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">            &quot;File content:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">------- begin of backup_file_monitoring.yml --------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">paths:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">   - path:  ~/.bbfs/backup_data  # &lt;=== replace with your local dir.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">     scan_period: 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">     stable_state: 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">------- end of backup_file_monitoring.yml --------\n\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">            &quot;Explanation about file_monitoring.yml and backup_file_monitoring.yml configuration files:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">\&quot;path:\&quot; - say to program which folder to scan recursively in order to find  new/changed files and folders.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">\&quot;scan_period:\&quot; - how much time in seconds passed before two consecutive scans for files and directories.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">\&quot;stable_state:\&quot; - how many scan_period passed until the file is considered stable.\n\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">             &quot;List of options:&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">      # Define help command for available options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">      # executing --help will printout all pre-defined switch options</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="391">
          <span class="hits">62</span>
          
          <code class="ruby">      opts.on_tail(&quot;-h&quot;, &quot;--help&quot;, &quot;Show this message&quot;) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">        @show_help_and_exit = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="395">
          <span class="hits">62</span>
          
          <code class="ruby">      opts.parse(args)  # Parse command line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="397">
          <span class="hits">47</span>
          
          <code class="ruby">    return results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">  end # end of Parse function</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="400">
          <span class="hits">1</span>
          
          <code class="ruby">  def Params.to_simple_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">    @params_data_base.map { |param|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">      param.value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="406">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.path('conf_file', nil, 'Configuration file path.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="407">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('print_params_to_stdout', false, 'print_params_to_stdout or not during Params.init')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  private_class_method :parse_command_line_arguments, \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">                       :raise_error_if_param_exists, :raise_error_if_param_does_not_exist, \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">                       :read_yml_params, :override_param</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6efd0b644bdce5b7c3e565a97e9df5dfb88cdd37">
  <div class="header">
    <h3>lib/process_monitoring/monitoring.rb</h3>
    <h4><span class="green">92.31 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'thread'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require 'process_monitoring/send_email'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># This module purpose it to alert the user on different behaviour such as no space left</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"># or other error cases. The module will send email to the user to notify him on those cases.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">module Monitoring</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.float('monitoring_sleep_time_in_seconds', 10,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">               'Represents the monitoring sleeping time in seconds to check data')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.float('send_email_duration_4_monitoring_state', 60*60,  # Once per hour.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">               'Represents the duration in seconds to send email monitoring state')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # Username and Password for gmail account to send monitoting emails.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('gmail_username', nil, 'Backup server gmail username.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('gmail_password', nil, 'Backup server gmail password.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  class Monitoring</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :thread</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(process_variables)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      @thread = 'dummy'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">=begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  class Monitoring &lt; Log::Consumer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    attr_reader :thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    def initialize(process_variables)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      super(false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      @passed_time_dur = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      @process_variables = process_variables</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      @thread = Thread.new do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        loop do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          Log.debug3 'Sleeping in process monitoring.'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          sleep(Params['monitoring_sleep_time_in_seconds'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          Log.debug3 'Awake in process monitoring.'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          @passed_time_dur += Params['monitoring_sleep_time_in_seconds']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          Log.debug3 'handle_logs in process monitoring.'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          handle_logs()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">          Log.debug3 'handle_monitoring_state in process monitoring.'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">          handle_monitoring_state()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">          @process_variables.inc('monitoring_loop_count')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      # For debug purposes.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      @thread.abort_on_exception = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    # To keep thread safe state all methods should be private and executed only from @thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    def send_email(subject, body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      SendEmail.send_email({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">                               :to =&gt; Params['gmail_username'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">                               :from =&gt; Params['gmail_username'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">                               :password =&gt; Params['gmail_password'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">                               :body =&gt; body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">                               :subject =&gt; subject,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">                           })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    # Override logs consumer handler.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    def handle_logs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      while log_msg = @consumer_queue.pop(non_block=true) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        send_log_email(log_msg) if Log.is_error(log_msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end rescue ThreadError  # Rescue when queue is empty.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    def handle_monitoring_state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      if @passed_time_dur &gt; Params['send_email_duration_4_monitoring_state']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        send_email('BBFS Current Monitoring State notification', get_monitoring_state_body())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        @passed_time_dur = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    def get_monitoring_state_body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      # TODO(slava): Implement the following function.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # MonitoringInfo::MonitoringInfo.get_html(@process_variables)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      &quot;server_name: #{@process_variables.get('server_name')}\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          &quot;num_files_received: #{@process_variables.get('num_files_received')}\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">          &quot;monitoring_loop_count: #{@process_variables.get('monitoring_loop_count')}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">=end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="28d76f22135193ef2af40f197841ecad0228d0f9">
  <div class="header">
    <h3>lib/process_monitoring/monitoring_info.rb</h3>
    <h4><span class="red">37.21 %</span> covered</h4>
    <div>
      <b>43</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'eventmachine'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'json'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'net/http'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'thin'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'sinatra'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_server/server'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"># Set up event machine to exit on ctrl+c.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">EventMachine.schedule do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  trap(&quot;INT&quot;) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    puts &quot;Caught SIGINT&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">   # EventMachine.stop # this is useless</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    exit                  # exit # this stops the EventMachine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"># This module export process info to http port, that way the user may access with the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"># browser to the process to see what is happening inside, what is it's state and parameters.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">module MonitoringInfo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.integer('process_monitoring_web_port', 5555,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">                 'The port from which monitoring data will be served as http.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  class MonitoringInfo</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      @web_interface = Sinatra.new {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        set :bind, '0.0.0.0'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        get('/') { MonitoringInfo.get_json($process_vars.clone) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      @web_interface.set(:port, Params['process_monitoring_web_port'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      @thread = Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        @web_interface.run!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.get_json(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      return '' if !hash.is_a?(Hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      entries = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      hash.each do |key, value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        entries &lt;&lt; &quot;{#{key}:#{value}}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      return entries.join(&quot; , &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.get_html (hash, opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      return if !hash.is_a?(Hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      indent_level = opts.fetch(:indent_level) { 0 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      out = &quot; &quot; * indent_level + &quot;&lt;ul&gt;\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      hash.each do |key, value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        out += &quot; &quot; * (indent_level + 2) + &quot;&lt;li&gt;&lt;strong&gt;#{key}:&lt;/strong&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        if value.is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          out += &quot;\n&quot; + get_html(value, :indent_level =&gt; indent_level + 2) + &quot; &quot; * (indent_level + 2) + &quot;&lt;/li&gt;\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">          out += &quot; &lt;span&gt;#{value}&lt;/span&gt;&lt;/li&gt;\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      out += &quot; &quot; * indent_level + &quot;&lt;/ul&gt;\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.get_remote_monitoring_info(host, port)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        JSON.parse(Net::HTTP.get(URI(&quot;http://#{host}:#{port}/&quot;)))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      rescue Errno::ECONNREFUSED =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        ''</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="793c95b8908b3d4e73dd594506531141df245651">
  <div class="header">
    <h3>lib/process_monitoring/send_email.rb</h3>
    <h4><span class="red">28.57 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>15</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'net/smtp'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">module SendEmail</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.boolean('enable_monitoring_emails', false, 'Whether to send emails for process monitoring events.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #class SendEmail</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def SendEmail.send_email(opts={})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    opts[:to]          ||= ''  # Required.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    opts[:from]        ||= ''  # Required.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    opts[:from_alias]  ||= 'BBFS Monitoring'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    opts[:subject]     ||= 'BBFS Notification subject'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    opts[:body]        ||= 'BBFS Body'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    opts[:password]    ||= ''  # Required.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    msg = &quot;From: #{opts[:from_alias]} &lt;#{opts[:from]}&gt;\n&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">          &quot;To: &lt;#{opts[:to]}&gt;\n&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">          &quot;Subject: #{opts[:subject]}\n&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">          &quot;#{opts[:body]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    email_log_message = &quot;Send actual email: #{Params['enable_monitoring_emails']}.\n&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">                        &quot;to: #{opts[:to]}\n&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">                        &quot;msg:#{msg}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    if Params['enable_monitoring_emails']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      Log.debug1(email_log_message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      smtp = Net::SMTP.new('smtp.gmail.com', 587)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      smtp.enable_starttls</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      smtp.start('bbfs.com', opts[:from], opts[:password], :login) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        smtp.send_message(msg, opts[:from], opts[:to])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      Log.info(email_log_message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  #end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="89e04980687f4953fcec5b9ccb80d350033d0570">
  <div class="header">
    <h3>lib/process_monitoring/thread_safe_hash.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>40</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Simple thread safe hash.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">module ThreadSafeHash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class ThreadSafeHash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      @hash_data = Hash.new()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      @mutex = Mutex.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def inc(key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      @mutex.synchronize do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        value = @hash_data[key]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        if value.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">          @hash_data[key] = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">          @hash_data[key] = value + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    def dec(key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      @mutex.synchronize do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        value = @hash_data[key]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        if value.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          @hash_data[key] = -1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">          @hash_data[key] = value - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    def get(key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      @mutex.synchronize do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        @hash_data[key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    def set(key, value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      @mutex.synchronize do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        @hash_data[key] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    def clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      @mutex.synchronize do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        @hash_data.clone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  class ThreadSafeHashMonitored &lt; ThreadSafeHash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(monitored)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      super()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      @monitored = monitored</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    def inc(key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      super if @monitored</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    def dec(key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      super if @monitored</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    def get(key)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      super if @monitored</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    def set(key, value)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="69">
          <span class="hits">29</span>
          
          <code class="ruby">      super if @monitored</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    def clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      super if @monitored</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a3923e217b40f796c5592a4e0461b76ba6f1a85f">
  <div class="header">
    <h3>lib/run_in_background.rb</h3>
    <h4><span class="red">42.13 %</span> covered</h4>
    <div>
      <b>197</b> relevant lines. 
      <span class="green"><b>83</b> lines covered</span> and
      <span class="red"><b>114</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Author: Genady Petelko (nukegluk@gmail.com)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Description: The file contains implementation of 'RunInBackground' module.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># This library provides a basic cross-platform functionality to run arbitrary ruby scripts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># in background and control them. &lt;br&gt;Supported platforms: Windows, Linux, Mac</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#   NOTE UAC (User Account Control) should be disabled to use library on Windows 7:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#   * Click on the Windows Icon</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#   * Click on the Control Panel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#   * Type in UAC in the search box (up-right corner of your window)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#   * Click on &quot;Change User Account Control settings&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#   * Drag the slider down to either &quot;Notify me when programs try to make changes to my computer&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#     or to disable it completely</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">#   * Reboot your computer when you're ready</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"># == General Limitations:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"># *  Only ruby scripts can be run in background.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"># *  No multiple instances with the same name.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"># == Notes:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"># *  Linux/Mac specific methods have _linux suffix</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"># *  Windows specific methods have _windows suffix</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"># *  While enhancing windows code, take care that paths are in windows format,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">#    &lt;br&gt;e.i. with &quot;\\&quot; file separator while ruby by default uses a &quot;/&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"># *  Additional functionality such as restart, reload, etc. will be added on demand</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"># *  Remains support to provide platform specific options for start.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">#    &lt;br&gt;For more information regarding such options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">#    see documentation for win32-sevice (Windows), daemons (Linux/Mac)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"># == Linux Notes:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"># *  &lt;tt&gt;pid_dir&lt;/tt&gt; parameter contains absolute path to directory where pid files will be stored.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">#    &lt;br&gt;If directory doesn't exists then it will be created.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">#    &lt;br&gt;User should have a read/write permissions to this location.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">#    &lt;br&gt;Default location: &lt;tt&gt;$HOME/.bbfs/pids&lt;/tt&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"># *  User should check that default pid directory is free from pid files of &quot;killed&quot; daemons.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">#    &lt;br&gt;It may happen, for example, when system finished in abnormal way then pid files were</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">#    not deleted by daemons library.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">#    &lt;br&gt;In such case incorrect results can be received, for example for &lt;tt&gt;exists?&lt;/tt&gt; method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">#    &lt;br&gt;One of the suggested methods can be before starting a daemon to check with &lt;tt&gt;exists?&lt;/tt&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">#    method whether daemon already exists and with &lt;tt&gt;running?&lt;/tt&gt; method does it running.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">module RunInBackground</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('bg_command', nil, 'Server\'s command. Commands are: start, delete and nil for' \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">                  ' not running in background.')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  Params.string('service_name', File.basename($0), 'Background service name.')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # Maximal time in seconds to wait until OS will finish a requested operation,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # e.g. daemon start/delete.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  TIMEOUT = 20</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  if RUBY_PLATFORM =~ /linux/ or RUBY_PLATFORM =~ /darwin/</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      require 'daemons'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      require 'fileutils'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      require 'rubygems'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      require 'daemons'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      require 'fileutils'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    OS = :LINUX</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    Params.string('pid_dir', File.expand_path(File.join(Dir.home, '.bbfs', 'pids')),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">                  'Absolute path to directory, where pid files will be stored. ' + \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        'User should have a read/write permissions to this location. ' + \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        'If absent then it will be created. ' + \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        'It\'s actual only for Linux/Mac. ' + \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        'For more information see documentation on daemons module. ' +\</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        'Default location is: $HOME/.bbfs/pids')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    if Dir.exists? Params['pid_dir']</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">      unless File.directory? Params['pid_dir']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        raise IOError.new(&quot;pid directory #{Params['pid_dir']} should be a directory&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">      unless File.readable?(Params['pid_dir']) &amp;&amp; File.writable?(Params['pid_dir'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        raise IOError.new(&quot;you should have read/write permissions to pid dir: #{Params['pid_dir']}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      ::FileUtils.mkdir_p Params['pid_dir']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  elsif RUBY_PLATFORM =~ /mingw/ or RUBY_PLATFORM =~ /ms/ or RUBY_PLATFORM =~ /win/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    require 'rbconfig'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      require 'win32/service'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      require 'win32/daemon'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      require 'rubygems'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      require 'win32/service'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      require 'win32/daemon'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    include Win32</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    OS = :WINDOWS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # Get ruby interpreter path. Need it to run ruby binary.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    # &lt;br&gt;TODO check whether this code works with Windows Ruby Version Management (e.g. Pik)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    RUBY_INTERPRETER_PATH = File.join(Config::CONFIG[&quot;bindir&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">                                      Config::CONFIG[&quot;RUBY_INSTALL_NAME&quot;] +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">                                          Config::CONFIG[&quot;EXEEXT&quot;]).tr!('/','\\')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    # Path has to be absolute cause Win32-Service demands it.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    wrapper = File.join(File.dirname(__FILE__), &quot;..&quot;, &quot;bin&quot;, File.basename(__FILE__, &quot;.rb&quot;), &quot;daemon_wrapper&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    # Wrapper script, that can receive commands from Windows Service Control and run user script,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    # &lt;br&gt; provided as it's argument</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    WRAPPER_SCRIPT = File.expand_path(wrapper).tr!('/','\\')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    raise &quot;Unsupported platform #{RUBY_PLATFORM}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  # Start a service/daemon.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  # &lt;br&gt;It important to delete it after usage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  # * &lt;tt&gt;binary_path&lt;/tt&gt; - absolute path to the script that should be run in background</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  #     NOTE for Linux script should be executable and with UNIX end-of-lines (LF).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # * &lt;tt&gt;binary_args&lt;/tt&gt; - Array (not nil) of script's command line arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  # * &lt;tt&gt;name&lt;/tt&gt; - service/daemon name.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  #     NOTE should be unique</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  # * &lt;tt&gt;opts_specific&lt;/tt&gt; - Hash of platform specific options (only for more specific usage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  #    For more information regarding such options see documentation for</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  #    win32-sevice (Windows), daemons (Linux/Mac)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  # ==== Example (LINUX)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  # &lt;tt&gt;  RunInBackground.start &quot;/home/user/test_app&quot;, [], &quot;daemon_test&quot;, {:monitor =&gt; true}&lt;/tt&gt;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.start binary_path, binary_args, name, opts_specific = {}</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="120">
          <span class="hits">5</span>
          
          <code class="ruby">    Log.debug1(&quot;executable that should be run as daemon/service: #{binary_path}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="121">
          <span class="hits">5</span>
          
          <code class="ruby">    Log.debug1(&quot;arguments: #{binary_args}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="122">
          <span class="hits">5</span>
          
          <code class="ruby">    Log.debug1(&quot;specific options: #{opts_specific}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="124">
          <span class="hits">5</span>
          
          <code class="ruby">    if binary_path == nil or binary_args == nil or name == nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="125">
          <span class="hits">3</span>
          
          <code class="ruby">      Log.error(&quot;binary path, binary args, name arguments must be defined&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="126">
          <span class="hits">3</span>
          
          <code class="ruby">      raise ArgumentError.new(&quot;binary path, binary args, name arguments must be defined&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="129">
          <span class="hits">2</span>
          
          <code class="ruby">    if OS == :WINDOWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      new_binary_path = String.new(binary_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      new_binary_args = Array.new(binary_args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      wrap_windows new_binary_path, new_binary_args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      start_windows new_binary_path, new_binary_args, name, opts_specific</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    else  # OS == LINUX</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="135">
          <span class="hits">2</span>
          
          <code class="ruby">      start_linux binary_path, binary_args, name, opts_specific</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">    0.upto(TIMEOUT) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">      if exists?(name) &amp;&amp; running?(name)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">        puts &quot;daemon/service #{name} started\n&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">        Log.debug1(&quot;daemon/service #{name} started&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      sleep 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    # if got here then something gone wrong and daemon/service wasn't started in timely manner</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">    delete name if exists? name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    Log.error(&quot;daemon/service #{name} wasn't started in timely manner&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">		Log.flush</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    raise &quot;daemon/service #{name} wasn't started in timely manner&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.start_linux binary_path, binary_args, name, opts = {}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="154">
          <span class="hits">2</span>
          
          <code class="ruby">    unless File.executable? binary_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">      raise ArgumentError.new(&quot;#{binary_path} is not executable.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">    if opts.has_key? :dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      raise ArgumentError.new(&quot;No support for user-defined pid directories. See help&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">    opts[:app_name] = name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">    opts[:ARGV] = ['start']</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    (opts[:ARGV] &lt;&lt; '--').concat(binary_args) if !binary_args.nil? &amp;&amp; binary_args.size &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">    opts[:dir] = Params['pid_dir']</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">    opts[:dir_mode] = :normal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    Log.debug1(&quot;binary path: #{binary_path}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">    Log.debug1(&quot;opts: #{opts}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    # Current process, that creates daemon, will transfer control to the Daemons library.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    # So to continue working with current process, daemon creation initiated from separate process.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    pid = fork do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      Daemons.run binary_path, opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">    Process.waitpid pid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.start_windows binary_path, binary_args, name, opts = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    raise ArgumentError.new(&quot;#{binary_path} doesn't exist'&quot;) unless File.exists? binary_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    # path that contains spaces must be escaped to be interpreted correctly</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    binary_path = %Q{&quot;#{binary_path}&quot;} if binary_path =~ / /</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    binary_path.tr!('/','\\')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    # service should be run with the same load path as a current application</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">    load_path = get_load_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    binary_args_str = binary_args.join ' '</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">    opts[:binary_path_name] = \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        &quot;#{RUBY_INTERPRETER_PATH} #{load_path} #{binary_path} #{binary_args_str}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    # quotation marks must be escaped cause of ARGV parsing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    opts[:binary_path_name] = opts[:binary_path_name].gsub '&quot;', '&quot;\\&quot;'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    opts[:service_name] = name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    opts[:description] = name unless opts.has_key? :description</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">    opts[:display_name] = name unless opts.has_key? :display_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    opts[:service_type] = Service::WIN32_OWN_PROCESS unless opts.has_key? :service_type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    opts[:start_type] = Service::DEMAND_START unless opts.has_key? :start_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    # NOTE most of examples uses these dependencies. Meanwhile no explanations were found</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    opts[:dependencies] = ['W32Time','Schedule'] unless opts.has_key? :dependencies</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    # NOTE most of examples uses this option as defined beneath. The default is nil.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    #opts[:load_order_group] = 'Network' unless opts.has_key? :load_order_group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    Log.debug1(&quot;create service options: #{opts}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">    Service.create(opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      Service.start(opts[:service_name])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      Service.delete(opts[:service_name]) if Service.exists?(opts[:service_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  # Rerun current script in background.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  # &lt;br&gt;Current process will be closed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  # &lt;br&gt;It suggested to remove from ARGV any command line arguments that point</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  # to run script in background, &lt;br&gt;otherwise an unexpexted result can be received</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.start! name, opts = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    # $0 is the executable name.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">    start(File.expand_path($0), ARGV, name, opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">	  Log.flush</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">    exit!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  # Run in background script that was written as Windows Service, i.e. can receive signals</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  # from Service Control.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  # &lt;br&gt;The code that is run in this script should be an extension of Win32::Daemon class.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">  # &lt;br&gt;For more information see Win32::Daemon help and examples.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">  # &lt;br&gt;No need  to wrap such a script.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.start_win32service binary_path, binary_args, name, opts_specific = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">    Log.debug1(&quot;executable that should be run as service: #{binary_path}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">    Log.debug1(&quot;arguments: #{binary_args}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">    Log.debug1(&quot;specific options: #{opts_specific}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">    if OS == :WINDOWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">      start_windows binary_path, binary_args, name, opts_specific</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">    else  # OS == :LINUX</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">      raise NotImplementedError.new(&quot;Unsupported method on #{OS}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">    0.upto(TIMEOUT) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">      if exists?(name) &amp;&amp; running?(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">        puts &quot;windows service #{name} started\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">        Log.debug1(&quot;windows service #{name} started&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">      sleep 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    # if got here then something gone wrong and daemon/service wasn't started in timely manner</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">    delete name if exists? name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">    Log.error(&quot;daemon/service #{name} wasn't started in timely manner&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">		Log.flush</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    raise &quot;daemon/service #{name} wasn't started in timely manner&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  # Wrap an arbitrary ruby script withing script that can be run as Windows Service.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">  # ==== Arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">  # * &lt;tt&gt;binary_path&lt;/tt&gt; - absolute path of the script that should be run in background</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">  # * &lt;tt&gt;binary_args&lt;/tt&gt; - array (not nil) of scripts command line arguments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  #  NOTE binary_path and binary_args contents will be change</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.wrap_windows binary_path, binary_args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">    raise ArgumentError.new(&quot;#{binary_path} doesn't exists&quot;) unless File.exists? binary_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    # service should be run with the same load path as a current application</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">    load_path = get_load_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    # path that contains spaces must be escaped to be interpreted correctly</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">    binary_path = %Q{&quot;#{binary_path}&quot;} if binary_path =~ / /</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">    binary_args.insert(0, RUBY_INTERPRETER_PATH, load_path, binary_path.tr('/','\\'))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    binary_path.replace(WRAPPER_SCRIPT)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">  # NOTE if this method will become public then may be needed to change appropriately wrapper script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="273">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.stop name</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="274">
          <span class="hits">2</span>
          
          <code class="ruby">    if not exists? name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">      raise ArgumentError.new(&quot;Daemon #{name} doesn't exists&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="276">
          <span class="hits">2</span>
          
          <code class="ruby">    elsif OS == :WINDOWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">      Service.stop(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    else  # OS == :LINUX</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="279">
          <span class="hits">2</span>
          
          <code class="ruby">      opts = {:app_name =&gt; name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">              :ARGV =&gt; ['stop'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">              :dir_mode =&gt; :normal,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">              :dir =&gt; Params['pid_dir']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">      # Current process, that creates daemon, will transfer control to the Daemons library.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      # So to continue working with current process, daemon creation initiated from separate process.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      # It looks that it holds only for start command</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      #pid = fork do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="288">
          <span class="hits">2</span>
          
          <code class="ruby">      Daemons.run &quot;&quot;, opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      #end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      #Process.waitpid pid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">  # Delete service/daemon.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  # &lt;br&gt;If running then stop and delete.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="296">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.delete name</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="297">
          <span class="hits">3</span>
          
          <code class="ruby">    if not exists? name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">      raise ArgumentError.new(&quot;Daemon #{name} doesn't exists&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">    elsif running? name</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="300">
          <span class="hits">2</span>
          
          <code class="ruby">      stop name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="302">
          <span class="hits">2</span>
          
          <code class="ruby">    if OS == :WINDOWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      Service.delete name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    else  # OS == :LINUX</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="305">
          <span class="hits">2</span>
          
          <code class="ruby">      opts = {:app_name =&gt; name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">              :ARGV =&gt; ['zap'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">              :dir_mode =&gt; :normal,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">              :dir =&gt; Params['pid_dir']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">      # Current process, that creates daemon, will transfer control to the Daemons library.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      # So to continue working with current process, daemon creation initiated from separate process.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">      # It looks that it holds only for start command</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      #pid = fork do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="314">
          <span class="hits">2</span>
          
          <code class="ruby">      Daemons.run &quot;&quot;, opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">      #end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">      #Process.waitpid pid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="318">
          <span class="hits">2</span>
          
          <code class="ruby">    0.upto(TIMEOUT) do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="319">
          <span class="hits">2</span>
          
          <code class="ruby">      unless exists? name</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="320">
          <span class="hits">2</span>
          
          <code class="ruby">        puts &quot;daemon/service #{name} deleted\n&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="321">
          <span class="hits">2</span>
          
          <code class="ruby">        Log.debug1(&quot;daemon/service #{name} deleted&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="322">
          <span class="hits">2</span>
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">      sleep 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">    # if got here then something gone wrong and daemon/service wasn't deleted in timely manner</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">    Log.error(&quot;daemon/service #{name} wasn't deleted in timely manner&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">		Log.flush</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">    raise &quot;daemon/service #{name} wasn't deleted in timely manner&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="332">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.exists? name</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="333">
          <span class="hits">23</span>
          
          <code class="ruby">    if name == nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">      raise ArgumentError.new(&quot;service/daemon name argument must be defined&quot;)</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="335">
          <span class="hits">23</span>
          
          <code class="ruby">    elsif OS == :WINDOWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      Service.exists? name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">    else  # OS == :LINUX</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="338">
          <span class="hits">23</span>
          
          <code class="ruby">      pid_files = Daemons::PidFile.find_files(Params['pid_dir'], name)</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="339">
          <span class="hits">23</span>
          
          <code class="ruby">      pid_files != nil &amp;&amp; pid_files.size &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="343">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.running? name</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="344">
          <span class="hits">6</span>
          
          <code class="ruby">    if not exists? name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="345">
          <span class="hits">1</span>
          
          <code class="ruby">      raise ArgumentError.new(&quot;Daemon #{name} doesn't exists&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="346">
          <span class="hits">5</span>
          
          <code class="ruby">    elsif OS == :WINDOWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">      Service.status(name).current_state == 'running'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">    else  # OS == :LINUX</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="349">
          <span class="hits">5</span>
          
          <code class="ruby">      Daemons::Pid.running? name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">  # Returns absolute standard form of the path.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">  # It includes path separators accepted on this OS</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.get_abs_std_path path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">    path = File.expand_path path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">    path = path.tr('/','\\') if OS == :WINDOWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">  # Returns load path as it provided in command line.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="362">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.get_load_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">    load_path = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">    $:.each do |location|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">      load_path &lt;&lt; %Q{-I&quot;#{get_abs_std_path(location)}&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">    load_path.join ' '</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">  # Prepare ARGV so it can be provided as a command line arguments.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">  # Remove bg_command from ARGV to prevent infinite recursion.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="372">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.prepare_argv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">    new_argv = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">    ARGV.each do |arg|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">      # For each argument try splitting to 'name'='value'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">      arg_arr = arg.split '='</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">      # If no '=' is argument, just copy paste.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">      if arg_arr.size == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">        arg = &quot;\&quot;#{arg}\&quot;&quot; if arg =~ / /</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">        new_argv &lt;&lt; arg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">        # If it is a 'name'='value' argument add &quot;&quot; so the value can be passed as argument again.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">      elsif arg_arr.size == 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">        # Skip bg_command flag (remove infinite recursion)!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">        if arg_arr[0] !~ /bg_command/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          arg_arr[1] = &quot;\&quot;#{arg_arr[1]}\&quot;&quot; if arg_arr[1] =~ / /</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">          new_argv &lt;&lt; arg_arr.join('=')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">        Log.warning(&quot;ARGV argument #{arg} wasn't processed&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">        new_argv &lt;&lt; arg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">    ARGV.clear</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">    ARGV.concat new_argv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="397">
          <span class="hits">1</span>
          
          <code class="ruby">  def RunInBackground.run &amp;b</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">    case Params['bg_command']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">      when nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">        yield b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">      when 'start'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">        # To prevent service enter loop cause of background parameter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">        # all options that points to run in background must be disabled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        # (for more information see documentation for RunInBackground::start!)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">        Params['bg_command'] = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">        RunInBackground.prepare_argv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">          RunInBackground.start! Params['service_name']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">          Log.error(&quot;Start service command failed: #{e.message}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">          raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">      when 'delete'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">        if RunInBackground.exists? Params['service_name']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">          RunInBackground.delete Params['service_name']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">          msg = &quot;Can't delete. Service #{Params['service_name']} already deleted&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">          puts msg</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">          Log.warning(msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">			  msg = &quot;Unsupported command #{Params['bg_command']}. Supported commands are: start, delete&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">        puts msg</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">        Log.error(msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">		nil	</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="430">
          <span class="hits">1</span>
          
          <code class="ruby">  private_class_method :start_linux, :start_windows, :wrap_windows, :stop, :get_abs_std_path, \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby">      :get_load_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f1282790afb046fc8bf468fbbf7787daff4d387a">
  <div class="header">
    <h3>lib/validations/index_validations.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>37</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'params'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'log'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'content_data'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'file_indexing/index_agent'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># TODO additional params?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># TODO are params names good enough?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">module Validations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  class IndexValidations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # TODO should it be renamed cause it can validate any indexes, not specially remote, one against another.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # Validates remote index against local file system.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Remote index defined valid when every remote content has at least one valid local instance.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # There are two levels of validation, controlled by instance_check_level system parameter:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # * shallow - quick, tests instance for file existence and attributes.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # * deep - can take more time, in addition to shallow recalculates hash sum.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # For more infoemation see &lt;tt&gt;ContentData&lt;/tt&gt; documentation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # @param [ContentData] remote_index it's contents should be validate against local index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # @param [ContentData] local_index contains local contents and instances used for validation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # @param [Hash] params hash of parameters of validation, can be used to return additional data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    #     Supported key/value combinations:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    #     * key is &lt;tt&gt;:failed&lt;/tt&gt; value is &lt;tt&gt;ContentData&lt;/tt&gt; used to return failed instances</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # @return [Boolean] true when every remote content has at least one valid local instance, false otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # @raise [ArgumentError] when instance_check_level is incorrect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    def IndexValidations.validate_remote_index(remote_index, local_index, params = nil)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="29">
          <span class="hits">4</span>
          
          <code class="ruby">      raise ArgumentError 'remote_index must be defined' if remote_index.nil?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="30">
          <span class="hits">4</span>
          
          <code class="ruby">      raise ArgumentError 'local index must be defined' if local_index.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      # used to answer whether specific param was set</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="33">
          <span class="hits">4</span>
          
          <code class="ruby">      param_exists = Proc.new do |param|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">        !(params.nil? || params[param].nil?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      # used to process method parameters centrally</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      # TODO consider more convenient form of parameters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # TODO code duplication with ContentData::validate</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="40">
          <span class="hits">4</span>
          
          <code class="ruby">      process_params = Proc.new do |checksum, content_mtime, size, instance_mtime, server, path|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="41">
          <span class="hits">2</span>
          
          <code class="ruby">        if param_exists.call(:failed)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="42">
          <span class="hits">2</span>
          
          <code class="ruby">          params[:failed].add_instance(checksum, size, server, path, instance_mtime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      # result variable</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="47">
          <span class="hits">4</span>
          
          <code class="ruby">      is_valid = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      # contains contents absent or without valid instances on local system</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      # and corresponding local instances</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="50">
          <span class="hits">4</span>
          
          <code class="ruby">      failed = ContentData::ContentData.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # contains checksums of contains absent in local</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="52">
          <span class="hits">4</span>
          
          <code class="ruby">      absent_checksums = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      # contains local instances corresponding to given remote index contents</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="55">
          <span class="hits">4</span>
          
          <code class="ruby">      local_index_to_check = ContentData::ContentData.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # check whether remote contents exist locally</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="58">
          <span class="hits">4</span>
          
          <code class="ruby">      remote_index.each_content do |checksum|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="59">
          <span class="hits">10</span>
          
          <code class="ruby">        unless local_index.content_exists checksum</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">          is_valid = false</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">          absent_checksums &lt;&lt; checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      # add instances of contents that should be check, i.e. exist in local</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="66">
          <span class="hits">4</span>
          
          <code class="ruby">      local_index.each_instance do |checksum, size, content_mtime, instance_mtime, server, path|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="67">
          <span class="hits">8</span>
          
          <code class="ruby">        if remote_index.content_exists checksum</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="68">
          <span class="hits">8</span>
          
          <code class="ruby">          local_index_to_check.add_instance checksum, size, server, path, instance_mtime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      # validate against local file system</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="74">
          <span class="hits">4</span>
          
          <code class="ruby">      is_valid = local_index_to_check.validate(:failed =&gt; failed) &amp;&amp; is_valid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      # contains contents that have at least one valid local instance,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      # then also corresponding remote content defined valid</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="78">
          <span class="hits">4</span>
          
          <code class="ruby">      contents_with_succeeded_instances = ContentData.remove_instances failed, local_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      # write summary to log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      # TODO should be controlled from params?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="82">
          <span class="hits">4</span>
          
          <code class="ruby">      absent_checksums.each do |checksum|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="83">
          <span class="hits">2</span>
          
          <code class="ruby">          Log.warning &quot;Content #{checksum} is absent in the local file system&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="85">
          <span class="hits">4</span>
          
          <code class="ruby">      failed.each_content do |checksum|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="86">
          <span class="hits">2</span>
          
          <code class="ruby">        if !contents_with_succeeded_instances.content_exists checksum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          # if checked content have no valid local instances</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          # then content defined invalid</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="89">
          <span class="hits">2</span>
          
          <code class="ruby">          Log.warning &quot;Content #{checksum} is invalid in the local file system&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      # if needed process output params</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="94">
          <span class="hits">4</span>
          
          <code class="ruby">      unless params.nil? || params.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">        remote_index.each_instance do |checksum, size, content_mtime, instance_mtime, server, path|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="96">
          <span class="hits">3</span>
          
          <code class="ruby">          unless contents_with_succeeded_instances.content_exists checksum</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">            process_params.call checksum, content_mtime, size, instance_mtime, server, path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="102">
          <span class="hits">4</span>
          
          <code class="ruby">      is_valid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end  # class IndexValidations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">end  # module Validations</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
